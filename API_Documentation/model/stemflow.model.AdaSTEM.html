
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A package for Adaptive Spatio-Temporal Model (AdaSTEM) in python.">
      
      
      
        <link rel="canonical" href="https://chenyangkag.github.io/stemflow/API_Documentation/model/stemflow.model.AdaSTEM.html">
      
      
        <link rel="prev" href="../../Tips/Tips_for_different_tasks.html">
      
      
        <link rel="next" href="stemflow.model.SphereAdaSTEM.html">
      
      
      <link rel="icon" href="../../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>AdaSTEM - stemflow</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-LT28RB77G3"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-LT28RB77G3",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-LT28RB77G3",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="AdaSTEM - stemflow" >
      
        <meta  property="og:description"  content="A package for Adaptive Spatio-Temporal Model (AdaSTEM) in python." >
      
        <meta  property="og:image"  content="https://chenyangkag.github.io/stemflow/assets/images/social/API_Documentation/model/stemflow.model.AdaSTEM.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://chenyangkag.github.io/stemflow/API_Documentation/model/stemflow.model.AdaSTEM.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="AdaSTEM - stemflow" >
      
        <meta  name="twitter:description"  content="A package for Adaptive Spatio-Temporal Model (AdaSTEM) in python." >
      
        <meta  name="twitter:image"  content="https://chenyangkag.github.io/stemflow/assets/images/social/API_Documentation/model/stemflow.model.AdaSTEM.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="light-green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#stemflowmodeladastem" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="stemflow" class="md-header__button md-logo" aria-label="stemflow" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            stemflow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              AdaSTEM
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="light-green"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="light-green"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/chenyangkang/stemflow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    chenyangkang/stemflow
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="stemflow" class="md-nav__button md-logo" aria-label="stemflow" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    stemflow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/chenyangkang/stemflow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    chenyangkang/stemflow
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../A_brief_introduction/A_brief_introduction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A Brief Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/01.AdaSTEM_demo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A demo of AdaSTEM model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/04.SphereAdaSTEM_demo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SphereAdaSTEM model: spherical indexing and modeling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/02.AdaSTEM_learning_curve_analysis.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Learning curve analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/03.Binding_with_Maxent.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using Maxent as base models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/05.Hurdle_in_ada_or_ada_in_hurdle.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hurdle model in AdaSTEM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/06.Base_model_choices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base model choices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/07.Optimizing_stixel_size.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Optimizing stixel size
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/08.Lazy_loading.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lazy loading ensembles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Examples/09.Database_query.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using database query to reduce memory load
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tips
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tips
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tips/Tips_for_spatiotemporal_indexing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tips for spatiotemporal indexing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tips/Tips_for_data_types.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tips for data types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tips/Tips_for_different_tasks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tips for different tasks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" checked>
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    stemflow.model
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            stemflow.model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    AdaSTEM
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="stemflow.model.AdaSTEM.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    AdaSTEM
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM" class="md-nav__link">
    <span class="md-ellipsis">
      AdaSTEM
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM" class="md-nav__link">
    <span class="md-ellipsis">
      AdaSTEM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdaSTEM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.SAC_ensemble_predict" class="md-nav__link">
    <span class="md-ellipsis">
      SAC_ensemble_predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.SAC_ensemble_training" class="md-nav__link">
    <span class="md-ellipsis">
      SAC_ensemble_training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.SAC_predict" class="md-nav__link">
    <span class="md-ellipsis">
      SAC_predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.SAC_training" class="md-nav__link">
    <span class="md-ellipsis">
      SAC_training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.assign_feature_importances_by_points" class="md-nav__link">
    <span class="md-ellipsis">
      assign_feature_importances_by_points
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.calculate_feature_importances" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_feature_importances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.eval_STEM_res" class="md-nav__link">
    <span class="md-ellipsis">
      eval_STEM_res
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.predict_proba" class="md-nav__link">
    <span class="md-ellipsis">
      predict_proba
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.score" class="md-nav__link">
    <span class="md-ellipsis">
      score
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.stixel_fitting" class="md-nav__link">
    <span class="md-ellipsis">
      stixel_fitting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.stixel_predict" class="md-nav__link">
    <span class="md-ellipsis">
      stixel_predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.store_x_names" class="md-nav__link">
    <span class="md-ellipsis">
      store_x_names
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEMClassifier" class="md-nav__link">
    <span class="md-ellipsis">
      AdaSTEMClassifier
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdaSTEMClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEMClassifier.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEMRegressor" class="md-nav__link">
    <span class="md-ellipsis">
      AdaSTEMRegressor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdaSTEMRegressor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEMRegressor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="stemflow.model.SphereAdaSTEM.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SphereAdaSTEM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="stemflow.model.STEM.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    STEM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="stemflow.model.static_func_AdaSTEM.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    static_func_AdaSTEM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="stemflow.model.Hurdle.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hurdle
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="stemflow.model.dummy_model.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dummy_model
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    stemflow.gridding
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            stemflow.gridding
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gridding/stemflow.gridding.Q_blocks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Q_blocks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gridding/stemflow.gridding.QTree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    QTree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gridding/stemflow.gridding.Sphere_QTree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sphere_QTree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gridding/stemflow.gridding.QuadGrid.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    QuadGrid
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    stemflow.lazyloading
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            stemflow.lazyloading
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gridding/stemflow.lazyloading.lazyloading.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    lazyloading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gridding/stemflow.lazyloading.open_db_connection.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    open_db_connection
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    stemflow.utils
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            stemflow.utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_1" >
        
          
          <label class="md-nav__link" for="__nav_5_4_1" id="__nav_5_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    jitterrotation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_1">
            <span class="md-nav__icon md-icon"></span>
            jitterrotation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/jitterrotation/stemflow.utils.jitterrotation.jitterrotator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    jitterrotator
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_2" >
        
          
          <label class="md-nav__link" for="__nav_5_4_2" id="__nav_5_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    sphere
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_2">
            <span class="md-nav__icon md-icon"></span>
            sphere
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/sphere/stemflow.utils.sphere.coordinate_transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    coordinate_transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/sphere/stemflow.utils.sphere.discriminant_formula.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    discriminant_formula
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/sphere/stemflow.utils.sphere.distance.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    distance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/sphere/stemflow.utils.sphere.Icosahedron.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Icosahedron
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/stemflow.utils.quadtree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quadtree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/stemflow.utils.sphere_quadtree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    sphere_quadtree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/stemflow.utils.plot_gif.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    plot_gif
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/stemflow.utils.generate_random.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    generate_random
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/stemflow.utils.validation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/stemflow.utils.wrapper.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    wrapper
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/stemflow.utils.lazyloading.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    lazyloading
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stemflow.model_selection.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    stemflow.model_selection
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Fun Visualization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Fun Visualization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Fun_Visualization/Global_Bird_Shannon_H_Index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Global Bird Diversity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Fun_Visualization/Ruby-crowned_Kinglet_2020.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ruby-crowned_Kinglet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Fun_Visualization/Global_NDVI.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Global NDVI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Fun_Visualization/Global_Mean_Temperature_2020.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Global Mean Temperature
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CONTRIBUTING.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CODE_OF_CONDUCT.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code of conduct
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM" class="md-nav__link">
    <span class="md-ellipsis">
      AdaSTEM
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM" class="md-nav__link">
    <span class="md-ellipsis">
      AdaSTEM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdaSTEM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.SAC_ensemble_predict" class="md-nav__link">
    <span class="md-ellipsis">
      SAC_ensemble_predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.SAC_ensemble_training" class="md-nav__link">
    <span class="md-ellipsis">
      SAC_ensemble_training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.SAC_predict" class="md-nav__link">
    <span class="md-ellipsis">
      SAC_predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.SAC_training" class="md-nav__link">
    <span class="md-ellipsis">
      SAC_training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.assign_feature_importances_by_points" class="md-nav__link">
    <span class="md-ellipsis">
      assign_feature_importances_by_points
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.calculate_feature_importances" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_feature_importances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.eval_STEM_res" class="md-nav__link">
    <span class="md-ellipsis">
      eval_STEM_res
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.predict_proba" class="md-nav__link">
    <span class="md-ellipsis">
      predict_proba
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.score" class="md-nav__link">
    <span class="md-ellipsis">
      score
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.stixel_fitting" class="md-nav__link">
    <span class="md-ellipsis">
      stixel_fitting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.stixel_predict" class="md-nav__link">
    <span class="md-ellipsis">
      stixel_predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEM.store_x_names" class="md-nav__link">
    <span class="md-ellipsis">
      store_x_names
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEMClassifier" class="md-nav__link">
    <span class="md-ellipsis">
      AdaSTEMClassifier
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdaSTEMClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEMClassifier.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEMRegressor" class="md-nav__link">
    <span class="md-ellipsis">
      AdaSTEMRegressor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdaSTEMRegressor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stemflow.model.AdaSTEM.AdaSTEMRegressor.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="stemflowmodeladastem">stemflow.model.AdaSTEM</h1>
<hr />


<div class="doc doc-object doc-module">



<a id="stemflow.model.AdaSTEM"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="stemflow.model.AdaSTEM.AdaSTEM" class="doc doc-heading">
            <code>AdaSTEM</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="sklearn.base.BaseEstimator">BaseEstimator</span></code></p>


        <p>An AdaSTEM model class inherited by AdaSTEMClassifier and AdaSTEMRegressor</p>








              <details class="quote">
                <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-86">  86</a></span>
<span class="normal"><a href="#__codelineno-0-87">  87</a></span>
<span class="normal"><a href="#__codelineno-0-88">  88</a></span>
<span class="normal"><a href="#__codelineno-0-89">  89</a></span>
<span class="normal"><a href="#__codelineno-0-90">  90</a></span>
<span class="normal"><a href="#__codelineno-0-91">  91</a></span>
<span class="normal"><a href="#__codelineno-0-92">  92</a></span>
<span class="normal"><a href="#__codelineno-0-93">  93</a></span>
<span class="normal"><a href="#__codelineno-0-94">  94</a></span>
<span class="normal"><a href="#__codelineno-0-95">  95</a></span>
<span class="normal"><a href="#__codelineno-0-96">  96</a></span>
<span class="normal"><a href="#__codelineno-0-97">  97</a></span>
<span class="normal"><a href="#__codelineno-0-98">  98</a></span>
<span class="normal"><a href="#__codelineno-0-99">  99</a></span>
<span class="normal"><a href="#__codelineno-0-100"> 100</a></span>
<span class="normal"><a href="#__codelineno-0-101"> 101</a></span>
<span class="normal"><a href="#__codelineno-0-102"> 102</a></span>
<span class="normal"><a href="#__codelineno-0-103"> 103</a></span>
<span class="normal"><a href="#__codelineno-0-104"> 104</a></span>
<span class="normal"><a href="#__codelineno-0-105"> 105</a></span>
<span class="normal"><a href="#__codelineno-0-106"> 106</a></span>
<span class="normal"><a href="#__codelineno-0-107"> 107</a></span>
<span class="normal"><a href="#__codelineno-0-108"> 108</a></span>
<span class="normal"><a href="#__codelineno-0-109"> 109</a></span>
<span class="normal"><a href="#__codelineno-0-110"> 110</a></span>
<span class="normal"><a href="#__codelineno-0-111"> 111</a></span>
<span class="normal"><a href="#__codelineno-0-112"> 112</a></span>
<span class="normal"><a href="#__codelineno-0-113"> 113</a></span>
<span class="normal"><a href="#__codelineno-0-114"> 114</a></span>
<span class="normal"><a href="#__codelineno-0-115"> 115</a></span>
<span class="normal"><a href="#__codelineno-0-116"> 116</a></span>
<span class="normal"><a href="#__codelineno-0-117"> 117</a></span>
<span class="normal"><a href="#__codelineno-0-118"> 118</a></span>
<span class="normal"><a href="#__codelineno-0-119"> 119</a></span>
<span class="normal"><a href="#__codelineno-0-120"> 120</a></span>
<span class="normal"><a href="#__codelineno-0-121"> 121</a></span>
<span class="normal"><a href="#__codelineno-0-122"> 122</a></span>
<span class="normal"><a href="#__codelineno-0-123"> 123</a></span>
<span class="normal"><a href="#__codelineno-0-124"> 124</a></span>
<span class="normal"><a href="#__codelineno-0-125"> 125</a></span>
<span class="normal"><a href="#__codelineno-0-126"> 126</a></span>
<span class="normal"><a href="#__codelineno-0-127"> 127</a></span>
<span class="normal"><a href="#__codelineno-0-128"> 128</a></span>
<span class="normal"><a href="#__codelineno-0-129"> 129</a></span>
<span class="normal"><a href="#__codelineno-0-130"> 130</a></span>
<span class="normal"><a href="#__codelineno-0-131"> 131</a></span>
<span class="normal"><a href="#__codelineno-0-132"> 132</a></span>
<span class="normal"><a href="#__codelineno-0-133"> 133</a></span>
<span class="normal"><a href="#__codelineno-0-134"> 134</a></span>
<span class="normal"><a href="#__codelineno-0-135"> 135</a></span>
<span class="normal"><a href="#__codelineno-0-136"> 136</a></span>
<span class="normal"><a href="#__codelineno-0-137"> 137</a></span>
<span class="normal"><a href="#__codelineno-0-138"> 138</a></span>
<span class="normal"><a href="#__codelineno-0-139"> 139</a></span>
<span class="normal"><a href="#__codelineno-0-140"> 140</a></span>
<span class="normal"><a href="#__codelineno-0-141"> 141</a></span>
<span class="normal"><a href="#__codelineno-0-142"> 142</a></span>
<span class="normal"><a href="#__codelineno-0-143"> 143</a></span>
<span class="normal"><a href="#__codelineno-0-144"> 144</a></span>
<span class="normal"><a href="#__codelineno-0-145"> 145</a></span>
<span class="normal"><a href="#__codelineno-0-146"> 146</a></span>
<span class="normal"><a href="#__codelineno-0-147"> 147</a></span>
<span class="normal"><a href="#__codelineno-0-148"> 148</a></span>
<span class="normal"><a href="#__codelineno-0-149"> 149</a></span>
<span class="normal"><a href="#__codelineno-0-150"> 150</a></span>
<span class="normal"><a href="#__codelineno-0-151"> 151</a></span>
<span class="normal"><a href="#__codelineno-0-152"> 152</a></span>
<span class="normal"><a href="#__codelineno-0-153"> 153</a></span>
<span class="normal"><a href="#__codelineno-0-154"> 154</a></span>
<span class="normal"><a href="#__codelineno-0-155"> 155</a></span>
<span class="normal"><a href="#__codelineno-0-156"> 156</a></span>
<span class="normal"><a href="#__codelineno-0-157"> 157</a></span>
<span class="normal"><a href="#__codelineno-0-158"> 158</a></span>
<span class="normal"><a href="#__codelineno-0-159"> 159</a></span>
<span class="normal"><a href="#__codelineno-0-160"> 160</a></span>
<span class="normal"><a href="#__codelineno-0-161"> 161</a></span>
<span class="normal"><a href="#__codelineno-0-162"> 162</a></span>
<span class="normal"><a href="#__codelineno-0-163"> 163</a></span>
<span class="normal"><a href="#__codelineno-0-164"> 164</a></span>
<span class="normal"><a href="#__codelineno-0-165"> 165</a></span>
<span class="normal"><a href="#__codelineno-0-166"> 166</a></span>
<span class="normal"><a href="#__codelineno-0-167"> 167</a></span>
<span class="normal"><a href="#__codelineno-0-168"> 168</a></span>
<span class="normal"><a href="#__codelineno-0-169"> 169</a></span>
<span class="normal"><a href="#__codelineno-0-170"> 170</a></span>
<span class="normal"><a href="#__codelineno-0-171"> 171</a></span>
<span class="normal"><a href="#__codelineno-0-172"> 172</a></span>
<span class="normal"><a href="#__codelineno-0-173"> 173</a></span>
<span class="normal"><a href="#__codelineno-0-174"> 174</a></span>
<span class="normal"><a href="#__codelineno-0-175"> 175</a></span>
<span class="normal"><a href="#__codelineno-0-176"> 176</a></span>
<span class="normal"><a href="#__codelineno-0-177"> 177</a></span>
<span class="normal"><a href="#__codelineno-0-178"> 178</a></span>
<span class="normal"><a href="#__codelineno-0-179"> 179</a></span>
<span class="normal"><a href="#__codelineno-0-180"> 180</a></span>
<span class="normal"><a href="#__codelineno-0-181"> 181</a></span>
<span class="normal"><a href="#__codelineno-0-182"> 182</a></span>
<span class="normal"><a href="#__codelineno-0-183"> 183</a></span>
<span class="normal"><a href="#__codelineno-0-184"> 184</a></span>
<span class="normal"><a href="#__codelineno-0-185"> 185</a></span>
<span class="normal"><a href="#__codelineno-0-186"> 186</a></span>
<span class="normal"><a href="#__codelineno-0-187"> 187</a></span>
<span class="normal"><a href="#__codelineno-0-188"> 188</a></span>
<span class="normal"><a href="#__codelineno-0-189"> 189</a></span>
<span class="normal"><a href="#__codelineno-0-190"> 190</a></span>
<span class="normal"><a href="#__codelineno-0-191"> 191</a></span>
<span class="normal"><a href="#__codelineno-0-192"> 192</a></span>
<span class="normal"><a href="#__codelineno-0-193"> 193</a></span>
<span class="normal"><a href="#__codelineno-0-194"> 194</a></span>
<span class="normal"><a href="#__codelineno-0-195"> 195</a></span>
<span class="normal"><a href="#__codelineno-0-196"> 196</a></span>
<span class="normal"><a href="#__codelineno-0-197"> 197</a></span>
<span class="normal"><a href="#__codelineno-0-198"> 198</a></span>
<span class="normal"><a href="#__codelineno-0-199"> 199</a></span>
<span class="normal"><a href="#__codelineno-0-200"> 200</a></span>
<span class="normal"><a href="#__codelineno-0-201"> 201</a></span>
<span class="normal"><a href="#__codelineno-0-202"> 202</a></span>
<span class="normal"><a href="#__codelineno-0-203"> 203</a></span>
<span class="normal"><a href="#__codelineno-0-204"> 204</a></span>
<span class="normal"><a href="#__codelineno-0-205"> 205</a></span>
<span class="normal"><a href="#__codelineno-0-206"> 206</a></span>
<span class="normal"><a href="#__codelineno-0-207"> 207</a></span>
<span class="normal"><a href="#__codelineno-0-208"> 208</a></span>
<span class="normal"><a href="#__codelineno-0-209"> 209</a></span>
<span class="normal"><a href="#__codelineno-0-210"> 210</a></span>
<span class="normal"><a href="#__codelineno-0-211"> 211</a></span>
<span class="normal"><a href="#__codelineno-0-212"> 212</a></span>
<span class="normal"><a href="#__codelineno-0-213"> 213</a></span>
<span class="normal"><a href="#__codelineno-0-214"> 214</a></span>
<span class="normal"><a href="#__codelineno-0-215"> 215</a></span>
<span class="normal"><a href="#__codelineno-0-216"> 216</a></span>
<span class="normal"><a href="#__codelineno-0-217"> 217</a></span>
<span class="normal"><a href="#__codelineno-0-218"> 218</a></span>
<span class="normal"><a href="#__codelineno-0-219"> 219</a></span>
<span class="normal"><a href="#__codelineno-0-220"> 220</a></span>
<span class="normal"><a href="#__codelineno-0-221"> 221</a></span>
<span class="normal"><a href="#__codelineno-0-222"> 222</a></span>
<span class="normal"><a href="#__codelineno-0-223"> 223</a></span>
<span class="normal"><a href="#__codelineno-0-224"> 224</a></span>
<span class="normal"><a href="#__codelineno-0-225"> 225</a></span>
<span class="normal"><a href="#__codelineno-0-226"> 226</a></span>
<span class="normal"><a href="#__codelineno-0-227"> 227</a></span>
<span class="normal"><a href="#__codelineno-0-228"> 228</a></span>
<span class="normal"><a href="#__codelineno-0-229"> 229</a></span>
<span class="normal"><a href="#__codelineno-0-230"> 230</a></span>
<span class="normal"><a href="#__codelineno-0-231"> 231</a></span>
<span class="normal"><a href="#__codelineno-0-232"> 232</a></span>
<span class="normal"><a href="#__codelineno-0-233"> 233</a></span>
<span class="normal"><a href="#__codelineno-0-234"> 234</a></span>
<span class="normal"><a href="#__codelineno-0-235"> 235</a></span>
<span class="normal"><a href="#__codelineno-0-236"> 236</a></span>
<span class="normal"><a href="#__codelineno-0-237"> 237</a></span>
<span class="normal"><a href="#__codelineno-0-238"> 238</a></span>
<span class="normal"><a href="#__codelineno-0-239"> 239</a></span>
<span class="normal"><a href="#__codelineno-0-240"> 240</a></span>
<span class="normal"><a href="#__codelineno-0-241"> 241</a></span>
<span class="normal"><a href="#__codelineno-0-242"> 242</a></span>
<span class="normal"><a href="#__codelineno-0-243"> 243</a></span>
<span class="normal"><a href="#__codelineno-0-244"> 244</a></span>
<span class="normal"><a href="#__codelineno-0-245"> 245</a></span>
<span class="normal"><a href="#__codelineno-0-246"> 246</a></span>
<span class="normal"><a href="#__codelineno-0-247"> 247</a></span>
<span class="normal"><a href="#__codelineno-0-248"> 248</a></span>
<span class="normal"><a href="#__codelineno-0-249"> 249</a></span>
<span class="normal"><a href="#__codelineno-0-250"> 250</a></span>
<span class="normal"><a href="#__codelineno-0-251"> 251</a></span>
<span class="normal"><a href="#__codelineno-0-252"> 252</a></span>
<span class="normal"><a href="#__codelineno-0-253"> 253</a></span>
<span class="normal"><a href="#__codelineno-0-254"> 254</a></span>
<span class="normal"><a href="#__codelineno-0-255"> 255</a></span>
<span class="normal"><a href="#__codelineno-0-256"> 256</a></span>
<span class="normal"><a href="#__codelineno-0-257"> 257</a></span>
<span class="normal"><a href="#__codelineno-0-258"> 258</a></span>
<span class="normal"><a href="#__codelineno-0-259"> 259</a></span>
<span class="normal"><a href="#__codelineno-0-260"> 260</a></span>
<span class="normal"><a href="#__codelineno-0-261"> 261</a></span>
<span class="normal"><a href="#__codelineno-0-262"> 262</a></span>
<span class="normal"><a href="#__codelineno-0-263"> 263</a></span>
<span class="normal"><a href="#__codelineno-0-264"> 264</a></span>
<span class="normal"><a href="#__codelineno-0-265"> 265</a></span>
<span class="normal"><a href="#__codelineno-0-266"> 266</a></span>
<span class="normal"><a href="#__codelineno-0-267"> 267</a></span>
<span class="normal"><a href="#__codelineno-0-268"> 268</a></span>
<span class="normal"><a href="#__codelineno-0-269"> 269</a></span>
<span class="normal"><a href="#__codelineno-0-270"> 270</a></span>
<span class="normal"><a href="#__codelineno-0-271"> 271</a></span>
<span class="normal"><a href="#__codelineno-0-272"> 272</a></span>
<span class="normal"><a href="#__codelineno-0-273"> 273</a></span>
<span class="normal"><a href="#__codelineno-0-274"> 274</a></span>
<span class="normal"><a href="#__codelineno-0-275"> 275</a></span>
<span class="normal"><a href="#__codelineno-0-276"> 276</a></span>
<span class="normal"><a href="#__codelineno-0-277"> 277</a></span>
<span class="normal"><a href="#__codelineno-0-278"> 278</a></span>
<span class="normal"><a href="#__codelineno-0-279"> 279</a></span>
<span class="normal"><a href="#__codelineno-0-280"> 280</a></span>
<span class="normal"><a href="#__codelineno-0-281"> 281</a></span>
<span class="normal"><a href="#__codelineno-0-282"> 282</a></span>
<span class="normal"><a href="#__codelineno-0-283"> 283</a></span>
<span class="normal"><a href="#__codelineno-0-284"> 284</a></span>
<span class="normal"><a href="#__codelineno-0-285"> 285</a></span>
<span class="normal"><a href="#__codelineno-0-286"> 286</a></span>
<span class="normal"><a href="#__codelineno-0-287"> 287</a></span>
<span class="normal"><a href="#__codelineno-0-288"> 288</a></span>
<span class="normal"><a href="#__codelineno-0-289"> 289</a></span>
<span class="normal"><a href="#__codelineno-0-290"> 290</a></span>
<span class="normal"><a href="#__codelineno-0-291"> 291</a></span>
<span class="normal"><a href="#__codelineno-0-292"> 292</a></span>
<span class="normal"><a href="#__codelineno-0-293"> 293</a></span>
<span class="normal"><a href="#__codelineno-0-294"> 294</a></span>
<span class="normal"><a href="#__codelineno-0-295"> 295</a></span>
<span class="normal"><a href="#__codelineno-0-296"> 296</a></span>
<span class="normal"><a href="#__codelineno-0-297"> 297</a></span>
<span class="normal"><a href="#__codelineno-0-298"> 298</a></span>
<span class="normal"><a href="#__codelineno-0-299"> 299</a></span>
<span class="normal"><a href="#__codelineno-0-300"> 300</a></span>
<span class="normal"><a href="#__codelineno-0-301"> 301</a></span>
<span class="normal"><a href="#__codelineno-0-302"> 302</a></span>
<span class="normal"><a href="#__codelineno-0-303"> 303</a></span>
<span class="normal"><a href="#__codelineno-0-304"> 304</a></span>
<span class="normal"><a href="#__codelineno-0-305"> 305</a></span>
<span class="normal"><a href="#__codelineno-0-306"> 306</a></span>
<span class="normal"><a href="#__codelineno-0-307"> 307</a></span>
<span class="normal"><a href="#__codelineno-0-308"> 308</a></span>
<span class="normal"><a href="#__codelineno-0-309"> 309</a></span>
<span class="normal"><a href="#__codelineno-0-310"> 310</a></span>
<span class="normal"><a href="#__codelineno-0-311"> 311</a></span>
<span class="normal"><a href="#__codelineno-0-312"> 312</a></span>
<span class="normal"><a href="#__codelineno-0-313"> 313</a></span>
<span class="normal"><a href="#__codelineno-0-314"> 314</a></span>
<span class="normal"><a href="#__codelineno-0-315"> 315</a></span>
<span class="normal"><a href="#__codelineno-0-316"> 316</a></span>
<span class="normal"><a href="#__codelineno-0-317"> 317</a></span>
<span class="normal"><a href="#__codelineno-0-318"> 318</a></span>
<span class="normal"><a href="#__codelineno-0-319"> 319</a></span>
<span class="normal"><a href="#__codelineno-0-320"> 320</a></span>
<span class="normal"><a href="#__codelineno-0-321"> 321</a></span>
<span class="normal"><a href="#__codelineno-0-322"> 322</a></span>
<span class="normal"><a href="#__codelineno-0-323"> 323</a></span>
<span class="normal"><a href="#__codelineno-0-324"> 324</a></span>
<span class="normal"><a href="#__codelineno-0-325"> 325</a></span>
<span class="normal"><a href="#__codelineno-0-326"> 326</a></span>
<span class="normal"><a href="#__codelineno-0-327"> 327</a></span>
<span class="normal"><a href="#__codelineno-0-328"> 328</a></span>
<span class="normal"><a href="#__codelineno-0-329"> 329</a></span>
<span class="normal"><a href="#__codelineno-0-330"> 330</a></span>
<span class="normal"><a href="#__codelineno-0-331"> 331</a></span>
<span class="normal"><a href="#__codelineno-0-332"> 332</a></span>
<span class="normal"><a href="#__codelineno-0-333"> 333</a></span>
<span class="normal"><a href="#__codelineno-0-334"> 334</a></span>
<span class="normal"><a href="#__codelineno-0-335"> 335</a></span>
<span class="normal"><a href="#__codelineno-0-336"> 336</a></span>
<span class="normal"><a href="#__codelineno-0-337"> 337</a></span>
<span class="normal"><a href="#__codelineno-0-338"> 338</a></span>
<span class="normal"><a href="#__codelineno-0-339"> 339</a></span>
<span class="normal"><a href="#__codelineno-0-340"> 340</a></span>
<span class="normal"><a href="#__codelineno-0-341"> 341</a></span>
<span class="normal"><a href="#__codelineno-0-342"> 342</a></span>
<span class="normal"><a href="#__codelineno-0-343"> 343</a></span>
<span class="normal"><a href="#__codelineno-0-344"> 344</a></span>
<span class="normal"><a href="#__codelineno-0-345"> 345</a></span>
<span class="normal"><a href="#__codelineno-0-346"> 346</a></span>
<span class="normal"><a href="#__codelineno-0-347"> 347</a></span>
<span class="normal"><a href="#__codelineno-0-348"> 348</a></span>
<span class="normal"><a href="#__codelineno-0-349"> 349</a></span>
<span class="normal"><a href="#__codelineno-0-350"> 350</a></span>
<span class="normal"><a href="#__codelineno-0-351"> 351</a></span>
<span class="normal"><a href="#__codelineno-0-352"> 352</a></span>
<span class="normal"><a href="#__codelineno-0-353"> 353</a></span>
<span class="normal"><a href="#__codelineno-0-354"> 354</a></span>
<span class="normal"><a href="#__codelineno-0-355"> 355</a></span>
<span class="normal"><a href="#__codelineno-0-356"> 356</a></span>
<span class="normal"><a href="#__codelineno-0-357"> 357</a></span>
<span class="normal"><a href="#__codelineno-0-358"> 358</a></span>
<span class="normal"><a href="#__codelineno-0-359"> 359</a></span>
<span class="normal"><a href="#__codelineno-0-360"> 360</a></span>
<span class="normal"><a href="#__codelineno-0-361"> 361</a></span>
<span class="normal"><a href="#__codelineno-0-362"> 362</a></span>
<span class="normal"><a href="#__codelineno-0-363"> 363</a></span>
<span class="normal"><a href="#__codelineno-0-364"> 364</a></span>
<span class="normal"><a href="#__codelineno-0-365"> 365</a></span>
<span class="normal"><a href="#__codelineno-0-366"> 366</a></span>
<span class="normal"><a href="#__codelineno-0-367"> 367</a></span>
<span class="normal"><a href="#__codelineno-0-368"> 368</a></span>
<span class="normal"><a href="#__codelineno-0-369"> 369</a></span>
<span class="normal"><a href="#__codelineno-0-370"> 370</a></span>
<span class="normal"><a href="#__codelineno-0-371"> 371</a></span>
<span class="normal"><a href="#__codelineno-0-372"> 372</a></span>
<span class="normal"><a href="#__codelineno-0-373"> 373</a></span>
<span class="normal"><a href="#__codelineno-0-374"> 374</a></span>
<span class="normal"><a href="#__codelineno-0-375"> 375</a></span>
<span class="normal"><a href="#__codelineno-0-376"> 376</a></span>
<span class="normal"><a href="#__codelineno-0-377"> 377</a></span>
<span class="normal"><a href="#__codelineno-0-378"> 378</a></span>
<span class="normal"><a href="#__codelineno-0-379"> 379</a></span>
<span class="normal"><a href="#__codelineno-0-380"> 380</a></span>
<span class="normal"><a href="#__codelineno-0-381"> 381</a></span>
<span class="normal"><a href="#__codelineno-0-382"> 382</a></span>
<span class="normal"><a href="#__codelineno-0-383"> 383</a></span>
<span class="normal"><a href="#__codelineno-0-384"> 384</a></span>
<span class="normal"><a href="#__codelineno-0-385"> 385</a></span>
<span class="normal"><a href="#__codelineno-0-386"> 386</a></span>
<span class="normal"><a href="#__codelineno-0-387"> 387</a></span>
<span class="normal"><a href="#__codelineno-0-388"> 388</a></span>
<span class="normal"><a href="#__codelineno-0-389"> 389</a></span>
<span class="normal"><a href="#__codelineno-0-390"> 390</a></span>
<span class="normal"><a href="#__codelineno-0-391"> 391</a></span>
<span class="normal"><a href="#__codelineno-0-392"> 392</a></span>
<span class="normal"><a href="#__codelineno-0-393"> 393</a></span>
<span class="normal"><a href="#__codelineno-0-394"> 394</a></span>
<span class="normal"><a href="#__codelineno-0-395"> 395</a></span>
<span class="normal"><a href="#__codelineno-0-396"> 396</a></span>
<span class="normal"><a href="#__codelineno-0-397"> 397</a></span>
<span class="normal"><a href="#__codelineno-0-398"> 398</a></span>
<span class="normal"><a href="#__codelineno-0-399"> 399</a></span>
<span class="normal"><a href="#__codelineno-0-400"> 400</a></span>
<span class="normal"><a href="#__codelineno-0-401"> 401</a></span>
<span class="normal"><a href="#__codelineno-0-402"> 402</a></span>
<span class="normal"><a href="#__codelineno-0-403"> 403</a></span>
<span class="normal"><a href="#__codelineno-0-404"> 404</a></span>
<span class="normal"><a href="#__codelineno-0-405"> 405</a></span>
<span class="normal"><a href="#__codelineno-0-406"> 406</a></span>
<span class="normal"><a href="#__codelineno-0-407"> 407</a></span>
<span class="normal"><a href="#__codelineno-0-408"> 408</a></span>
<span class="normal"><a href="#__codelineno-0-409"> 409</a></span>
<span class="normal"><a href="#__codelineno-0-410"> 410</a></span>
<span class="normal"><a href="#__codelineno-0-411"> 411</a></span>
<span class="normal"><a href="#__codelineno-0-412"> 412</a></span>
<span class="normal"><a href="#__codelineno-0-413"> 413</a></span>
<span class="normal"><a href="#__codelineno-0-414"> 414</a></span>
<span class="normal"><a href="#__codelineno-0-415"> 415</a></span>
<span class="normal"><a href="#__codelineno-0-416"> 416</a></span>
<span class="normal"><a href="#__codelineno-0-417"> 417</a></span>
<span class="normal"><a href="#__codelineno-0-418"> 418</a></span>
<span class="normal"><a href="#__codelineno-0-419"> 419</a></span>
<span class="normal"><a href="#__codelineno-0-420"> 420</a></span>
<span class="normal"><a href="#__codelineno-0-421"> 421</a></span>
<span class="normal"><a href="#__codelineno-0-422"> 422</a></span>
<span class="normal"><a href="#__codelineno-0-423"> 423</a></span>
<span class="normal"><a href="#__codelineno-0-424"> 424</a></span>
<span class="normal"><a href="#__codelineno-0-425"> 425</a></span>
<span class="normal"><a href="#__codelineno-0-426"> 426</a></span>
<span class="normal"><a href="#__codelineno-0-427"> 427</a></span>
<span class="normal"><a href="#__codelineno-0-428"> 428</a></span>
<span class="normal"><a href="#__codelineno-0-429"> 429</a></span>
<span class="normal"><a href="#__codelineno-0-430"> 430</a></span>
<span class="normal"><a href="#__codelineno-0-431"> 431</a></span>
<span class="normal"><a href="#__codelineno-0-432"> 432</a></span>
<span class="normal"><a href="#__codelineno-0-433"> 433</a></span>
<span class="normal"><a href="#__codelineno-0-434"> 434</a></span>
<span class="normal"><a href="#__codelineno-0-435"> 435</a></span>
<span class="normal"><a href="#__codelineno-0-436"> 436</a></span>
<span class="normal"><a href="#__codelineno-0-437"> 437</a></span>
<span class="normal"><a href="#__codelineno-0-438"> 438</a></span>
<span class="normal"><a href="#__codelineno-0-439"> 439</a></span>
<span class="normal"><a href="#__codelineno-0-440"> 440</a></span>
<span class="normal"><a href="#__codelineno-0-441"> 441</a></span>
<span class="normal"><a href="#__codelineno-0-442"> 442</a></span>
<span class="normal"><a href="#__codelineno-0-443"> 443</a></span>
<span class="normal"><a href="#__codelineno-0-444"> 444</a></span>
<span class="normal"><a href="#__codelineno-0-445"> 445</a></span>
<span class="normal"><a href="#__codelineno-0-446"> 446</a></span>
<span class="normal"><a href="#__codelineno-0-447"> 447</a></span>
<span class="normal"><a href="#__codelineno-0-448"> 448</a></span>
<span class="normal"><a href="#__codelineno-0-449"> 449</a></span>
<span class="normal"><a href="#__codelineno-0-450"> 450</a></span>
<span class="normal"><a href="#__codelineno-0-451"> 451</a></span>
<span class="normal"><a href="#__codelineno-0-452"> 452</a></span>
<span class="normal"><a href="#__codelineno-0-453"> 453</a></span>
<span class="normal"><a href="#__codelineno-0-454"> 454</a></span>
<span class="normal"><a href="#__codelineno-0-455"> 455</a></span>
<span class="normal"><a href="#__codelineno-0-456"> 456</a></span>
<span class="normal"><a href="#__codelineno-0-457"> 457</a></span>
<span class="normal"><a href="#__codelineno-0-458"> 458</a></span>
<span class="normal"><a href="#__codelineno-0-459"> 459</a></span>
<span class="normal"><a href="#__codelineno-0-460"> 460</a></span>
<span class="normal"><a href="#__codelineno-0-461"> 461</a></span>
<span class="normal"><a href="#__codelineno-0-462"> 462</a></span>
<span class="normal"><a href="#__codelineno-0-463"> 463</a></span>
<span class="normal"><a href="#__codelineno-0-464"> 464</a></span>
<span class="normal"><a href="#__codelineno-0-465"> 465</a></span>
<span class="normal"><a href="#__codelineno-0-466"> 466</a></span>
<span class="normal"><a href="#__codelineno-0-467"> 467</a></span>
<span class="normal"><a href="#__codelineno-0-468"> 468</a></span>
<span class="normal"><a href="#__codelineno-0-469"> 469</a></span>
<span class="normal"><a href="#__codelineno-0-470"> 470</a></span>
<span class="normal"><a href="#__codelineno-0-471"> 471</a></span>
<span class="normal"><a href="#__codelineno-0-472"> 472</a></span>
<span class="normal"><a href="#__codelineno-0-473"> 473</a></span>
<span class="normal"><a href="#__codelineno-0-474"> 474</a></span>
<span class="normal"><a href="#__codelineno-0-475"> 475</a></span>
<span class="normal"><a href="#__codelineno-0-476"> 476</a></span>
<span class="normal"><a href="#__codelineno-0-477"> 477</a></span>
<span class="normal"><a href="#__codelineno-0-478"> 478</a></span>
<span class="normal"><a href="#__codelineno-0-479"> 479</a></span>
<span class="normal"><a href="#__codelineno-0-480"> 480</a></span>
<span class="normal"><a href="#__codelineno-0-481"> 481</a></span>
<span class="normal"><a href="#__codelineno-0-482"> 482</a></span>
<span class="normal"><a href="#__codelineno-0-483"> 483</a></span>
<span class="normal"><a href="#__codelineno-0-484"> 484</a></span>
<span class="normal"><a href="#__codelineno-0-485"> 485</a></span>
<span class="normal"><a href="#__codelineno-0-486"> 486</a></span>
<span class="normal"><a href="#__codelineno-0-487"> 487</a></span>
<span class="normal"><a href="#__codelineno-0-488"> 488</a></span>
<span class="normal"><a href="#__codelineno-0-489"> 489</a></span>
<span class="normal"><a href="#__codelineno-0-490"> 490</a></span>
<span class="normal"><a href="#__codelineno-0-491"> 491</a></span>
<span class="normal"><a href="#__codelineno-0-492"> 492</a></span>
<span class="normal"><a href="#__codelineno-0-493"> 493</a></span>
<span class="normal"><a href="#__codelineno-0-494"> 494</a></span>
<span class="normal"><a href="#__codelineno-0-495"> 495</a></span>
<span class="normal"><a href="#__codelineno-0-496"> 496</a></span>
<span class="normal"><a href="#__codelineno-0-497"> 497</a></span>
<span class="normal"><a href="#__codelineno-0-498"> 498</a></span>
<span class="normal"><a href="#__codelineno-0-499"> 499</a></span>
<span class="normal"><a href="#__codelineno-0-500"> 500</a></span>
<span class="normal"><a href="#__codelineno-0-501"> 501</a></span>
<span class="normal"><a href="#__codelineno-0-502"> 502</a></span>
<span class="normal"><a href="#__codelineno-0-503"> 503</a></span>
<span class="normal"><a href="#__codelineno-0-504"> 504</a></span>
<span class="normal"><a href="#__codelineno-0-505"> 505</a></span>
<span class="normal"><a href="#__codelineno-0-506"> 506</a></span>
<span class="normal"><a href="#__codelineno-0-507"> 507</a></span>
<span class="normal"><a href="#__codelineno-0-508"> 508</a></span>
<span class="normal"><a href="#__codelineno-0-509"> 509</a></span>
<span class="normal"><a href="#__codelineno-0-510"> 510</a></span>
<span class="normal"><a href="#__codelineno-0-511"> 511</a></span>
<span class="normal"><a href="#__codelineno-0-512"> 512</a></span>
<span class="normal"><a href="#__codelineno-0-513"> 513</a></span>
<span class="normal"><a href="#__codelineno-0-514"> 514</a></span>
<span class="normal"><a href="#__codelineno-0-515"> 515</a></span>
<span class="normal"><a href="#__codelineno-0-516"> 516</a></span>
<span class="normal"><a href="#__codelineno-0-517"> 517</a></span>
<span class="normal"><a href="#__codelineno-0-518"> 518</a></span>
<span class="normal"><a href="#__codelineno-0-519"> 519</a></span>
<span class="normal"><a href="#__codelineno-0-520"> 520</a></span>
<span class="normal"><a href="#__codelineno-0-521"> 521</a></span>
<span class="normal"><a href="#__codelineno-0-522"> 522</a></span>
<span class="normal"><a href="#__codelineno-0-523"> 523</a></span>
<span class="normal"><a href="#__codelineno-0-524"> 524</a></span>
<span class="normal"><a href="#__codelineno-0-525"> 525</a></span>
<span class="normal"><a href="#__codelineno-0-526"> 526</a></span>
<span class="normal"><a href="#__codelineno-0-527"> 527</a></span>
<span class="normal"><a href="#__codelineno-0-528"> 528</a></span>
<span class="normal"><a href="#__codelineno-0-529"> 529</a></span>
<span class="normal"><a href="#__codelineno-0-530"> 530</a></span>
<span class="normal"><a href="#__codelineno-0-531"> 531</a></span>
<span class="normal"><a href="#__codelineno-0-532"> 532</a></span>
<span class="normal"><a href="#__codelineno-0-533"> 533</a></span>
<span class="normal"><a href="#__codelineno-0-534"> 534</a></span>
<span class="normal"><a href="#__codelineno-0-535"> 535</a></span>
<span class="normal"><a href="#__codelineno-0-536"> 536</a></span>
<span class="normal"><a href="#__codelineno-0-537"> 537</a></span>
<span class="normal"><a href="#__codelineno-0-538"> 538</a></span>
<span class="normal"><a href="#__codelineno-0-539"> 539</a></span>
<span class="normal"><a href="#__codelineno-0-540"> 540</a></span>
<span class="normal"><a href="#__codelineno-0-541"> 541</a></span>
<span class="normal"><a href="#__codelineno-0-542"> 542</a></span>
<span class="normal"><a href="#__codelineno-0-543"> 543</a></span>
<span class="normal"><a href="#__codelineno-0-544"> 544</a></span>
<span class="normal"><a href="#__codelineno-0-545"> 545</a></span>
<span class="normal"><a href="#__codelineno-0-546"> 546</a></span>
<span class="normal"><a href="#__codelineno-0-547"> 547</a></span>
<span class="normal"><a href="#__codelineno-0-548"> 548</a></span>
<span class="normal"><a href="#__codelineno-0-549"> 549</a></span>
<span class="normal"><a href="#__codelineno-0-550"> 550</a></span>
<span class="normal"><a href="#__codelineno-0-551"> 551</a></span>
<span class="normal"><a href="#__codelineno-0-552"> 552</a></span>
<span class="normal"><a href="#__codelineno-0-553"> 553</a></span>
<span class="normal"><a href="#__codelineno-0-554"> 554</a></span>
<span class="normal"><a href="#__codelineno-0-555"> 555</a></span>
<span class="normal"><a href="#__codelineno-0-556"> 556</a></span>
<span class="normal"><a href="#__codelineno-0-557"> 557</a></span>
<span class="normal"><a href="#__codelineno-0-558"> 558</a></span>
<span class="normal"><a href="#__codelineno-0-559"> 559</a></span>
<span class="normal"><a href="#__codelineno-0-560"> 560</a></span>
<span class="normal"><a href="#__codelineno-0-561"> 561</a></span>
<span class="normal"><a href="#__codelineno-0-562"> 562</a></span>
<span class="normal"><a href="#__codelineno-0-563"> 563</a></span>
<span class="normal"><a href="#__codelineno-0-564"> 564</a></span>
<span class="normal"><a href="#__codelineno-0-565"> 565</a></span>
<span class="normal"><a href="#__codelineno-0-566"> 566</a></span>
<span class="normal"><a href="#__codelineno-0-567"> 567</a></span>
<span class="normal"><a href="#__codelineno-0-568"> 568</a></span>
<span class="normal"><a href="#__codelineno-0-569"> 569</a></span>
<span class="normal"><a href="#__codelineno-0-570"> 570</a></span>
<span class="normal"><a href="#__codelineno-0-571"> 571</a></span>
<span class="normal"><a href="#__codelineno-0-572"> 572</a></span>
<span class="normal"><a href="#__codelineno-0-573"> 573</a></span>
<span class="normal"><a href="#__codelineno-0-574"> 574</a></span>
<span class="normal"><a href="#__codelineno-0-575"> 575</a></span>
<span class="normal"><a href="#__codelineno-0-576"> 576</a></span>
<span class="normal"><a href="#__codelineno-0-577"> 577</a></span>
<span class="normal"><a href="#__codelineno-0-578"> 578</a></span>
<span class="normal"><a href="#__codelineno-0-579"> 579</a></span>
<span class="normal"><a href="#__codelineno-0-580"> 580</a></span>
<span class="normal"><a href="#__codelineno-0-581"> 581</a></span>
<span class="normal"><a href="#__codelineno-0-582"> 582</a></span>
<span class="normal"><a href="#__codelineno-0-583"> 583</a></span>
<span class="normal"><a href="#__codelineno-0-584"> 584</a></span>
<span class="normal"><a href="#__codelineno-0-585"> 585</a></span>
<span class="normal"><a href="#__codelineno-0-586"> 586</a></span>
<span class="normal"><a href="#__codelineno-0-587"> 587</a></span>
<span class="normal"><a href="#__codelineno-0-588"> 588</a></span>
<span class="normal"><a href="#__codelineno-0-589"> 589</a></span>
<span class="normal"><a href="#__codelineno-0-590"> 590</a></span>
<span class="normal"><a href="#__codelineno-0-591"> 591</a></span>
<span class="normal"><a href="#__codelineno-0-592"> 592</a></span>
<span class="normal"><a href="#__codelineno-0-593"> 593</a></span>
<span class="normal"><a href="#__codelineno-0-594"> 594</a></span>
<span class="normal"><a href="#__codelineno-0-595"> 595</a></span>
<span class="normal"><a href="#__codelineno-0-596"> 596</a></span>
<span class="normal"><a href="#__codelineno-0-597"> 597</a></span>
<span class="normal"><a href="#__codelineno-0-598"> 598</a></span>
<span class="normal"><a href="#__codelineno-0-599"> 599</a></span>
<span class="normal"><a href="#__codelineno-0-600"> 600</a></span>
<span class="normal"><a href="#__codelineno-0-601"> 601</a></span>
<span class="normal"><a href="#__codelineno-0-602"> 602</a></span>
<span class="normal"><a href="#__codelineno-0-603"> 603</a></span>
<span class="normal"><a href="#__codelineno-0-604"> 604</a></span>
<span class="normal"><a href="#__codelineno-0-605"> 605</a></span>
<span class="normal"><a href="#__codelineno-0-606"> 606</a></span>
<span class="normal"><a href="#__codelineno-0-607"> 607</a></span>
<span class="normal"><a href="#__codelineno-0-608"> 608</a></span>
<span class="normal"><a href="#__codelineno-0-609"> 609</a></span>
<span class="normal"><a href="#__codelineno-0-610"> 610</a></span>
<span class="normal"><a href="#__codelineno-0-611"> 611</a></span>
<span class="normal"><a href="#__codelineno-0-612"> 612</a></span>
<span class="normal"><a href="#__codelineno-0-613"> 613</a></span>
<span class="normal"><a href="#__codelineno-0-614"> 614</a></span>
<span class="normal"><a href="#__codelineno-0-615"> 615</a></span>
<span class="normal"><a href="#__codelineno-0-616"> 616</a></span>
<span class="normal"><a href="#__codelineno-0-617"> 617</a></span>
<span class="normal"><a href="#__codelineno-0-618"> 618</a></span>
<span class="normal"><a href="#__codelineno-0-619"> 619</a></span>
<span class="normal"><a href="#__codelineno-0-620"> 620</a></span>
<span class="normal"><a href="#__codelineno-0-621"> 621</a></span>
<span class="normal"><a href="#__codelineno-0-622"> 622</a></span>
<span class="normal"><a href="#__codelineno-0-623"> 623</a></span>
<span class="normal"><a href="#__codelineno-0-624"> 624</a></span>
<span class="normal"><a href="#__codelineno-0-625"> 625</a></span>
<span class="normal"><a href="#__codelineno-0-626"> 626</a></span>
<span class="normal"><a href="#__codelineno-0-627"> 627</a></span>
<span class="normal"><a href="#__codelineno-0-628"> 628</a></span>
<span class="normal"><a href="#__codelineno-0-629"> 629</a></span>
<span class="normal"><a href="#__codelineno-0-630"> 630</a></span>
<span class="normal"><a href="#__codelineno-0-631"> 631</a></span>
<span class="normal"><a href="#__codelineno-0-632"> 632</a></span>
<span class="normal"><a href="#__codelineno-0-633"> 633</a></span>
<span class="normal"><a href="#__codelineno-0-634"> 634</a></span>
<span class="normal"><a href="#__codelineno-0-635"> 635</a></span>
<span class="normal"><a href="#__codelineno-0-636"> 636</a></span>
<span class="normal"><a href="#__codelineno-0-637"> 637</a></span>
<span class="normal"><a href="#__codelineno-0-638"> 638</a></span>
<span class="normal"><a href="#__codelineno-0-639"> 639</a></span>
<span class="normal"><a href="#__codelineno-0-640"> 640</a></span>
<span class="normal"><a href="#__codelineno-0-641"> 641</a></span>
<span class="normal"><a href="#__codelineno-0-642"> 642</a></span>
<span class="normal"><a href="#__codelineno-0-643"> 643</a></span>
<span class="normal"><a href="#__codelineno-0-644"> 644</a></span>
<span class="normal"><a href="#__codelineno-0-645"> 645</a></span>
<span class="normal"><a href="#__codelineno-0-646"> 646</a></span>
<span class="normal"><a href="#__codelineno-0-647"> 647</a></span>
<span class="normal"><a href="#__codelineno-0-648"> 648</a></span>
<span class="normal"><a href="#__codelineno-0-649"> 649</a></span>
<span class="normal"><a href="#__codelineno-0-650"> 650</a></span>
<span class="normal"><a href="#__codelineno-0-651"> 651</a></span>
<span class="normal"><a href="#__codelineno-0-652"> 652</a></span>
<span class="normal"><a href="#__codelineno-0-653"> 653</a></span>
<span class="normal"><a href="#__codelineno-0-654"> 654</a></span>
<span class="normal"><a href="#__codelineno-0-655"> 655</a></span>
<span class="normal"><a href="#__codelineno-0-656"> 656</a></span>
<span class="normal"><a href="#__codelineno-0-657"> 657</a></span>
<span class="normal"><a href="#__codelineno-0-658"> 658</a></span>
<span class="normal"><a href="#__codelineno-0-659"> 659</a></span>
<span class="normal"><a href="#__codelineno-0-660"> 660</a></span>
<span class="normal"><a href="#__codelineno-0-661"> 661</a></span>
<span class="normal"><a href="#__codelineno-0-662"> 662</a></span>
<span class="normal"><a href="#__codelineno-0-663"> 663</a></span>
<span class="normal"><a href="#__codelineno-0-664"> 664</a></span>
<span class="normal"><a href="#__codelineno-0-665"> 665</a></span>
<span class="normal"><a href="#__codelineno-0-666"> 666</a></span>
<span class="normal"><a href="#__codelineno-0-667"> 667</a></span>
<span class="normal"><a href="#__codelineno-0-668"> 668</a></span>
<span class="normal"><a href="#__codelineno-0-669"> 669</a></span>
<span class="normal"><a href="#__codelineno-0-670"> 670</a></span>
<span class="normal"><a href="#__codelineno-0-671"> 671</a></span>
<span class="normal"><a href="#__codelineno-0-672"> 672</a></span>
<span class="normal"><a href="#__codelineno-0-673"> 673</a></span>
<span class="normal"><a href="#__codelineno-0-674"> 674</a></span>
<span class="normal"><a href="#__codelineno-0-675"> 675</a></span>
<span class="normal"><a href="#__codelineno-0-676"> 676</a></span>
<span class="normal"><a href="#__codelineno-0-677"> 677</a></span>
<span class="normal"><a href="#__codelineno-0-678"> 678</a></span>
<span class="normal"><a href="#__codelineno-0-679"> 679</a></span>
<span class="normal"><a href="#__codelineno-0-680"> 680</a></span>
<span class="normal"><a href="#__codelineno-0-681"> 681</a></span>
<span class="normal"><a href="#__codelineno-0-682"> 682</a></span>
<span class="normal"><a href="#__codelineno-0-683"> 683</a></span>
<span class="normal"><a href="#__codelineno-0-684"> 684</a></span>
<span class="normal"><a href="#__codelineno-0-685"> 685</a></span>
<span class="normal"><a href="#__codelineno-0-686"> 686</a></span>
<span class="normal"><a href="#__codelineno-0-687"> 687</a></span>
<span class="normal"><a href="#__codelineno-0-688"> 688</a></span>
<span class="normal"><a href="#__codelineno-0-689"> 689</a></span>
<span class="normal"><a href="#__codelineno-0-690"> 690</a></span>
<span class="normal"><a href="#__codelineno-0-691"> 691</a></span>
<span class="normal"><a href="#__codelineno-0-692"> 692</a></span>
<span class="normal"><a href="#__codelineno-0-693"> 693</a></span>
<span class="normal"><a href="#__codelineno-0-694"> 694</a></span>
<span class="normal"><a href="#__codelineno-0-695"> 695</a></span>
<span class="normal"><a href="#__codelineno-0-696"> 696</a></span>
<span class="normal"><a href="#__codelineno-0-697"> 697</a></span>
<span class="normal"><a href="#__codelineno-0-698"> 698</a></span>
<span class="normal"><a href="#__codelineno-0-699"> 699</a></span>
<span class="normal"><a href="#__codelineno-0-700"> 700</a></span>
<span class="normal"><a href="#__codelineno-0-701"> 701</a></span>
<span class="normal"><a href="#__codelineno-0-702"> 702</a></span>
<span class="normal"><a href="#__codelineno-0-703"> 703</a></span>
<span class="normal"><a href="#__codelineno-0-704"> 704</a></span>
<span class="normal"><a href="#__codelineno-0-705"> 705</a></span>
<span class="normal"><a href="#__codelineno-0-706"> 706</a></span>
<span class="normal"><a href="#__codelineno-0-707"> 707</a></span>
<span class="normal"><a href="#__codelineno-0-708"> 708</a></span>
<span class="normal"><a href="#__codelineno-0-709"> 709</a></span>
<span class="normal"><a href="#__codelineno-0-710"> 710</a></span>
<span class="normal"><a href="#__codelineno-0-711"> 711</a></span>
<span class="normal"><a href="#__codelineno-0-712"> 712</a></span>
<span class="normal"><a href="#__codelineno-0-713"> 713</a></span>
<span class="normal"><a href="#__codelineno-0-714"> 714</a></span>
<span class="normal"><a href="#__codelineno-0-715"> 715</a></span>
<span class="normal"><a href="#__codelineno-0-716"> 716</a></span>
<span class="normal"><a href="#__codelineno-0-717"> 717</a></span>
<span class="normal"><a href="#__codelineno-0-718"> 718</a></span>
<span class="normal"><a href="#__codelineno-0-719"> 719</a></span>
<span class="normal"><a href="#__codelineno-0-720"> 720</a></span>
<span class="normal"><a href="#__codelineno-0-721"> 721</a></span>
<span class="normal"><a href="#__codelineno-0-722"> 722</a></span>
<span class="normal"><a href="#__codelineno-0-723"> 723</a></span>
<span class="normal"><a href="#__codelineno-0-724"> 724</a></span>
<span class="normal"><a href="#__codelineno-0-725"> 725</a></span>
<span class="normal"><a href="#__codelineno-0-726"> 726</a></span>
<span class="normal"><a href="#__codelineno-0-727"> 727</a></span>
<span class="normal"><a href="#__codelineno-0-728"> 728</a></span>
<span class="normal"><a href="#__codelineno-0-729"> 729</a></span>
<span class="normal"><a href="#__codelineno-0-730"> 730</a></span>
<span class="normal"><a href="#__codelineno-0-731"> 731</a></span>
<span class="normal"><a href="#__codelineno-0-732"> 732</a></span>
<span class="normal"><a href="#__codelineno-0-733"> 733</a></span>
<span class="normal"><a href="#__codelineno-0-734"> 734</a></span>
<span class="normal"><a href="#__codelineno-0-735"> 735</a></span>
<span class="normal"><a href="#__codelineno-0-736"> 736</a></span>
<span class="normal"><a href="#__codelineno-0-737"> 737</a></span>
<span class="normal"><a href="#__codelineno-0-738"> 738</a></span>
<span class="normal"><a href="#__codelineno-0-739"> 739</a></span>
<span class="normal"><a href="#__codelineno-0-740"> 740</a></span>
<span class="normal"><a href="#__codelineno-0-741"> 741</a></span>
<span class="normal"><a href="#__codelineno-0-742"> 742</a></span>
<span class="normal"><a href="#__codelineno-0-743"> 743</a></span>
<span class="normal"><a href="#__codelineno-0-744"> 744</a></span>
<span class="normal"><a href="#__codelineno-0-745"> 745</a></span>
<span class="normal"><a href="#__codelineno-0-746"> 746</a></span>
<span class="normal"><a href="#__codelineno-0-747"> 747</a></span>
<span class="normal"><a href="#__codelineno-0-748"> 748</a></span>
<span class="normal"><a href="#__codelineno-0-749"> 749</a></span>
<span class="normal"><a href="#__codelineno-0-750"> 750</a></span>
<span class="normal"><a href="#__codelineno-0-751"> 751</a></span>
<span class="normal"><a href="#__codelineno-0-752"> 752</a></span>
<span class="normal"><a href="#__codelineno-0-753"> 753</a></span>
<span class="normal"><a href="#__codelineno-0-754"> 754</a></span>
<span class="normal"><a href="#__codelineno-0-755"> 755</a></span>
<span class="normal"><a href="#__codelineno-0-756"> 756</a></span>
<span class="normal"><a href="#__codelineno-0-757"> 757</a></span>
<span class="normal"><a href="#__codelineno-0-758"> 758</a></span>
<span class="normal"><a href="#__codelineno-0-759"> 759</a></span>
<span class="normal"><a href="#__codelineno-0-760"> 760</a></span>
<span class="normal"><a href="#__codelineno-0-761"> 761</a></span>
<span class="normal"><a href="#__codelineno-0-762"> 762</a></span>
<span class="normal"><a href="#__codelineno-0-763"> 763</a></span>
<span class="normal"><a href="#__codelineno-0-764"> 764</a></span>
<span class="normal"><a href="#__codelineno-0-765"> 765</a></span>
<span class="normal"><a href="#__codelineno-0-766"> 766</a></span>
<span class="normal"><a href="#__codelineno-0-767"> 767</a></span>
<span class="normal"><a href="#__codelineno-0-768"> 768</a></span>
<span class="normal"><a href="#__codelineno-0-769"> 769</a></span>
<span class="normal"><a href="#__codelineno-0-770"> 770</a></span>
<span class="normal"><a href="#__codelineno-0-771"> 771</a></span>
<span class="normal"><a href="#__codelineno-0-772"> 772</a></span>
<span class="normal"><a href="#__codelineno-0-773"> 773</a></span>
<span class="normal"><a href="#__codelineno-0-774"> 774</a></span>
<span class="normal"><a href="#__codelineno-0-775"> 775</a></span>
<span class="normal"><a href="#__codelineno-0-776"> 776</a></span>
<span class="normal"><a href="#__codelineno-0-777"> 777</a></span>
<span class="normal"><a href="#__codelineno-0-778"> 778</a></span>
<span class="normal"><a href="#__codelineno-0-779"> 779</a></span>
<span class="normal"><a href="#__codelineno-0-780"> 780</a></span>
<span class="normal"><a href="#__codelineno-0-781"> 781</a></span>
<span class="normal"><a href="#__codelineno-0-782"> 782</a></span>
<span class="normal"><a href="#__codelineno-0-783"> 783</a></span>
<span class="normal"><a href="#__codelineno-0-784"> 784</a></span>
<span class="normal"><a href="#__codelineno-0-785"> 785</a></span>
<span class="normal"><a href="#__codelineno-0-786"> 786</a></span>
<span class="normal"><a href="#__codelineno-0-787"> 787</a></span>
<span class="normal"><a href="#__codelineno-0-788"> 788</a></span>
<span class="normal"><a href="#__codelineno-0-789"> 789</a></span>
<span class="normal"><a href="#__codelineno-0-790"> 790</a></span>
<span class="normal"><a href="#__codelineno-0-791"> 791</a></span>
<span class="normal"><a href="#__codelineno-0-792"> 792</a></span>
<span class="normal"><a href="#__codelineno-0-793"> 793</a></span>
<span class="normal"><a href="#__codelineno-0-794"> 794</a></span>
<span class="normal"><a href="#__codelineno-0-795"> 795</a></span>
<span class="normal"><a href="#__codelineno-0-796"> 796</a></span>
<span class="normal"><a href="#__codelineno-0-797"> 797</a></span>
<span class="normal"><a href="#__codelineno-0-798"> 798</a></span>
<span class="normal"><a href="#__codelineno-0-799"> 799</a></span>
<span class="normal"><a href="#__codelineno-0-800"> 800</a></span>
<span class="normal"><a href="#__codelineno-0-801"> 801</a></span>
<span class="normal"><a href="#__codelineno-0-802"> 802</a></span>
<span class="normal"><a href="#__codelineno-0-803"> 803</a></span>
<span class="normal"><a href="#__codelineno-0-804"> 804</a></span>
<span class="normal"><a href="#__codelineno-0-805"> 805</a></span>
<span class="normal"><a href="#__codelineno-0-806"> 806</a></span>
<span class="normal"><a href="#__codelineno-0-807"> 807</a></span>
<span class="normal"><a href="#__codelineno-0-808"> 808</a></span>
<span class="normal"><a href="#__codelineno-0-809"> 809</a></span>
<span class="normal"><a href="#__codelineno-0-810"> 810</a></span>
<span class="normal"><a href="#__codelineno-0-811"> 811</a></span>
<span class="normal"><a href="#__codelineno-0-812"> 812</a></span>
<span class="normal"><a href="#__codelineno-0-813"> 813</a></span>
<span class="normal"><a href="#__codelineno-0-814"> 814</a></span>
<span class="normal"><a href="#__codelineno-0-815"> 815</a></span>
<span class="normal"><a href="#__codelineno-0-816"> 816</a></span>
<span class="normal"><a href="#__codelineno-0-817"> 817</a></span>
<span class="normal"><a href="#__codelineno-0-818"> 818</a></span>
<span class="normal"><a href="#__codelineno-0-819"> 819</a></span>
<span class="normal"><a href="#__codelineno-0-820"> 820</a></span>
<span class="normal"><a href="#__codelineno-0-821"> 821</a></span>
<span class="normal"><a href="#__codelineno-0-822"> 822</a></span>
<span class="normal"><a href="#__codelineno-0-823"> 823</a></span>
<span class="normal"><a href="#__codelineno-0-824"> 824</a></span>
<span class="normal"><a href="#__codelineno-0-825"> 825</a></span>
<span class="normal"><a href="#__codelineno-0-826"> 826</a></span>
<span class="normal"><a href="#__codelineno-0-827"> 827</a></span>
<span class="normal"><a href="#__codelineno-0-828"> 828</a></span>
<span class="normal"><a href="#__codelineno-0-829"> 829</a></span>
<span class="normal"><a href="#__codelineno-0-830"> 830</a></span>
<span class="normal"><a href="#__codelineno-0-831"> 831</a></span>
<span class="normal"><a href="#__codelineno-0-832"> 832</a></span>
<span class="normal"><a href="#__codelineno-0-833"> 833</a></span>
<span class="normal"><a href="#__codelineno-0-834"> 834</a></span>
<span class="normal"><a href="#__codelineno-0-835"> 835</a></span>
<span class="normal"><a href="#__codelineno-0-836"> 836</a></span>
<span class="normal"><a href="#__codelineno-0-837"> 837</a></span>
<span class="normal"><a href="#__codelineno-0-838"> 838</a></span>
<span class="normal"><a href="#__codelineno-0-839"> 839</a></span>
<span class="normal"><a href="#__codelineno-0-840"> 840</a></span>
<span class="normal"><a href="#__codelineno-0-841"> 841</a></span>
<span class="normal"><a href="#__codelineno-0-842"> 842</a></span>
<span class="normal"><a href="#__codelineno-0-843"> 843</a></span>
<span class="normal"><a href="#__codelineno-0-844"> 844</a></span>
<span class="normal"><a href="#__codelineno-0-845"> 845</a></span>
<span class="normal"><a href="#__codelineno-0-846"> 846</a></span>
<span class="normal"><a href="#__codelineno-0-847"> 847</a></span>
<span class="normal"><a href="#__codelineno-0-848"> 848</a></span>
<span class="normal"><a href="#__codelineno-0-849"> 849</a></span>
<span class="normal"><a href="#__codelineno-0-850"> 850</a></span>
<span class="normal"><a href="#__codelineno-0-851"> 851</a></span>
<span class="normal"><a href="#__codelineno-0-852"> 852</a></span>
<span class="normal"><a href="#__codelineno-0-853"> 853</a></span>
<span class="normal"><a href="#__codelineno-0-854"> 854</a></span>
<span class="normal"><a href="#__codelineno-0-855"> 855</a></span>
<span class="normal"><a href="#__codelineno-0-856"> 856</a></span>
<span class="normal"><a href="#__codelineno-0-857"> 857</a></span>
<span class="normal"><a href="#__codelineno-0-858"> 858</a></span>
<span class="normal"><a href="#__codelineno-0-859"> 859</a></span>
<span class="normal"><a href="#__codelineno-0-860"> 860</a></span>
<span class="normal"><a href="#__codelineno-0-861"> 861</a></span>
<span class="normal"><a href="#__codelineno-0-862"> 862</a></span>
<span class="normal"><a href="#__codelineno-0-863"> 863</a></span>
<span class="normal"><a href="#__codelineno-0-864"> 864</a></span>
<span class="normal"><a href="#__codelineno-0-865"> 865</a></span>
<span class="normal"><a href="#__codelineno-0-866"> 866</a></span>
<span class="normal"><a href="#__codelineno-0-867"> 867</a></span>
<span class="normal"><a href="#__codelineno-0-868"> 868</a></span>
<span class="normal"><a href="#__codelineno-0-869"> 869</a></span>
<span class="normal"><a href="#__codelineno-0-870"> 870</a></span>
<span class="normal"><a href="#__codelineno-0-871"> 871</a></span>
<span class="normal"><a href="#__codelineno-0-872"> 872</a></span>
<span class="normal"><a href="#__codelineno-0-873"> 873</a></span>
<span class="normal"><a href="#__codelineno-0-874"> 874</a></span>
<span class="normal"><a href="#__codelineno-0-875"> 875</a></span>
<span class="normal"><a href="#__codelineno-0-876"> 876</a></span>
<span class="normal"><a href="#__codelineno-0-877"> 877</a></span>
<span class="normal"><a href="#__codelineno-0-878"> 878</a></span>
<span class="normal"><a href="#__codelineno-0-879"> 879</a></span>
<span class="normal"><a href="#__codelineno-0-880"> 880</a></span>
<span class="normal"><a href="#__codelineno-0-881"> 881</a></span>
<span class="normal"><a href="#__codelineno-0-882"> 882</a></span>
<span class="normal"><a href="#__codelineno-0-883"> 883</a></span>
<span class="normal"><a href="#__codelineno-0-884"> 884</a></span>
<span class="normal"><a href="#__codelineno-0-885"> 885</a></span>
<span class="normal"><a href="#__codelineno-0-886"> 886</a></span>
<span class="normal"><a href="#__codelineno-0-887"> 887</a></span>
<span class="normal"><a href="#__codelineno-0-888"> 888</a></span>
<span class="normal"><a href="#__codelineno-0-889"> 889</a></span>
<span class="normal"><a href="#__codelineno-0-890"> 890</a></span>
<span class="normal"><a href="#__codelineno-0-891"> 891</a></span>
<span class="normal"><a href="#__codelineno-0-892"> 892</a></span>
<span class="normal"><a href="#__codelineno-0-893"> 893</a></span>
<span class="normal"><a href="#__codelineno-0-894"> 894</a></span>
<span class="normal"><a href="#__codelineno-0-895"> 895</a></span>
<span class="normal"><a href="#__codelineno-0-896"> 896</a></span>
<span class="normal"><a href="#__codelineno-0-897"> 897</a></span>
<span class="normal"><a href="#__codelineno-0-898"> 898</a></span>
<span class="normal"><a href="#__codelineno-0-899"> 899</a></span>
<span class="normal"><a href="#__codelineno-0-900"> 900</a></span>
<span class="normal"><a href="#__codelineno-0-901"> 901</a></span>
<span class="normal"><a href="#__codelineno-0-902"> 902</a></span>
<span class="normal"><a href="#__codelineno-0-903"> 903</a></span>
<span class="normal"><a href="#__codelineno-0-904"> 904</a></span>
<span class="normal"><a href="#__codelineno-0-905"> 905</a></span>
<span class="normal"><a href="#__codelineno-0-906"> 906</a></span>
<span class="normal"><a href="#__codelineno-0-907"> 907</a></span>
<span class="normal"><a href="#__codelineno-0-908"> 908</a></span>
<span class="normal"><a href="#__codelineno-0-909"> 909</a></span>
<span class="normal"><a href="#__codelineno-0-910"> 910</a></span>
<span class="normal"><a href="#__codelineno-0-911"> 911</a></span>
<span class="normal"><a href="#__codelineno-0-912"> 912</a></span>
<span class="normal"><a href="#__codelineno-0-913"> 913</a></span>
<span class="normal"><a href="#__codelineno-0-914"> 914</a></span>
<span class="normal"><a href="#__codelineno-0-915"> 915</a></span>
<span class="normal"><a href="#__codelineno-0-916"> 916</a></span>
<span class="normal"><a href="#__codelineno-0-917"> 917</a></span>
<span class="normal"><a href="#__codelineno-0-918"> 918</a></span>
<span class="normal"><a href="#__codelineno-0-919"> 919</a></span>
<span class="normal"><a href="#__codelineno-0-920"> 920</a></span>
<span class="normal"><a href="#__codelineno-0-921"> 921</a></span>
<span class="normal"><a href="#__codelineno-0-922"> 922</a></span>
<span class="normal"><a href="#__codelineno-0-923"> 923</a></span>
<span class="normal"><a href="#__codelineno-0-924"> 924</a></span>
<span class="normal"><a href="#__codelineno-0-925"> 925</a></span>
<span class="normal"><a href="#__codelineno-0-926"> 926</a></span>
<span class="normal"><a href="#__codelineno-0-927"> 927</a></span>
<span class="normal"><a href="#__codelineno-0-928"> 928</a></span>
<span class="normal"><a href="#__codelineno-0-929"> 929</a></span>
<span class="normal"><a href="#__codelineno-0-930"> 930</a></span>
<span class="normal"><a href="#__codelineno-0-931"> 931</a></span>
<span class="normal"><a href="#__codelineno-0-932"> 932</a></span>
<span class="normal"><a href="#__codelineno-0-933"> 933</a></span>
<span class="normal"><a href="#__codelineno-0-934"> 934</a></span>
<span class="normal"><a href="#__codelineno-0-935"> 935</a></span>
<span class="normal"><a href="#__codelineno-0-936"> 936</a></span>
<span class="normal"><a href="#__codelineno-0-937"> 937</a></span>
<span class="normal"><a href="#__codelineno-0-938"> 938</a></span>
<span class="normal"><a href="#__codelineno-0-939"> 939</a></span>
<span class="normal"><a href="#__codelineno-0-940"> 940</a></span>
<span class="normal"><a href="#__codelineno-0-941"> 941</a></span>
<span class="normal"><a href="#__codelineno-0-942"> 942</a></span>
<span class="normal"><a href="#__codelineno-0-943"> 943</a></span>
<span class="normal"><a href="#__codelineno-0-944"> 944</a></span>
<span class="normal"><a href="#__codelineno-0-945"> 945</a></span>
<span class="normal"><a href="#__codelineno-0-946"> 946</a></span>
<span class="normal"><a href="#__codelineno-0-947"> 947</a></span>
<span class="normal"><a href="#__codelineno-0-948"> 948</a></span>
<span class="normal"><a href="#__codelineno-0-949"> 949</a></span>
<span class="normal"><a href="#__codelineno-0-950"> 950</a></span>
<span class="normal"><a href="#__codelineno-0-951"> 951</a></span>
<span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span>
<span class="normal"><a href="#__codelineno-0-1075">1075</a></span>
<span class="normal"><a href="#__codelineno-0-1076">1076</a></span>
<span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span>
<span class="normal"><a href="#__codelineno-0-1081">1081</a></span>
<span class="normal"><a href="#__codelineno-0-1082">1082</a></span>
<span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span>
<span class="normal"><a href="#__codelineno-0-1143">1143</a></span>
<span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span>
<span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span>
<span class="normal"><a href="#__codelineno-0-1199">1199</a></span>
<span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span>
<span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdaSTEM</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;An AdaSTEM model class inherited by AdaSTEMClassifier and AdaSTEMRegressor&quot;&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">base_model</span><span class="p">:</span> <span class="n">BaseEstimator</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hurdle&quot;</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">ensemble_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">min_ensemble_required</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">grid_len_upper_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">grid_len_lower_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">points_lower_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">stixel_training_size_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">temporal_start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">temporal_end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">366</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">temporal_step</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">temporal_bin_interval</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">temporal_bin_start_jitter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">spatio_bin_jitter_magnitude</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="n">save_gridding_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">sample_weights_for_classifier</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="n">Spatio1</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">Spatio2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">Temporal1</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DOY&quot;</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">use_temporal_to_train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="n">subset_x_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">plot_xlims</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">plot_ylims</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">plot_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">completely_random_rotation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">lazy_loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">lazy_loading_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">min_class_sample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">ensemble_bootstrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">joblib_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;loky&#39;</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="n">max_mem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;2GB&#39;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="p">):</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Make an AdaSTEM object</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">            base_model:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">                base model estimator</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">            task:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">                task of the model. One of &#39;classifier&#39;, &#39;regressor&#39; and &#39;hurdle&#39;. Defaults to &#39;hurdle&#39;.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">            ensemble_fold:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">                Ensembles count. Higher, better for the model performance. Time complexity O(N). Defaults to 10.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">            min_ensemble_required:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">                Only points with more than this number of model ensembles available are predicted.</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">                In the training phase, if stixels contain less than `points_lower_threshold` of data records,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">                the results are set to np.nan, making them `unpredictable`. Defaults to 7.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">            grid_len_upper_threshold:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">                force divide if grid length larger than the threshold. Defaults to 25.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">            grid_len_lower_threshold:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">                stop divide if grid length **will** be below than the threshold. Defaults to 5.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">            points_lower_threshold:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">                Do not further split the gird if split results in less samples than this threshold.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">                Overriden by grid_len_*_upper_threshold parameters. Defaults to 50.</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">            stixel_training_size_threshold:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">                Do not train the model if the available data records for this stixel is less than this threshold,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">                and directly set the value to np.nan. Defaults to None, which will be set as the same value as `points_lower_threshold`.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">            temporal_start:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">                start of the temporal sequence. Defaults to 1.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">            temporal_end:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">                end of the temporal sequence. Defaults to 366.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">            temporal_step:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">                step of the sliding window. Defaults to 20.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">            temporal_bin_interval:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">                size of the sliding window. Defaults to 50.</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">            temporal_bin_start_jitter:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">                jitter of the start of the sliding window.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">                If &#39;adaptive&#39;, a random jitter of range (-bin_interval, 0) will be generated</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">                for the start. Defaults to &#39;adaptive&#39;.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">            spatio_bin_jitter_magnitude:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">                jitter of the spatial gridding. Defaults to &#39;adaptive&#39;.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">            random_state:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">                None or int. After setting the same seed, the model will generate the same results each time. For reproducibility.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">            save_gridding_plot:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">                Whether ot save gridding plots. Defaults to True.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">            sample_weights_for_classifier:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">                Whether to adjust for unbanlanced data for the classifier. Default to True.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">            Spatio1:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">                Spatial column name 1 in data. Defaults to &#39;longitude&#39;.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">            Spatio2:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">                Spatial column name 2 in data. Defaults to &#39;latitude&#39;.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">            Temporal1:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">                Temporal column name 1 in data.  Defaults to &#39;DOY&#39;.</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">            use_temporal_to_train:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">                Whether to use temporal variable to train. For example in modeling the daily abundance of bird population,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">                whether use &#39;day of year (DOY)&#39; as a training variable. Defaults to True.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">            n_jobs:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">                Number of multiprocessing in fitting the model. Defaults to 1.</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">            subset_x_names:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">                Whether to only store variables with std &gt; 0 for each stixel. Set to False will significantly increase the training speed.</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">            plot_xlims:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">                If save_gridding_plot=true, what is the xlims of the plot. Defaults to the extent of input X varibale.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">            plot_ylims:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">                If save_gridding_plot=true, what is the ylims of the plot. Defaults to the extent of input Y varibale.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">            verbosity:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">                Verbosity of the logging information to print. 0 to output nothing and everything otherwise.</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">            plot_empty:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">                Whether to plot the empty grid</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">            completely_random_rotation:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">                If True, the rotation angle will be generated completely randomly, as in paper https://doi.org/10.1002/eap.2056. If False, the ensembles will split the 90 degree with equal angle intervals. e.g., if ensemble_fold=9, then each ensemble will rotate 10 degree futher than the previous ensemble. Defalt to False, because if ensemble fold is small, it will be more robust to equally devide the data; and if ensemble fold is large, they are effectively similar than complete random.</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">            lazy_loading:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">                If True, ensembles of models will be saved in disk, and only loaded when being used (e.g., prediction phase), and the ensembles of models are dump to disk once it is used.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">            lazy_loading_dir:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">                If lazy_loading, the directory of the model to temporary save to. Default to None, where a folder in /tmp will be created and used. This folder can exist even with lazy_loading==False.</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">            min_class_sample:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">                Minimum umber of samples needed to train the classifier in each stixel. If the sample does not satisfy, fit a dummy one. This parameter does not influence regression tasks.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">            ensemble_bootstrap:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">                Whether to bootstrap the data at each ensemble level to account for uncertainty. Defaults to False.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">            joblib_backend:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">                The backend of joblib. Defaults to &#39;loky&#39;. Other options include &#39;threading&#39;. (&#39;multiprocessing&#39; not supported because it does not allow generator format).</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">            max_mem:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">                The maximum memory use during the training or prediction process. Should be format like &#39;60GB&#39;, &#39;512MB&#39;, &#39;1.5GB&#39;. This argument is only valid if your input training/prediction data is the path to duckdb files. But even if your input are duckdb files, this argument does not guarantee that the memory use for each joblib worker will be lower than that due to various intermediate objects. This argument should only be considered a relative constrain.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">            AttributeError: Base model do not have method &#39;fit&#39; or &#39;predict&#39;</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">            AttributeError: task not in one of [&#39;regression&#39;, &#39;classification&#39;, &#39;hurdle&#39;]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">            AttributeError: temporal_bin_start_jitter not in one of [str, float, int]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">            AttributeError: temporal_bin_start_jitter is type str, but not &#39;random&#39;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        Attributes:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">            x_names (list):</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">                All training variables used.</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">            stixel_specific_x_names (dict):</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">                stixel specific x_names (predictor variable names) for each stixel.</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">                We remove the variables that have no variation for each stixel.</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">                Therefore, the x_names are different for each stixel.</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">            ensemble_df (pd.DataFrame):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">                A dataframe storing the stixel gridding information.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">            gridding_plot (matplotlib.figure.Figure):</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">                Ensemble plot.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">            model_dict (dict):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">                Dictionary of {stixel_index: trained_model}.</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">            grid_dict (dict):</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">                An array of stixels assigned to each ensemble.</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">            feature_importances_ (pd.DataFrame):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">                feature importance dataframe for each stixel.</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="c1"># 1. Check random state</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="c1"># 2. Base model</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="n">check_base_model</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="n">base_model</span> <span class="o">=</span> <span class="n">model_wrapper</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">base_model</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="c1"># 3. Model params</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="n">check_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span> <span class="o">=</span> <span class="n">Temporal1</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span> <span class="o">=</span> <span class="n">Spatio1</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span> <span class="o">=</span> <span class="n">Spatio2</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="c1"># 4. Gridding params</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="k">if</span> <span class="n">min_ensemble_required</span> <span class="o">&gt;</span> <span class="n">ensemble_fold</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not satisfied: min_ensemble_required &lt;= ensemble_fold&quot;</span><span class="p">)</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span> <span class="o">=</span> <span class="n">ensemble_fold</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_ensemble_required</span> <span class="o">=</span> <span class="n">min_ensemble_required</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grid_len_upper_threshold</span> <span class="o">=</span> <span class="n">grid_len_upper_threshold</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grid_len_lower_threshold</span> <span class="o">=</span> <span class="n">grid_len_lower_threshold</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Just a place holder. This will not be used for AdaSTEM and will be override by grid_len in STEM for fixed grid size.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">points_lower_threshold</span> <span class="o">=</span> <span class="n">points_lower_threshold</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_start</span> <span class="o">=</span> <span class="n">temporal_start</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_end</span> <span class="o">=</span> <span class="n">temporal_end</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_step</span> <span class="o">=</span> <span class="n">temporal_step</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span> <span class="o">=</span> <span class="n">temporal_bin_interval</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">completely_random_rotation</span> <span class="o">=</span> <span class="n">completely_random_rotation</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">check_spatio_bin_jitter_magnitude</span><span class="p">(</span><span class="n">spatio_bin_jitter_magnitude</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spatio_bin_jitter_magnitude</span> <span class="o">=</span> <span class="n">spatio_bin_jitter_magnitude</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">check_temporal_bin_start_jitter</span><span class="p">(</span><span class="n">temporal_bin_start_jitter</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_start_jitter</span> <span class="o">=</span> <span class="n">temporal_bin_start_jitter</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="c1"># 5. Training params</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="k">if</span> <span class="n">stixel_training_size_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span> <span class="o">=</span> <span class="n">points_lower_threshold</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span> <span class="o">=</span> <span class="n">stixel_training_size_threshold</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_temporal_to_train</span> <span class="o">=</span> <span class="n">use_temporal_to_train</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subset_x_names</span> <span class="o">=</span> <span class="n">subset_x_names</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_weights_for_classifier</span> <span class="o">=</span> <span class="n">sample_weights_for_classifier</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_class_sample</span> <span class="o">=</span> <span class="n">min_class_sample</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span> <span class="o">=</span> <span class="n">ensemble_bootstrap</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="c1"># 6. Multi-processing params</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span> <span class="o">=</span> <span class="n">joblib_backend</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="c1"># 7. Plotting params</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span> <span class="o">=</span> <span class="n">plot_xlims</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span> <span class="o">=</span> <span class="n">plot_ylims</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_gridding_plot</span> <span class="o">=</span> <span class="n">save_gridding_plot</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_empty</span> <span class="o">=</span> <span class="n">plot_empty</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="c1"># X. miscellaneous</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading</span> <span class="o">=</span> <span class="n">lazy_loading</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="o">=</span> <span class="n">lazy_loading_dir</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">check_mem_string</span><span class="p">(</span><span class="n">max_mem</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_mem</span> <span class="o">=</span> <span class="n">max_mem</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;QuadTree indexing the input data</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">            X_train: Training variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">            verbosity: 0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">            ax: matplotlit Axes to add to.</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">            n_jobs: number of processors for parallel computing</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">            self.grid_dict, a dictionary of one DataFrame for each grid, containing the gridding information</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="c1"># If the .split is being called by itself, need to initiate the joblib_tmp_dir and duckdb_config</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="n">remove_joblib_tmp_dir</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="o">=</span> <span class="n">initiate_lazy_loading_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span> <span class="c1"># run self._cleanup when the object is being garbage collected</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span> <span class="o">=</span> <span class="n">initiate_joblib_tmp_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="o">=</span> <span class="n">duckdb_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_mem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="n">remove_joblib_tmp_dir</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="c1"># Determine grid_len based on conditions</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="c1"># We are using AdaSTEM</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="n">grid_len_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len_upper_threshold</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="n">grid_len_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len_lower_threshold</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="c1"># We are using STEM</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="n">grid_len_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="n">grid_len_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="c1">## Open connection</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="k">with</span> <span class="n">open_db_connection</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="c1"># Here X_train_df can be either pd.DataFrame or duckdb.DuckDBPyRelation</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;X_train_df&quot;</span><span class="p">,</span> <span class="n">X_train_df</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="c1"># spatial &amp; temporal min max</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="n">spatial1_min</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MIN(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="n">spatial1_max</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MAX(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="n">spatial2_min</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MIN(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="n">spatial2_max</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MAX(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="n">temporal1_min</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MIN(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>            <span class="n">temporal1_max</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MAX(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="c1"># Call spatial and temporal scale checks</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">check_spatial_scale</span><span class="p">(</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="n">spatial1_min</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="n">spatial1_max</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="n">spatial2_min</span><span class="p">,</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="n">spatial2_max</span><span class="p">,</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="n">grid_len_upper</span><span class="p">,</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="n">grid_len_lower</span><span class="p">,</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="n">check_temporal_scale</span><span class="p">(</span><span class="n">temporal1_min</span><span class="p">,</span> <span class="n">temporal1_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">spatio_bin_jitter_magnitude</span> <span class="o">=</span> <span class="n">check_transform_spatio_bin_jitter_magnitude</span><span class="p">(</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>           <span class="n">spatial1_max</span><span class="p">,</span> <span class="n">spatial1_min</span><span class="p">,</span> <span class="n">spatial2_max</span><span class="p">,</span> <span class="n">spatial2_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatio_bin_jitter_magnitude</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_gridding_plot</span><span class="p">:</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span> <span class="o">=</span> <span class="p">(</span><span class="n">spatial1_min</span><span class="p">,</span> <span class="n">spatial1_max</span><span class="p">)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span> <span class="o">=</span> <span class="p">(</span><span class="n">spatial2_min</span><span class="p">,</span> <span class="n">spatial2_max</span><span class="p">)</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Quadtree&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                <span class="k">pass</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">X_train_indexes</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">]]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="n">X_train_indexes</span> <span class="o">=</span> <span class="n">X_train</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="n">partial_get_one_ensemble_quadtree</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="n">get_one_ensemble_quadtree</span><span class="p">,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="n">spatio_bin_jitter_magnitude</span><span class="o">=</span><span class="n">spatio_bin_jitter_magnitude</span><span class="p">,</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="n">temporal_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_start</span><span class="p">,</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="n">temporal_end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_end</span><span class="p">,</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="n">temporal_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_step</span><span class="p">,</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="n">temporal_bin_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="p">,</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="n">temporal_bin_start_jitter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_start_jitter</span><span class="p">,</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>            <span class="n">data</span><span class="o">=</span><span class="n">X_train_indexes</span><span class="p">,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="n">duckdb_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="p">,</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="n">Temporal1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="n">grid_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span><span class="p">,</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="n">grid_len_lon_upper_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len_upper_threshold</span><span class="p">,</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="n">grid_len_lon_lower_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="n">grid_len_lat_upper_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len_upper_threshold</span><span class="p">,</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>            <span class="n">grid_len_lat_lower_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="n">points_lower_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">points_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="n">plot_empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_empty</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>            <span class="n">Spatio1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>            <span class="n">Spatio2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="n">save_gridding_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_gridding_plot</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="n">completely_random_rotation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">completely_random_rotation</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="n">ensemble_bootstrap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span><span class="p">,</span> <span class="n">temp_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">partial_get_one_ensemble_quadtree</span><span class="p">)(</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                    <span class="n">ensemble_count</span><span class="o">=</span><span class="n">ensemble_count</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span> <span class="o">+</span> <span class="n">ensemble_count</span><span class="p">)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="k">for</span> <span class="n">ensemble_count</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">))</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="p">)</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="n">output_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">output_generator</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating Ensembles: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="n">ensemble_all_df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_generator</span><span class="p">]</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="n">get_reusable_executor</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="n">iter_func_</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating Ensembles: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="n">ensemble_all_df_list</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                <span class="n">partial_get_one_ensemble_quadtree</span><span class="p">(</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                    <span class="n">ensemble_count</span><span class="o">=</span><span class="n">ensemble_count</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span> <span class="o">+</span> <span class="n">ensemble_count</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="k">for</span> <span class="n">ensemble_count</span> <span class="ow">in</span> <span class="n">iter_func_</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="p">]</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="c1"># concat</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="n">ensemble_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ensemble_all_df_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>        <span class="k">del</span> <span class="n">ensemble_all_df_list</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="c1"># processing</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="n">ensemble_df</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_gridding_plot</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                <span class="k">pass</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridding_plot</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="p">,</span> <span class="n">ax</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridding_plot</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="c1"># Finally, if joblib_tmp_dir is created only for this .split, clean it up</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="k">if</span> <span class="n">remove_joblib_tmp_dir</span><span class="p">:</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">):</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">store_x_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the training variables</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">            X_train (pd.DataFrame, str): input training data.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="c1"># store x_names</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="k">with</span> <span class="n">open_db_connection</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;X_train_df&quot;</span><span class="p">,</span> <span class="n">X_train_df</span><span class="p">)</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;DESCRIBE X_train_df&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()[</span><span class="s2">&quot;column_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">==</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">]</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_temporal_to_train</span><span class="p">:</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">):</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">)]</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">]:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">:</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stixel_fitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stixel</span><span class="p">):</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A sub module of SAC training. Fit one stixel</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">            stixel (pd.DataFrame): data sjoined with ensemble_df.</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="sd">            For a single stixel.</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>        <span class="k">if</span> <span class="s1">&#39;__index_level_0__&#39;</span> <span class="ow">in</span> <span class="n">stixel</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;__index_level_0__ should not apprear in the final training data!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="n">unique_stixel_id</span> <span class="o">=</span> <span class="n">stixel</span><span class="p">[</span><span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="n">ensemble_index</span> <span class="o">=</span> <span class="n">unique_stixel_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>            <span class="n">base_model</span> <span class="o">=</span> <span class="n">LazyLoadingEstimator</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span> 
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>                                               <span class="n">dump_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;ensemble_&#39;</span> <span class="o">+</span> <span class="n">ensemble_index</span><span class="p">),</span> 
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                                               <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;model_</span><span class="si">{</span><span class="n">unique_stixel_id</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span> 
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                                               <span class="n">auto_dump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_loaded</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>        <span class="n">model</span><span class="p">,</span> <span class="n">stixel_specific_x_names</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">train_one_stixel</span><span class="p">(</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>            <span class="n">stixel_training_size_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span><span class="p">,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="n">x_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">,</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="n">base_model</span><span class="o">=</span><span class="n">base_model</span><span class="p">,</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="n">sample_weights_for_classifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_weights_for_classifier</span><span class="p">,</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="n">subset_x_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_x_names</span><span class="p">,</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>            <span class="n">stixel_X_train</span><span class="o">=</span><span class="n">stixel</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="n">min_class_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_class_sample</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>        <span class="p">)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>            <span class="c1"># print(f&#39;Fitting: {ensemble_index}. Not pass: {status}&#39;)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="k">pass</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="k">return</span> <span class="p">[</span><span class="n">unique_stixel_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">stixel_specific_x_names</span><span class="p">]</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">SAC_ensemble_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">single_ensemble_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>                              <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A sub-module of SAC training function.</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="sd">        Train only one ensemble.</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="sd">            single_ensemble_df (pd.DataFrame): ensemble data (from model.ensemble_df)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">            X_train (pd.DataFrame, str): input covariates to train</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">            y_train (pd.DataFrame, str): input ground truth labels</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="sd">            temporal_window_prequery (bool): Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="c1"># Calculate the start indices for the sliding window</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="n">unique_start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="c1"># Initiate duckdb connection</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="n">duckdb_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>        <span class="n">duckdb_config</span><span class="p">[</span><span class="s1">&#39;temp_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">duckdb_config</span><span class="p">[</span><span class="s1">&#39;temp_directory&#39;</span><span class="p">],</span> <span class="n">generate_random_saving_code</span><span class="p">())</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="k">with</span> <span class="n">open_both_Xy_db_connection</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">y_train_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>            <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;X_train_df&quot;</span><span class="p">,</span> <span class="n">X_train_df</span><span class="p">)</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>            <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;y_train_df&quot;</span><span class="p">,</span> <span class="n">y_train_df</span><span class="p">)</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>            <span class="c1"># Get indexes and total_length</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>                <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_train_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>                <span class="n">indexes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT __index_level_0__ FROM X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>            <span class="n">total_length</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>            <span class="c1"># training, window by window</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span><span class="p">:</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>                <span class="n">bootstrap_random_state</span> <span class="o">=</span> <span class="n">single_ensemble_df</span><span class="p">[</span><span class="s1">&#39;bootstrap_random_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>                <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">bootstrap_random_state</span><span class="p">)</span>  <span class="c1"># NumPy&#39;s random generator</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>                <span class="n">bootstrap_indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">total_length</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Full bootstrap sample</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>                <span class="n">bootstrap_indices</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Place holder</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>            <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">unique_start_indices</span><span class="p">:</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>                <span class="c1"># Select the temporal window</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>                    <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_train_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>                        <span class="p">(</span><span class="n">X_train_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> 
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>                        <span class="p">(</span><span class="n">X_train_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="p">)</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                        <span class="p">])</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                    <span class="c1"># Apply bootstrap</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                    <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">bootstrap_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bootstrap_indices</span><span class="p">,</span> <span class="n">temporal_window_indexes</span><span class="p">)]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span> <span class="k">else</span> <span class="n">temporal_window_indexes</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                    <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">][[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">]]</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                    <span class="n">window_X_df</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">]</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">X_train_df</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                    <span class="n">window_y_df</span> <span class="o">=</span> <span class="n">y_train_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">]</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">y_train_df</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                    <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT __index_level_0__ FROM X_train_df WHERE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> AND </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                    <span class="c1"># Apply bootstrap</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>                    <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">bootstrap_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bootstrap_indices</span><span class="p">,</span> <span class="n">temporal_window_indexes</span><span class="p">)]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span> <span class="k">else</span> <span class="n">temporal_window_indexes</span>                
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>                    <span class="n">temporal_window_indexes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">temporal_window_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">])</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temporal_window_indexes_df&quot;</span><span class="p">,</span> <span class="n">temporal_window_indexes_df</span><span class="p">)</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                    <span class="n">window_X_df</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="s2">                        SELECT temporal_window_indexes_df.__index_level_0__,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="s2">                            X_train_df.* EXCLUDE(__index_level_0__)</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="s2">                        FROM temporal_window_indexes_df</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="s2">                        LEFT JOIN X_train_df</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="s2">                        ON X_train_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="s2">                    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">X_train_df</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>                    <span class="n">window_y_df</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="s2">                        SELECT temporal_window_indexes_df.__index_level_0__,</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="s2">                            y_train_df.* EXCLUDE(__index_level_0__)</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="s2">                        FROM temporal_window_indexes_df</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="s2">                        LEFT JOIN y_train_df</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="s2">                        ON y_train_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="s2">                    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">y_train_df</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                    <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="s2">                                                        SELECT X_train_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">, X_train_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">, X_train_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">, X_train_df.__index_level_0__ FROM X_train_df </span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a><span class="s2">                                                        JOIN temporal_window_indexes_df</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="s2">                                                        ON X_train_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__;</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><span class="s2">                                                       &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>                <span class="c1"># Transform to STEM gridding coordinates</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">transform_pred_set_to_STEM_quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span> <span class="n">window_X_df_indexes_only</span><span class="p">,</span> <span class="n">single_ensemble_df</span><span class="p">)</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                <span class="n">window_single_ensemble_df</span> <span class="o">=</span> <span class="n">single_ensemble_df</span><span class="p">[</span><span class="n">single_ensemble_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_start&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">start</span><span class="p">]</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>                <span class="c1"># Merge</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>                <span class="k">def</span><span class="w"> </span><span class="nf">find_belonged_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">y_df</span><span class="p">):</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                    <span class="n">this_stixel_point_indexes</span> <span class="o">=</span> <span class="n">st_indexes_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                        <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_left_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_right_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_lower_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_upper_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                    <span class="p">]</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>                        <span class="n">X_y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_stixel_point_indexes</span><span class="p">],</span> <span class="n">y_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_stixel_point_indexes</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis</span><span class="p">([</span><span class="s1">&#39;true_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyRelation</span><span class="p">):</span>  
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>                        <span class="n">this_stixel_point_indexes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">this_stixel_point_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">])</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;this_stixel_point_indexes_df&quot;</span><span class="p">,</span> <span class="n">this_stixel_point_indexes_df</span><span class="p">)</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;X_df&#39;</span><span class="p">,</span> <span class="n">X_df</span><span class="p">)</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;y_df&#39;</span><span class="p">,</span> <span class="n">y_df</span><span class="p">)</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                        <span class="n">y_column</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">==</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>                        <span class="n">X_y</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="s2">                        SELECT this_stixel_point_indexes_df.__index_level_0__, </span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="s2">                            X_df.* EXCLUDE(__index_level_0__), </span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="s2">                            y_df.</span><span class="si">{</span><span class="n">y_column</span><span class="si">}</span><span class="s2"> as true_y</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="s2">                        FROM this_stixel_point_indexes_df</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="s2">                        LEFT JOIN X_df</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="s2">                            ON X_df.__index_level_0__ = this_stixel_point_indexes_df.__index_level_0__</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="s2">                        LEFT JOIN y_df</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="s2">                            ON y_df.__index_level_0__ = this_stixel_point_indexes_df.__index_level_0__;</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="s2">                        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;this_stixel_point_indexes_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;X_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;y_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>                        <span class="k">raise</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>                    <span class="k">return</span> <span class="n">X_y</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>                <span class="k">def</span><span class="w"> </span><span class="nf">find_belonged_points_and_fit</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">y_df</span><span class="p">):</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>                    <span class="n">X_y</span> <span class="o">=</span> <span class="n">find_belonged_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">y_df</span><span class="p">)</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_y</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>                        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>                    <span class="n">X_y</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>                    <span class="n">X_y</span><span class="p">[</span><span class="s1">&#39;unique_stixel_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unique_stixel_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>                    <span class="n">X_y</span> <span class="o">=</span> <span class="n">X_y</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># To ensure the input dataframes for the two method (temporal_window_prequery or not) are the same so the tained base models are identical, at least with the same input data</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>                    <span class="n">fitted_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_fitting</span><span class="p">(</span><span class="n">X_y</span><span class="p">)</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>                    <span class="k">return</span> <span class="n">fitted_res</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>                <span class="c1"># train</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>                <span class="n">res</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>                    <span class="n">window_single_ensemble_df</span><span class="p">[</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>                        <span class="p">[</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>                            <span class="s2">&quot;ensemble_index&quot;</span><span class="p">,</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>                            <span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">,</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>                            <span class="s2">&quot;stixel_calibration_point_transformed_left_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>                            <span class="s2">&quot;stixel_calibration_point_transformed_right_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>                            <span class="s2">&quot;stixel_calibration_point_transformed_lower_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>                            <span class="s2">&quot;stixel_calibration_point_transformed_upper_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>                        <span class="p">]</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>                    <span class="p">]</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>                    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">,</span> <span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>                    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span> <span class="c1"># Explicitly select all the columns in the original df to include. To overcome the include_groups=True deprecation warning</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">find_belonged_points_and_fit</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="o">=</span><span class="n">window_X_df_indexes_only</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">window_X_df</span><span class="p">,</span> <span class="n">y_df</span><span class="o">=</span><span class="n">window_y_df</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># although [&quot;ensemble_index&quot;, &quot;unique_stixel_id&quot;] will be passed into `find_belonged_points` due to `.pipe(lambda x: x[x.obj.columns])`, the output will not have them so we still set `as_index=True` in `groupby`</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>                <span class="p">)</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>                <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>        <span class="k">return</span> <span class="n">res_list</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">SAC_training</span><span class="p">(</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">ensemble_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>        <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>    <span class="p">):</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;This function is a training function with SAC strategy:</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="sd">        Split (S), Apply(A), Combine (C). At ensemble level.</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a><span class="sd">        It is built on pandas `apply` method.</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><span class="sd">            ensemble_df (pd.DataFrame): gridding information for all ensemble</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><span class="sd">            X_train (pd.DataFrame, str): X_train</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a><span class="sd">            y_train (pd.DataFrame, str): y_train</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a><span class="sd">            verbosity (int, optional): Defaults to 0.</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a><span class="sd">            temporal_window_prequery (bool): Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="n">groups</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>        <span class="c1"># Parallel wrapper</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAC_ensemble_training</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="o">=</span><span class="n">ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span> <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">mp_train</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAC_ensemble_training</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="o">=</span><span class="n">ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>                <span class="k">return</span> <span class="n">res</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>            <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span><span class="p">,</span> <span class="n">temp_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">mp_train</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>        <span class="c1"># tqdm wrapper</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>                <span class="n">output_generator</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training: &quot;</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>            <span class="p">)</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>        <span class="c1"># iterate through</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>        <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>        <span class="n">stixel_specific_x_names</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>        <span class="k">for</span> <span class="n">ensemble_id</span><span class="p">,</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_generator</span><span class="p">):</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>            <span class="k">for</span> <span class="n">time_block</span> <span class="ow">in</span> <span class="n">ensemble</span><span class="p">:</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>                <span class="k">for</span> <span class="n">feature_tuple</span> <span class="ow">in</span> <span class="n">time_block</span><span class="p">:</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>                    <span class="k">if</span> <span class="n">feature_tuple</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>                    <span class="n">name</span> <span class="o">=</span> <span class="n">feature_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>                    <span class="n">model</span> <span class="o">=</span> <span class="n">feature_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>                    <span class="n">x_names</span> <span class="o">=</span> <span class="n">feature_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>                    <span class="n">model_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>                    <span class="n">stixel_specific_x_names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_names</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>        <span class="n">get_reusable_executor</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span> <span class="o">=</span> <span class="n">model_dict</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stixel_specific_x_names</span> <span class="o">=</span> <span class="n">stixel_specific_x_names</span> <span class="c1"># Do it at the end to avoid dictionary changes during the pickling</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>        <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>        <span class="n">y_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>        <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>        <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>        <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>    <span class="p">):</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fitting method</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><span class="sd">            X_train: Training variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a><span class="sd">            y_train: Training target. Can be either a pd.DataFrame object, a pd.Series object, a np.ndarray, or a string that indicate the path to the database (.duckdb or .parquet). It has to have indexes that match with the X_train.</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a><span class="sd">            ax: matplotlib Axes to add to</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a><span class="sd">            verbosty: whether to show progress bar. 0 for no and 1 for yes.</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a><span class="sd">            ax: matplotlib ax for adding grid plot on that.</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a><span class="sd">            n_jobs: multiprocessing thread count. Default the n_jobs of model object.</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a><span class="sd">            overwrite: overwrite files in lazy_loading_dir. If set to False and any file exists in lazy_loading_dir, an error will be raise.</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a><span class="sd">            temporal_window_prequery: Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a><span class="sd">            TypeError: X_train is not a type of pd.DataFrame</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a><span class="sd">            TypeError: y_train is not a type of np.ndarray or pd.DataFrame</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="c1"># Setup lazy_loading_dir and joblib_tmp_dir</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="o">=</span> <span class="n">initiate_lazy_loading_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span> <span class="c1"># run self._cleanup when the object is being garbage collected</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span> <span class="o">=</span> <span class="n">initiate_joblib_tmp_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="o">=</span> <span class="n">duckdb_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_mem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>            <span class="c1"># Input check</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">check_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">check_X_y_format_match</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>            <span class="n">check_X_train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>            <span class="n">check_y_train</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">check_X_y_indexes_match</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>            <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">store_x_names</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>            <span class="c1"># Quadtree            </span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>            <span class="c1"># stixel specific x_names list</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>            <span class="k">for</span> <span class="n">rm_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;model_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;stixel_specific_x_names&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm_target</span><span class="p">):</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm_target</span><span class="p">)</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>            <span class="c1"># Training</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SAC_training</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="p">)</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>        <span class="k">except</span><span class="p">:</span> <span class="c1"># Remove the entire lazy_loading_dir since it includes failed models in this case</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>            <span class="k">raise</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>        <span class="k">finally</span><span class="p">:</span> <span class="c1"># Remove the joblib_tmp_dir anyway</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">):</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stixel_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stixel</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A sub module of SAC prediction. Predict one stixel</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a><span class="sd">            stixel (pd.DataFrame): data joined with ensemble_df.</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a><span class="sd">            For a single stixel.</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a><span class="sd">            pd.DataFrame: the prediction result of this stixel</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>        <span class="k">if</span> <span class="s1">&#39;__index_level_0__&#39;</span> <span class="ow">in</span> <span class="n">stixel</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;__index_level_0__ should not apprear in the final training data!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stixel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>            <span class="k">return</span> <span class="kc">None</span> <span class="c1"># No data to predict</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>        <span class="n">unique_stixel_id</span> <span class="o">=</span> <span class="n">stixel</span><span class="p">[</span><span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>        <span class="n">model_x_names_tuple</span> <span class="o">=</span> <span class="n">get_model_and_stixel_specific_x_names</span><span class="p">(</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">,</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>            <span class="n">unique_stixel_id</span><span class="p">,</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stixel_specific_x_names</span><span class="p">,</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">,</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>        <span class="p">)</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>        <span class="k">if</span> <span class="n">model_x_names_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">predict_one_stixel</span><span class="p">(</span><span class="n">X_test_stixel</span><span class="o">=</span><span class="n">stixel</span><span class="p">,</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>                                  <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>                                  <span class="n">model_x_names_tuple</span><span class="o">=</span><span class="n">model_x_names_tuple</span><span class="p">,</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>                                  <span class="n">base_model_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_method</span><span class="p">,</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>                                  <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_prediction_param</span><span class="p">)</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>        <span class="k">if</span> <span class="n">pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>            <span class="k">return</span> <span class="n">pred</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">SAC_ensemble_predict</span><span class="p">(</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">single_ensemble_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A sub-module of SAC prediction function.</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a><span class="sd">        Predict only one ensemble.</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a><span class="sd">            single_ensemble_df (pd.DataFrame): ensemble data (model.ensemble_df)</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a><span class="sd">            data (pd.DataFrame, str): input covariates to predict</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a><span class="sd">            temporal_window_prequery (bool): Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a><span class="sd">            pd.DataFrame: Prediction result of one ensemble.</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>        <span class="c1"># Calculate the start indices for the sliding window</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>        <span class="n">start_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>        <span class="c1"># Initiate duckdb connection</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>        <span class="n">duckdb_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>        <span class="n">duckdb_config</span><span class="p">[</span><span class="s1">&#39;temp_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">duckdb_config</span><span class="p">[</span><span class="s1">&#39;temp_directory&#39;</span><span class="p">],</span> <span class="n">generate_random_saving_code</span><span class="p">())</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>        <span class="k">with</span> <span class="n">open_db_connection</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>            <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;data_df&quot;</span><span class="p">,</span> <span class="n">data_df</span><span class="p">)</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>            <span class="c1"># prediction, window by window</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>            <span class="n">window_prediction_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>            <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">start_indices</span><span class="p">:</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>                    <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>                        <span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> 
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>                        <span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="p">)</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>                        <span class="p">])</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>                    <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">][[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">]]</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>                    <span class="n">window_X_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">]</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">data_df</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>                    <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT __index_level_0__ FROM data_df WHERE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> AND </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>                    <span class="n">temporal_window_indexes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">temporal_window_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">])</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temporal_window_indexes_df&quot;</span><span class="p">,</span> <span class="n">temporal_window_indexes_df</span><span class="p">)</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>                    <span class="n">window_X_df</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a><span class="s2">                                            SELECT temporal_window_indexes_df.__index_level_0__, data_df.* EXCLUDE(__index_level_0__)</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a><span class="s2">                                            FROM data_df</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a><span class="s2">                                            JOIN temporal_window_indexes_df</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a><span class="s2">                                            ON data_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__;</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a><span class="s2">                                            &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">data_df</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>                    <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a><span class="s2">                                                       SELECT data_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">, data_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">, data_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">, data_df.__index_level_0__ </span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a><span class="s2">                                                       FROM data_df</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a><span class="s2">                                                       JOIN temporal_window_indexes_df</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a><span class="s2">                                                       ON data_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__;</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a><span class="s2">                                                       &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>                <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">transform_pred_set_to_STEM_quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span> <span class="n">window_X_df_indexes_only</span><span class="p">,</span> <span class="n">single_ensemble_df</span><span class="p">)</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>                <span class="n">window_single_ensemble_df</span> <span class="o">=</span> <span class="n">single_ensemble_df</span><span class="p">[</span><span class="n">single_ensemble_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_start&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">start</span><span class="p">]</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>                <span class="k">def</span><span class="w"> </span><span class="nf">find_belonged_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">):</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>                    <span class="n">this_stixel_point_indexes</span> <span class="o">=</span> <span class="n">st_indexes_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>                        <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_left_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_right_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_lower_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_upper_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>                    <span class="p">]</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a>                        <span class="n">X</span> <span class="o">=</span> <span class="n">X_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_stixel_point_indexes</span><span class="p">]</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyRelation</span><span class="p">):</span>      
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>                        <span class="n">this_stixel_point_indexes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">this_stixel_point_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">])</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;this_stixel_point_indexes_df&quot;</span><span class="p">,</span> <span class="n">this_stixel_point_indexes_df</span><span class="p">)</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;X_df&#39;</span><span class="p">,</span> <span class="n">X_df</span><span class="p">)</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a>                        <span class="n">X</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="s2">                                    SELECT X_df.* FROM X_df </span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a><span class="s2">                                    JOIN this_stixel_point_indexes_df</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a><span class="s2">                                    ON X_df.__index_level_0__ = this_stixel_point_indexes_df.__index_level_0__</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a><span class="s2">                                    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;this_stixel_point_indexes_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a>                        <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;X_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a>                        <span class="k">raise</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>                    <span class="k">return</span> <span class="n">X</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>                <span class="k">def</span><span class="w"> </span><span class="nf">find_belonged_points_and_predict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">):</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>                    <span class="n">X</span> <span class="o">=</span> <span class="n">find_belonged_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">)</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>                        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>                    <span class="n">X</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>                    <span class="n">X</span><span class="p">[</span><span class="s1">&#39;unique_stixel_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unique_stixel_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>                    <span class="c1"># X = X.sort_index() # To ensure the input dataframes for the two method (temporal_window_prequery or not) are the same so the tained base models are identical, at least with the same input data</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>                    <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>                    <span class="k">return</span> <span class="n">pred</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>                <span class="n">res</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>                    <span class="n">window_single_ensemble_df</span><span class="p">[</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>                        <span class="p">[</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>                            <span class="s2">&quot;ensemble_index&quot;</span><span class="p">,</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>                            <span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">,</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>                            <span class="s2">&quot;stixel_calibration_point_transformed_left_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>                            <span class="s2">&quot;stixel_calibration_point_transformed_right_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>                            <span class="s2">&quot;stixel_calibration_point_transformed_lower_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>                            <span class="s2">&quot;stixel_calibration_point_transformed_upper_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>                        <span class="p">]</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>                    <span class="p">]</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>                    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">,</span> <span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>                    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span> <span class="c1"># Explicitly select all the columns in the original df to include. To overcome the include_groups=True deprecation warning</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">find_belonged_points_and_predict</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="o">=</span><span class="n">window_X_df_indexes_only</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">window_X_df</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># although [&quot;ensemble_index&quot;, &quot;unique_stixel_id&quot;] will be passed into `find_belonged_points` due to `.pipe(lambda x: x[x.obj.columns])`, the output will not have them so we still set `as_index=True` in `groupby`</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>                <span class="p">)</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># If using as_index=False duing groupby, pandas will automatically generate a group indexing column, so drop the indexing of the new groups</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>                <span class="n">window_prediction_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">window_prediction_list</span><span class="p">]):</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>            <span class="n">ensemble_prediction</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">window_prediction_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>            <span class="n">ensemble_prediction</span> <span class="o">=</span> <span class="n">ensemble_prediction</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>            <span class="n">ensmeble_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">window_single_ensemble_df</span><span class="p">[</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No prediction for this ensemble: </span><span class="si">{</span><span class="n">ensmeble_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>            <span class="n">ensemble_prediction</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>        <span class="k">return</span> <span class="n">ensemble_prediction</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">SAC_predict</span><span class="p">(</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">ensemble_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;This function is a prediction function with SAC strategy:</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a><span class="sd">        Split (S), Apply(A), Combine (C). At ensemble level.</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a><span class="sd">        It is built on pandas `apply` method.</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a><span class="sd">            ensemble_df (pd.DataFrame): gridding information for all ensemble</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a><span class="sd">            data (pd.DataFrame, str): data</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a><span class="sd">            verbosity (int, optional): Defaults to 0.</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a><span class="sd">            n_jobs (int): number of processors for parallel computing</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a><span class="sd">            temporal_window_prequery (bool): Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a><span class="sd">            pd.DataFrame: prediction results.</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>        <span class="n">groups</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>        <span class="c1"># Parallel maker</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAC_ensemble_predict</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="o">=</span><span class="n">ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span> <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">mp_predict</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAC_ensemble_predict</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="o">=</span><span class="n">ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>                <span class="k">return</span> <span class="n">res</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>            <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span><span class="p">,</span> <span class="n">temp_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">mp_predict</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>        <span class="c1"># tqdm wrapper</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>                <span class="n">output_generator</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Predicting: &quot;</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>            <span class="p">)</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>        <span class="c1"># Prediction</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_generator</span><span class="p">]</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>        <span class="n">get_reusable_executor</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>                <span class="s2">&quot;All samples are not predictable based on current settings!</span><span class="se">\n</span><span class="s2">Try adjusting the &#39;points_lower_threshold&#39;, increase the grid size, or increase sample size!&quot;</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a>            <span class="p">)</span>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a>        <span class="n">pred</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">))</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>        <span class="k">return</span> <span class="n">pred</span>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_proba</span><span class="p">(</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>        <span class="n">X_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a>        <span class="n">return_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a>        <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a>        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a>        <span class="n">return_by_separate_ensembles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>        <span class="n">logit_agg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>        <span class="n">base_model_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a>        <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>        <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict probability</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a><span class="sd">            X_test (pd.DataFrame):</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a><span class="sd">                Testing variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a><span class="sd">            verbosity (int, optional):</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a><span class="sd">                show progress bar or not. Yes for 0, and No for other. Defaults to None, which set it as the verbosity of the main model class.</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a><span class="sd">            return_std (bool, optional):</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a><span class="sd">                Whether return the standard deviation among ensembles. Defaults to False.</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a><span class="sd">            n_jobs (Union[int, None], optional):</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a><span class="sd">                Number of processes used in this task. If None, use the self.n_jobs. Default to 1.</span>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a><span class="sd">                I do not recommend setting value larger than 1.</span>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a><span class="sd">                In practice, multi-processing seems to slow down the process instead of speeding up.</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a><span class="sd">                Could be more practical with large amount of data.</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a><span class="sd">                Still in experiment.</span>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a><span class="sd">            aggregation (str, optional):</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a><span class="sd">                &#39;mean&#39; or &#39;median&#39; for aggregation method across ensembles.</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a><span class="sd">            return_by_separate_ensembles (bool, optional):</span>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a><span class="sd">                Experimental function. return not by aggregation, but by separate ensembles.</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a><span class="sd">            logit_agg:</span>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a><span class="sd">                Whether to use logit aggregation for the classification task. Most likely only used when you are predicting &quot;real&quot; calibrated probability. If True, the model is averaging the probability prediction estimated by all ensembles in logit scale, and then back-tranforms it to probability scale. It&#39;s recommended to be jointly used with the CalibratedClassifierCV class in sklearn as a wrapper of the classifier to estimate the calibrated probability. Default is False, but can be set to true for &quot;real&quot; probability averaging.</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a><span class="sd">            base_model_method:</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a><span class="sd">                The name of the prediction method for base models. If None, `predict` or `predict_proba` will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Notice that dummy model will still predict 0, so the ensemble-aggregated result is still an average of zeros and your special prediction function output. Therefore, it may only make sense if your special prediction function predicts 0 as the absense/control value. Defaults to None.</span>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a><span class="sd">            temporal_window_prequery:</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a><span class="sd">                Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a><span class="sd">            base_model_prediction_param:</span>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a><span class="sd">                Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={&#39;n_jobs&#39;:1} (set n_jobs=1 for the *base model*). </span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a><span class="sd">            TypeError:</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a><span class="sd">                X_test is not of type pd.DataFrame or str.</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a><span class="sd">            ValueError:</span>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a><span class="sd">                aggregation is not in [&#39;mean&#39;,&#39;median&#39;].</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a><span class="sd">            predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a><span class="sd">            If return_by_separate_ensembles == True:</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a><span class="sd">                Return numpy.ndarray of shape (n_samples, n_ensembles)</span>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a>        <span class="n">check_X_test</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a>        <span class="n">check_prediction_aggregation</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span>
<a id="__codelineno-0-1075" name="__codelineno-0-1075"></a>        <span class="n">return_by_separate_ensembles</span><span class="p">,</span> <span class="n">return_std</span> <span class="o">=</span> <span class="n">check_prediction_return</span><span class="p">(</span><span class="n">return_by_separate_ensembles</span><span class="p">,</span> <span class="n">return_std</span><span class="p">)</span>
<a id="__codelineno-0-1076" name="__codelineno-0-1076"></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="n">check_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span>
<a id="__codelineno-0-1077" name="__codelineno-0-1077"></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_model_method</span> <span class="o">=</span> <span class="n">base_model_method</span>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_model_prediction_param</span> <span class="o">=</span> <span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>
<a id="__codelineno-0-1081" name="__codelineno-0-1081"></a>        <span class="c1"># Setup joblib_tmp_dir</span>
<a id="__codelineno-0-1082" name="__codelineno-0-1082"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span> <span class="o">=</span> <span class="n">initiate_joblib_tmp_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-1083" name="__codelineno-0-1083"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="o">=</span> <span class="n">duckdb_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_mem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>            <span class="c1"># predict</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAC_predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>        <span class="k">except</span><span class="p">:</span> <span class="c1"># Remove the entire lazy_loading_dir since it includes failed models</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>            <span class="k">raise</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>        <span class="k">finally</span><span class="p">:</span> <span class="c1"># Remove the joblib_tmp_dir anyway</span>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">):</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a>        <span class="c1"># Get X_test indexes</span>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a>            <span class="n">X_test_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a>            <span class="k">with</span> <span class="n">open_db_connection</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">X_test_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a>                <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;X_test_df&quot;</span><span class="p">,</span> <span class="n">X_test_df</span><span class="p">)</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a>                <span class="n">X_test_indexes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT __index_level_0__ FROM X_test_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a>        <span class="k">else</span><span class="p">:</span> 
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a>            <span class="k">raise</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a>        <span class="c1"># Experimental Function</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a>        <span class="k">if</span> <span class="n">return_by_separate_ensembles</span><span class="p">:</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a>            <span class="n">new_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_test_indexes</span><span class="p">)})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a>            <span class="n">new_res</span> <span class="o">=</span> <span class="n">new_res</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>            <span class="k">return</span> <span class="n">new_res</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a>        <span class="c1"># Transform to logit space if classification:</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">==</span><span class="s1">&#39;classification&#39;</span> <span class="ow">and</span> <span class="n">logit_agg</span><span class="p">:</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>            <span class="k">for</span> <span class="n">col_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a>                <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col_index</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a>                <span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">prob</span><span class="p">))</span> <span class="c1"># logit space</span>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a>            <span class="c1"># Aggregate</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a>            <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>                <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># mean of all grid model that predicts this stixel</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>            <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>                <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>            <span class="c1"># Transform back to 0-1:</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>            <span class="n">res_mean</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">res_mean</span><span class="p">))</span> <span class="c1"># notice that the res_std is not transformed!</span>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a>            <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res_mean</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res_mean</span><span class="o">&lt;=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>            <span class="c1"># don&#39;t need to aggregate at logit scale</span>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>            <span class="c1"># Aggregate</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>            <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>                <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># mean of all grid model that predicts this stixel</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>            <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>                <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>        <span class="n">res_std</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a>        <span class="c1"># Nan count</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a>        <span class="n">res_nan_count</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>        <span class="n">pred_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span> <span class="o">-</span> <span class="n">res_nan_count</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_ensemble_required</span><span class="p">,</span> <span class="n">res_mean</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>        <span class="p">)</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a>        <span class="n">pred_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span> <span class="o">-</span> <span class="n">res_nan_count</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_ensemble_required</span><span class="p">,</span> <span class="n">res_std</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-1143" name="__codelineno-0-1143"></a>        <span class="p">)</span>
<a id="__codelineno-0-1144" name="__codelineno-0-1144"></a>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">res_mean</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s2">&quot;pred_mean&quot;</span><span class="p">:</span> <span class="n">pred_mean</span><span class="p">,</span> <span class="s2">&quot;pred_std&quot;</span><span class="p">:</span> <span class="n">pred_std</span><span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>            <span class="s2">&quot;index&quot;</span>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a>        <span class="p">)</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a>        <span class="c1"># Preparing output (formatting)</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a>        <span class="n">new_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_test_indexes</span><span class="p">)})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a>        <span class="n">new_res</span> <span class="o">=</span> <span class="n">new_res</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a>        <span class="n">nan_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a>        <span class="n">nan_frac</span> <span class="o">=</span> <span class="n">nan_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">nan_frac</span><span class="si">}</span><span class="s2">% points (</span><span class="si">{</span><span class="n">nan_count</span><span class="si">}</span><span class="s2"> points) falling out of predictable range.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a>        <span class="k">if</span> <span class="n">return_std</span><span class="p">:</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">==</span><span class="s1">&#39;classification&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">-</span><span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>                <span class="k">return</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">==</span><span class="s1">&#39;classification&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">-</span><span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a>                <span class="k">return</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a>        <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a>        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a>        <span class="n">return_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a>        <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a>        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a>        <span class="n">return_by_separate_ensembles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a>        <span class="n">logit_agg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a>        <span class="n">base_model_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a>        <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a>        <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a>        <span class="k">pass</span>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">eval_STEM_res</span><span class="p">(</span>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a>        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1189" name="__codelineno-0-1189"></a>        <span class="n">y_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a>        <span class="n">y_pred</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a>        <span class="n">cls_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluation using multiple metrics</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a><span class="sd">        Classification metrics used:</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a><span class="sd">        1. AUC</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a><span class="sd">        2. Cohen&#39;s Kappa</span>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a><span class="sd">        3. F1</span>
<a id="__codelineno-0-1199" name="__codelineno-0-1199"></a><span class="sd">        4. precision</span>
<a id="__codelineno-0-1200" name="__codelineno-0-1200"></a><span class="sd">        5. recall</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a><span class="sd">        6. average precision</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a><span class="sd">        Regression metrics used:</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a><span class="sd">        1. spearman&#39;s r</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a><span class="sd">        2. peason&#39;s r</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a><span class="sd">        3. R2</span>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a><span class="sd">        4. mean absolute error (MAE)</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a><span class="sd">        5. mean squared error (MSE)</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a><span class="sd">        6. poisson deviance explained (PDE)</span>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a><span class="sd">            task (str):</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a><span class="sd">                one of &#39;regression&#39;, &#39;classification&#39; or &#39;hurdle&#39;.</span>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a><span class="sd">            y_test (Union[pd.Series, np.ndarray]):</span>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a><span class="sd">                y true</span>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a><span class="sd">            y_pred (Union[pd.Series, np.ndarray]):</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a><span class="sd">                y predicted</span>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a><span class="sd">            cls_threshold (Union[float, None], optional):</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a><span class="sd">                Cutting threshold for the classification.</span>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a><span class="sd">                Values above cls_threshold will be labeled as 1 and 0 otherwise.</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a><span class="sd">                Defaults to None (0.5 for classification and 0 for hurdle).</span>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a><span class="sd">            AttributeError: task not one of &#39;regression&#39;, &#39;classification&#39; or &#39;hurdle&#39;.</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a><span class="sd">            dict: dictionary containing the metric names and their values.</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>        <span class="k">if</span> <span class="n">task</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span> <span class="s2">&quot;classification&quot;</span><span class="p">,</span> <span class="s2">&quot;hurdle&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a>            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a>                <span class="sa">f</span><span class="s2">&quot;task type must be one of &#39;regression&#39;, &#39;classification&#39;, or &#39;hurdle&#39;! Now it is </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a>            <span class="p">)</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a>        <span class="k">if</span> <span class="n">cls_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>            <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>                <span class="n">cls_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>            <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;hurdle&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>                <span class="n">cls_threshold</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>        <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>            <span class="n">auc</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">average_precision</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;y_true&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a>
<a id="__codelineno-0-1246" name="__codelineno-0-1246"></a>            <span class="n">y_test_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span> <span class="o">&gt;</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a>            <span class="n">y_pred_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span> <span class="o">&gt;</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_pred_b</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a>                <span class="n">auc</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">average_precision</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a>                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">))</span> <span class="c1"># AUC can be calculated with probability</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>                <span class="n">kappa</span> <span class="o">=</span> <span class="n">cohen_kappa_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a>                <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">)</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>                <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">)</span>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a>                <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">)</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a>                <span class="n">average_precision</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">)</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;y_true&quot;</span><span class="p">:</span> <span class="n">y_test</span><span class="p">,</span> <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a>            <span class="n">s_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">))</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a>            <span class="n">p_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">))</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a>            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>            <span class="n">MAE</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a>            <span class="n">MSE</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a>                <span class="n">poisson_deviance_explained</span> <span class="o">=</span> <span class="n">d2_tweedie_score</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PED estimation fail: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a>                <span class="n">poisson_deviance_explained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a>            <span class="n">s_r</span><span class="p">,</span> <span class="n">p_r</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">MAE</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span> <span class="n">poisson_deviance_explained</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>            <span class="s2">&quot;AUC&quot;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a>            <span class="s2">&quot;kappa&quot;</span><span class="p">:</span> <span class="n">kappa</span><span class="p">,</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>            <span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a>            <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a>            <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a>            <span class="s2">&quot;average_precision&quot;</span><span class="p">:</span> <span class="n">average_precision</span><span class="p">,</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>            <span class="s2">&quot;Spearman_r&quot;</span><span class="p">:</span> <span class="n">s_r</span><span class="p">,</span>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a>            <span class="s2">&quot;Pearson_r&quot;</span><span class="p">:</span> <span class="n">p_r</span><span class="p">,</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a>            <span class="s2">&quot;R2&quot;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a>            <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="n">MAE</span><span class="p">,</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>            <span class="s2">&quot;MSE&quot;</span><span class="p">:</span> <span class="n">MSE</span><span class="p">,</span>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a>            <span class="s2">&quot;poisson_deviance_explained&quot;</span><span class="p">:</span> <span class="n">poisson_deviance_explained</span><span class="p">,</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a>        <span class="p">}</span>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine predicting and evaluating in one method</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a><span class="sd">            X_test (pd.DataFrame): Testing variables</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a><span class="sd">            y_test (Union[pd.Series, np.ndarray]): y true</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a><span class="sd">            dict: dictionary containing the metric names and their values.</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>        <span class="n">score_dict</span> <span class="o">=</span> <span class="n">AdaSTEM</span><span class="o">.</span><span class="n">eval_STEM_res</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_dict</span> <span class="o">=</span> <span class="n">score_dict</span>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_dict</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_feature_importances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A method to generate feature importance values for each stixel.</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a><span class="sd">        feature importances are saved in self.feature_importances_.</span>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a><span class="sd">        Attribute dependence:</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a><span class="sd">            1. self.ensemble_df</span>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a><span class="sd">            2. self.model_dict</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a><span class="sd">            3. self.stixel_specific_x_names</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a><span class="sd">            4. The input base model should have attribute `feature_importances_`</span>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>        <span class="c1"># generate feature importance dict</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>        <span class="n">feature_importance_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>        <span class="k">for</span> <span class="n">ensemble_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a>            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ensemble_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">[</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ensemble_id</span><span class="p">)</span> <span class="o">&amp;</span>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s2">&quot;stixel_checklist_count&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span><span class="p">)</span>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a>                <span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a>                <span class="k">if</span> <span class="n">ensemble_row</span><span class="p">[</span><span class="s2">&quot;stixel_checklist_count&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span><span class="p">:</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a>                    <span class="n">stixel_index</span> <span class="o">=</span> <span class="n">ensemble_row</span><span class="p">[</span><span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a>                    <span class="n">the_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stixel_index</span><span class="si">}</span><span class="s2">_model&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a>                    <span class="n">x_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_specific_x_names</span><span class="p">[</span><span class="n">stixel_index</span><span class="p">]</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">the_model</span><span class="p">,</span> <span class="n">dummy_model1</span><span class="p">):</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>                        <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">)))</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">the_model</span><span class="p">,</span> <span class="n">Hurdle</span><span class="p">):</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a>                        <span class="k">if</span> <span class="s2">&quot;feature_importances_&quot;</span> <span class="ow">in</span> <span class="n">the_model</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">():</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>                            <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_names</span><span class="p">,</span> <span class="n">the_model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">the_model</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span> <span class="n">dummy_model1</span><span class="p">):</span>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>                                <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">)))</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>                            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>                                <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_names</span><span class="p">,</span> <span class="n">the_model</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>                        <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_names</span><span class="p">,</span> <span class="n">the_model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>                    <span class="n">importance_dict</span><span class="p">[</span><span class="s2">&quot;stixel_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stixel_index</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>                    <span class="n">feature_importance_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">importance_dict</span><span class="p">)</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feature_importances_</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">feature_importance_list</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;stixel_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>        <span class="p">)</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">assign_feature_importances_by_points</span><span class="p">(</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>        <span class="n">Sample_ST_df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a>        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a>        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a>        <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a>        <span class="n">assign_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">assign_points_to_one_ensemble</span><span class="p">,</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign feature importance to the input spatio-temporal points</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a><span class="sd">            Sample_ST_df (Union[pd.DataFrame, None], optional):</span>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a><span class="sd">                Dataframe that indicate the spatio-temporal points of interest.</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a><span class="sd">                Must contain `self.Spatio1`, `self.Spatio2`, and `self.Temporal1` in columns.</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a><span class="sd">                If None, the resolution will be:</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a><span class="sd">                | variable|values|</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a><span class="sd">                |---------|--------|</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a><span class="sd">                |Spatio_var1|np.arange(-180,180,1)|</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a><span class="sd">                |Spatio_var2|np.arange(-90,90,1)|</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a><span class="sd">                |Temporal_var1|np.arange(1,366,7)|</span>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a><span class="sd">            verbosity (Union[None, int], optional):</span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a><span class="sd">                0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a><span class="sd">            aggregation (str, optional):</span>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a><span class="sd">                One of &#39;mean&#39; and &#39;median&#39; to aggregate feature importance across ensembles.</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a><span class="sd">            n_jobs (Union[int, None], optional):</span>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a><span class="sd">                Number of processes used in this task. If None, use the self.n_jobs. Default to 1.</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a><span class="sd">            NameError:</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a><span class="sd">                feature_importances_ attribute is not calculated. Try model.calculate_feature_importances() first.</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a><span class="sd">            ValueError:</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a><span class="sd">                f&#39;aggregation not one of [\&#39;mean\&#39;,\&#39;median\&#39;].&#39;</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a><span class="sd">            KeyError:</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a><span class="sd">                One of [`self.Spatio1`, `self.Spatio2`, `self.Temporal1`] not found in `Sample_ST_df.columns`</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a><span class="sd">            DataFrame with feature importance assigned.</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a>        <span class="c1">#</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="n">check_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a>        <span class="n">check_prediction_aggregation</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>        <span class="c1">#</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a>        <span class="k">if</span> <span class="s2">&quot;feature_importances_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a>                <span class="s2">&quot;feature_importances_ attribute is not calculated. Try model.calculate_feature_importances() first.&quot;</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>            <span class="p">)</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a>        <span class="c1">#</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>        <span class="k">if</span> <span class="n">Sample_ST_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>            <span class="n">Spatio_var1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a>            <span class="n">Spatio_var2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>            <span class="n">Temporal_var1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>            <span class="n">new_Spatio_var1</span><span class="p">,</span> <span class="n">new_Spatio_var2</span><span class="p">,</span> <span class="n">new_Temporal_var1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Spatio_var1</span><span class="p">,</span> <span class="n">Spatio_var2</span><span class="p">,</span> <span class="n">Temporal_var1</span><span class="p">)</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a>            <span class="n">Sample_ST_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a>                <span class="p">{</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">:</span> <span class="n">new_Temporal_var1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">:</span> <span class="n">new_Spatio_var1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">:</span> <span class="n">new_Spatio_var2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>                <span class="p">}</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>            <span class="p">)</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>            <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]:</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Sample_ST_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> not found in Sample_ST_df.columns&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>        <span class="n">partial_assign_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>            <span class="n">assign_function</span><span class="p">,</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>            <span class="n">ensemble_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>            <span class="n">Sample_ST_df</span><span class="o">=</span><span class="n">Sample_ST_df</span><span class="p">,</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>            <span class="n">Temporal1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>            <span class="n">Spatio1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>            <span class="n">Spatio2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>            <span class="n">feature_importances_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>        <span class="p">)</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>        <span class="c1"># assign input spatio-temporal points to stixels</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>            <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span><span class="p">,</span> <span class="n">temp_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">partial_assign_func</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">)))</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>                <span class="n">output_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">output_generator</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Querying ensembles: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>            <span class="n">round_res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_generator</span><span class="p">]</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>            <span class="n">iter_func_</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>                <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Querying ensembles: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>                <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">)</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>            <span class="p">)</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>            <span class="n">round_res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">partial_assign_func</span><span class="p">(</span><span class="n">ensemble_count</span><span class="p">)</span> <span class="k">for</span> <span class="n">ensemble_count</span> <span class="ow">in</span> <span class="n">iter_func_</span><span class="p">]</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>        <span class="n">round_res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">round_res_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>        <span class="k">del</span> <span class="n">round_res_list</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>        <span class="n">ensemble_available_count</span> <span class="o">=</span> <span class="n">round_res_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sample_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>        <span class="c1"># Only points with more than self.min_ensemble_required ensembles available are used</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>        <span class="n">usable_sample</span> <span class="o">=</span> <span class="n">ensemble_available_count</span><span class="p">[</span><span class="n">ensemble_available_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_ensemble_required</span><span class="p">]</span>  <span class="c1">#</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>        <span class="n">round_res_df</span> <span class="o">=</span> <span class="n">round_res_df</span><span class="p">[</span><span class="n">round_res_df</span><span class="p">[</span><span class="s2">&quot;sample_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">usable_sample</span><span class="o">.</span><span class="n">index</span><span class="p">))]</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>        <span class="c1"># aggregate across ensembles</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>            <span class="n">mean_feature_importances_across_ensembles</span> <span class="o">=</span> <span class="n">round_res_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sample_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>            <span class="n">mean_feature_importances_across_ensembles</span> <span class="o">=</span> <span class="n">round_res_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sample_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_temporal_to_train</span><span class="p">:</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>            <span class="n">mean_feature_importances_across_ensembles</span> <span class="o">=</span> <span class="n">mean_feature_importances_across_ensembles</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_predictor&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>            <span class="p">)</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>        <span class="n">out_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Sample_ST_df</span><span class="p">,</span> <span class="n">mean_feature_importances_across_ensembles</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>        <span class="k">return</span> <span class="n">out_</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">tar_gz_file</span><span class="p">,</span> <span class="n">new_lazy_loading_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remove_original_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>        <span class="k">if</span> <span class="n">new_lazy_loading_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>            <span class="n">new_lazy_loading_path</span> <span class="o">=</span> <span class="n">initiate_lazy_loading_dir</span><span class="p">(</span><span class="n">new_lazy_loading_path</span><span class="p">)</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a>        <span class="n">new_lazy_loading_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">new_lazy_loading_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)))</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>        <span class="n">file</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_gz_file</span><span class="p">)</span> 
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>        <span class="n">file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">new_lazy_loading_path</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">data_filter</span><span class="p">)</span> 
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lazy_loading_path</span><span class="p">,</span> <span class="s1">&#39;model.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a>        <span class="n">model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">lazy_loading_dir</span><span class="o">=</span><span class="n">new_lazy_loading_path</span><span class="p">)</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>        <span class="n">model</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a>        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">lazy_loading</span><span class="p">:</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a>            <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">model_dict</span><span class="p">:</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">],</span> <span class="n">LazyLoadingEstimator</span><span class="p">):</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>                    <span class="n">model</span><span class="o">.</span><span class="n">model_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">dump_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lazy_loading_path</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;ensemble_&#39;</span> <span class="o">+</span> <span class="n">model_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>        <span class="k">if</span> <span class="n">remove_original_file</span><span class="p">:</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tar_gz_file</span><span class="p">)</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>        <span class="k">return</span> <span class="n">model</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tar_gz_file</span><span class="p">,</span> <span class="n">remove_temporary_file</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>        <span class="c1"># dump the main object</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>        <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">,</span> <span class="s1">&#39;model.pkl&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>        <span class="c1"># collect files recursively (deterministic order)</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>        <span class="k">for</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dns</span><span class="p">,</span> <span class="n">fns</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>            <span class="n">dns</span><span class="o">.</span><span class="n">sort</span><span class="p">();</span> <span class="n">fns</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a>        <span class="n">it</span> <span class="o">=</span> <span class="n">files</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tqdm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>            <span class="n">it</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Archiving&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_gz_file</span><span class="p">,</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="n">compresslevel</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a>            <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a>                <span class="n">arcname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a>                <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">arcname</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a>        <span class="k">if</span> <span class="n">remove_temporary_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup</span><span class="p">(</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a>        <span class="k">if</span> <span class="n">lazy_loading_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.SAC_ensemble_predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">SAC_ensemble_predict</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>A sub-module of SAC prediction function.
Predict only one ensemble.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>single_ensemble_df</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>ensemble data (model.ensemble_df)</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>data</code></b>
              (<code>(<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>)</code>)
          –
          <div class="doc-md-description">
            <p>input covariates to predict</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_window_prequery</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</p>
          </div>
        </li>
    </ul>
        <p>Returns:
    pd.DataFrame: Prediction result of one ensemble.</p>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span>
<span class="normal"><a href="#__codelineno-0-913">913</a></span>
<span class="normal"><a href="#__codelineno-0-914">914</a></span>
<span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span>
<span class="normal"><a href="#__codelineno-0-932">932</a></span>
<span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span>
<span class="normal"><a href="#__codelineno-0-935">935</a></span>
<span class="normal"><a href="#__codelineno-0-936">936</a></span>
<span class="normal"><a href="#__codelineno-0-937">937</a></span>
<span class="normal"><a href="#__codelineno-0-938">938</a></span>
<span class="normal"><a href="#__codelineno-0-939">939</a></span>
<span class="normal"><a href="#__codelineno-0-940">940</a></span>
<span class="normal"><a href="#__codelineno-0-941">941</a></span>
<span class="normal"><a href="#__codelineno-0-942">942</a></span>
<span class="normal"><a href="#__codelineno-0-943">943</a></span>
<span class="normal"><a href="#__codelineno-0-944">944</a></span>
<span class="normal"><a href="#__codelineno-0-945">945</a></span>
<span class="normal"><a href="#__codelineno-0-946">946</a></span>
<span class="normal"><a href="#__codelineno-0-947">947</a></span>
<span class="normal"><a href="#__codelineno-0-948">948</a></span>
<span class="normal"><a href="#__codelineno-0-949">949</a></span>
<span class="normal"><a href="#__codelineno-0-950">950</a></span>
<span class="normal"><a href="#__codelineno-0-951">951</a></span>
<span class="normal"><a href="#__codelineno-0-952">952</a></span>
<span class="normal"><a href="#__codelineno-0-953">953</a></span>
<span class="normal"><a href="#__codelineno-0-954">954</a></span>
<span class="normal"><a href="#__codelineno-0-955">955</a></span>
<span class="normal"><a href="#__codelineno-0-956">956</a></span>
<span class="normal"><a href="#__codelineno-0-957">957</a></span>
<span class="normal"><a href="#__codelineno-0-958">958</a></span>
<span class="normal"><a href="#__codelineno-0-959">959</a></span>
<span class="normal"><a href="#__codelineno-0-960">960</a></span>
<span class="normal"><a href="#__codelineno-0-961">961</a></span>
<span class="normal"><a href="#__codelineno-0-962">962</a></span>
<span class="normal"><a href="#__codelineno-0-963">963</a></span>
<span class="normal"><a href="#__codelineno-0-964">964</a></span>
<span class="normal"><a href="#__codelineno-0-965">965</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-846" name="__codelineno-0-846"></a><span class="k">def</span><span class="w"> </span><span class="nf">SAC_ensemble_predict</span><span class="p">(</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">single_ensemble_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A sub-module of SAC prediction function.</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a><span class="sd">    Predict only one ensemble.</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a><span class="sd">        single_ensemble_df (pd.DataFrame): ensemble data (model.ensemble_df)</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a><span class="sd">        data (pd.DataFrame, str): input covariates to predict</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a><span class="sd">        temporal_window_prequery (bool): Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a><span class="sd">        pd.DataFrame: Prediction result of one ensemble.</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>    <span class="c1"># Calculate the start indices for the sliding window</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>    <span class="n">start_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>    <span class="c1"># Initiate duckdb connection</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>    <span class="n">duckdb_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>    <span class="n">duckdb_config</span><span class="p">[</span><span class="s1">&#39;temp_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">duckdb_config</span><span class="p">[</span><span class="s1">&#39;temp_directory&#39;</span><span class="p">],</span> <span class="n">generate_random_saving_code</span><span class="p">())</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>    <span class="k">with</span> <span class="n">open_db_connection</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;data_df&quot;</span><span class="p">,</span> <span class="n">data_df</span><span class="p">)</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>        <span class="c1"># prediction, window by window</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>        <span class="n">window_prediction_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>        <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">start_indices</span><span class="p">:</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>                <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>                    <span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> 
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>                    <span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="p">)</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>                    <span class="p">])</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>                <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">][[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">]]</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>                <span class="n">window_X_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">]</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">data_df</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>                <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT __index_level_0__ FROM data_df WHERE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> AND </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>                <span class="n">temporal_window_indexes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">temporal_window_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">])</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>                <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temporal_window_indexes_df&quot;</span><span class="p">,</span> <span class="n">temporal_window_indexes_df</span><span class="p">)</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>                <span class="n">window_X_df</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a><span class="s2">                                        SELECT temporal_window_indexes_df.__index_level_0__, data_df.* EXCLUDE(__index_level_0__)</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a><span class="s2">                                        FROM data_df</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a><span class="s2">                                        JOIN temporal_window_indexes_df</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a><span class="s2">                                        ON data_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__;</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a><span class="s2">                                        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">data_df</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>                <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a><span class="s2">                                                   SELECT data_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">, data_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">, data_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">, data_df.__index_level_0__ </span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a><span class="s2">                                                   FROM data_df</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a><span class="s2">                                                   JOIN temporal_window_indexes_df</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a><span class="s2">                                                   ON data_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__;</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a><span class="s2">                                                   &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>            <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">transform_pred_set_to_STEM_quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span> <span class="n">window_X_df_indexes_only</span><span class="p">,</span> <span class="n">single_ensemble_df</span><span class="p">)</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>            <span class="n">window_single_ensemble_df</span> <span class="o">=</span> <span class="n">single_ensemble_df</span><span class="p">[</span><span class="n">single_ensemble_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_start&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">start</span><span class="p">]</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">find_belonged_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">):</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>                <span class="n">this_stixel_point_indexes</span> <span class="o">=</span> <span class="n">st_indexes_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>                    <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_left_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_right_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_lower_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_upper_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>                <span class="p">]</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a>                    <span class="n">X</span> <span class="o">=</span> <span class="n">X_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_stixel_point_indexes</span><span class="p">]</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyRelation</span><span class="p">):</span>      
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>                    <span class="n">this_stixel_point_indexes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">this_stixel_point_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">])</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;this_stixel_point_indexes_df&quot;</span><span class="p">,</span> <span class="n">this_stixel_point_indexes_df</span><span class="p">)</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;X_df&#39;</span><span class="p">,</span> <span class="n">X_df</span><span class="p">)</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a>                    <span class="n">X</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="s2">                                SELECT X_df.* FROM X_df </span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a><span class="s2">                                JOIN this_stixel_point_indexes_df</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a><span class="s2">                                ON X_df.__index_level_0__ = this_stixel_point_indexes_df.__index_level_0__</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a><span class="s2">                                &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;this_stixel_point_indexes_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;X_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a>                    <span class="k">raise</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>                <span class="k">return</span> <span class="n">X</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">find_belonged_points_and_predict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">):</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>                <span class="n">X</span> <span class="o">=</span> <span class="n">find_belonged_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">)</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>                    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>                <span class="n">X</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>                <span class="n">X</span><span class="p">[</span><span class="s1">&#39;unique_stixel_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unique_stixel_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>                <span class="c1"># X = X.sort_index() # To ensure the input dataframes for the two method (temporal_window_prequery or not) are the same so the tained base models are identical, at least with the same input data</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>                <span class="k">return</span> <span class="n">pred</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>                <span class="n">window_single_ensemble_df</span><span class="p">[</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>                    <span class="p">[</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>                        <span class="s2">&quot;ensemble_index&quot;</span><span class="p">,</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>                        <span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">,</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>                        <span class="s2">&quot;stixel_calibration_point_transformed_left_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>                        <span class="s2">&quot;stixel_calibration_point_transformed_right_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>                        <span class="s2">&quot;stixel_calibration_point_transformed_lower_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>                        <span class="s2">&quot;stixel_calibration_point_transformed_upper_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>                    <span class="p">]</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>                <span class="p">]</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">,</span> <span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>                <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span> <span class="c1"># Explicitly select all the columns in the original df to include. To overcome the include_groups=True deprecation warning</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">find_belonged_points_and_predict</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="o">=</span><span class="n">window_X_df_indexes_only</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">window_X_df</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># although [&quot;ensemble_index&quot;, &quot;unique_stixel_id&quot;] will be passed into `find_belonged_points` due to `.pipe(lambda x: x[x.obj.columns])`, the output will not have them so we still set `as_index=True` in `groupby`</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>            <span class="p">)</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># If using as_index=False duing groupby, pandas will automatically generate a group indexing column, so drop the indexing of the new groups</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>            <span class="n">window_prediction_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">window_prediction_list</span><span class="p">]):</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>        <span class="n">ensemble_prediction</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">window_prediction_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>        <span class="n">ensemble_prediction</span> <span class="o">=</span> <span class="n">ensemble_prediction</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>        <span class="n">ensmeble_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">window_single_ensemble_df</span><span class="p">[</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No prediction for this ensemble: </span><span class="si">{</span><span class="n">ensmeble_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>        <span class="n">ensemble_prediction</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>    <span class="k">return</span> <span class="n">ensemble_prediction</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.SAC_ensemble_training" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">SAC_ensemble_training</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>A sub-module of SAC training function.
Train only one ensemble.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>single_ensemble_df</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>ensemble data (from model.ensemble_df)</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>X_train</code></b>
              (<code>(<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>)</code>)
          –
          <div class="doc-md-description">
            <p>input covariates to train</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>y_train</code></b>
              (<code>(<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>)</code>)
          –
          <div class="doc-md-description">
            <p>input ground truth labels</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_window_prequery</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-531" name="__codelineno-0-531"></a><span class="k">def</span><span class="w"> </span><span class="nf">SAC_ensemble_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">single_ensemble_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>                          <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A sub-module of SAC training function.</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="sd">    Train only one ensemble.</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="sd">        single_ensemble_df (pd.DataFrame): ensemble data (from model.ensemble_df)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">        X_train (pd.DataFrame, str): input covariates to train</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">        y_train (pd.DataFrame, str): input ground truth labels</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="sd">        temporal_window_prequery (bool): Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>    <span class="c1"># Calculate the start indices for the sliding window</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="n">unique_start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>    <span class="c1"># Initiate duckdb connection</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>    <span class="n">duckdb_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="n">duckdb_config</span><span class="p">[</span><span class="s1">&#39;temp_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">duckdb_config</span><span class="p">[</span><span class="s1">&#39;temp_directory&#39;</span><span class="p">],</span> <span class="n">generate_random_saving_code</span><span class="p">())</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="k">with</span> <span class="n">open_both_Xy_db_connection</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">y_train_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;X_train_df&quot;</span><span class="p">,</span> <span class="n">X_train_df</span><span class="p">)</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;y_train_df&quot;</span><span class="p">,</span> <span class="n">y_train_df</span><span class="p">)</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>        <span class="c1"># Get indexes and total_length</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>            <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_train_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>            <span class="n">indexes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT __index_level_0__ FROM X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>        <span class="n">total_length</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="c1"># training, window by window</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span><span class="p">:</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>            <span class="n">bootstrap_random_state</span> <span class="o">=</span> <span class="n">single_ensemble_df</span><span class="p">[</span><span class="s1">&#39;bootstrap_random_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">bootstrap_random_state</span><span class="p">)</span>  <span class="c1"># NumPy&#39;s random generator</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="n">bootstrap_indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">total_length</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Full bootstrap sample</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="n">bootstrap_indices</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Place holder</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>        <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">unique_start_indices</span><span class="p">:</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>            <span class="c1"># Select the temporal window</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>                <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_train_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>                    <span class="p">(</span><span class="n">X_train_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> 
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>                    <span class="p">(</span><span class="n">X_train_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="p">)</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                    <span class="p">])</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                <span class="c1"># Apply bootstrap</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">bootstrap_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bootstrap_indices</span><span class="p">,</span> <span class="n">temporal_window_indexes</span><span class="p">)]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span> <span class="k">else</span> <span class="n">temporal_window_indexes</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">][[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">]]</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                <span class="n">window_X_df</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">]</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">X_train_df</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                <span class="n">window_y_df</span> <span class="o">=</span> <span class="n">y_train_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temporal_window_indexes</span><span class="p">]</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">y_train_df</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT __index_level_0__ FROM X_train_df WHERE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> AND </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                <span class="c1"># Apply bootstrap</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>                <span class="n">temporal_window_indexes</span> <span class="o">=</span> <span class="n">bootstrap_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bootstrap_indices</span><span class="p">,</span> <span class="n">temporal_window_indexes</span><span class="p">)]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span> <span class="k">else</span> <span class="n">temporal_window_indexes</span>                
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>                <span class="n">temporal_window_indexes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">temporal_window_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">])</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>                <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temporal_window_indexes_df&quot;</span><span class="p">,</span> <span class="n">temporal_window_indexes_df</span><span class="p">)</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                <span class="n">window_X_df</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="s2">                    SELECT temporal_window_indexes_df.__index_level_0__,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="s2">                        X_train_df.* EXCLUDE(__index_level_0__)</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="s2">                    FROM temporal_window_indexes_df</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="s2">                    LEFT JOIN X_train_df</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="s2">                    ON X_train_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">X_train_df</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>                <span class="n">window_y_df</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="s2">                    SELECT temporal_window_indexes_df.__index_level_0__,</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="s2">                        y_train_df.* EXCLUDE(__index_level_0__)</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="s2">                    FROM temporal_window_indexes_df</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="s2">                    LEFT JOIN y_train_df</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="s2">                    ON y_train_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">temporal_window_prequery</span> <span class="k">else</span> <span class="n">y_train_df</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="s2">                                                    SELECT X_train_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">, X_train_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">, X_train_df.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">, X_train_df.__index_level_0__ FROM X_train_df </span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a><span class="s2">                                                    JOIN temporal_window_indexes_df</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="s2">                                                    ON X_train_df.__index_level_0__ = temporal_window_indexes_df.__index_level_0__;</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><span class="s2">                                                   &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="c1"># Transform to STEM gridding coordinates</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>            <span class="n">window_X_df_indexes_only</span> <span class="o">=</span> <span class="n">transform_pred_set_to_STEM_quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span> <span class="n">window_X_df_indexes_only</span><span class="p">,</span> <span class="n">single_ensemble_df</span><span class="p">)</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="n">window_single_ensemble_df</span> <span class="o">=</span> <span class="n">single_ensemble_df</span><span class="p">[</span><span class="n">single_ensemble_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_start&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">start</span><span class="p">]</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="c1"># Merge</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">find_belonged_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">y_df</span><span class="p">):</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                <span class="n">this_stixel_point_indexes</span> <span class="o">=</span> <span class="n">st_indexes_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                    <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_left_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_right_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_lower_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">st_indexes_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stixel_calibration_point_transformed_upper_bound&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                <span class="p">]</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>                    <span class="n">X_y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_stixel_point_indexes</span><span class="p">],</span> <span class="n">y_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_stixel_point_indexes</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis</span><span class="p">([</span><span class="s1">&#39;true_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyRelation</span><span class="p">):</span>  
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>                    <span class="n">this_stixel_point_indexes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">this_stixel_point_indexes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">])</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;this_stixel_point_indexes_df&quot;</span><span class="p">,</span> <span class="n">this_stixel_point_indexes_df</span><span class="p">)</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;X_df&#39;</span><span class="p">,</span> <span class="n">X_df</span><span class="p">)</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;y_df&#39;</span><span class="p">,</span> <span class="n">y_df</span><span class="p">)</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                    <span class="n">y_column</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">==</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>                    <span class="n">X_y</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="s2">                    SELECT this_stixel_point_indexes_df.__index_level_0__, </span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="s2">                        X_df.* EXCLUDE(__index_level_0__), </span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="s2">                        y_df.</span><span class="si">{</span><span class="n">y_column</span><span class="si">}</span><span class="s2"> as true_y</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="s2">                    FROM this_stixel_point_indexes_df</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="s2">                    LEFT JOIN X_df</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="s2">                        ON X_df.__index_level_0__ = this_stixel_point_indexes_df.__index_level_0__</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="s2">                    LEFT JOIN y_df</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="s2">                        ON y_df.__index_level_0__ = this_stixel_point_indexes_df.__index_level_0__;</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="s2">                    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">)</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;this_stixel_point_indexes_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;X_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>                    <span class="n">con</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;y_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>                    <span class="k">raise</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>                <span class="k">return</span> <span class="n">X_y</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">find_belonged_points_and_fit</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">y_df</span><span class="p">):</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>                <span class="n">X_y</span> <span class="o">=</span> <span class="n">find_belonged_points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">y_df</span><span class="p">)</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_y</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>                    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>                <span class="n">X_y</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>                <span class="n">X_y</span><span class="p">[</span><span class="s1">&#39;unique_stixel_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unique_stixel_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>                <span class="n">X_y</span> <span class="o">=</span> <span class="n">X_y</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># To ensure the input dataframes for the two method (temporal_window_prequery or not) are the same so the tained base models are identical, at least with the same input data</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>                <span class="n">fitted_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_fitting</span><span class="p">(</span><span class="n">X_y</span><span class="p">)</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>                <span class="k">return</span> <span class="n">fitted_res</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>            <span class="c1"># train</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>                <span class="n">window_single_ensemble_df</span><span class="p">[</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>                    <span class="p">[</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>                        <span class="s2">&quot;ensemble_index&quot;</span><span class="p">,</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>                        <span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">,</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>                        <span class="s2">&quot;stixel_calibration_point_transformed_left_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>                        <span class="s2">&quot;stixel_calibration_point_transformed_right_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>                        <span class="s2">&quot;stixel_calibration_point_transformed_lower_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>                        <span class="s2">&quot;stixel_calibration_point_transformed_upper_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>                    <span class="p">]</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>                <span class="p">]</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">,</span> <span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>                <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span> <span class="c1"># Explicitly select all the columns in the original df to include. To overcome the include_groups=True deprecation warning</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">find_belonged_points_and_fit</span><span class="p">,</span> <span class="n">st_indexes_df</span><span class="o">=</span><span class="n">window_X_df_indexes_only</span><span class="p">,</span> <span class="n">X_df</span><span class="o">=</span><span class="n">window_X_df</span><span class="p">,</span> <span class="n">y_df</span><span class="o">=</span><span class="n">window_y_df</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># although [&quot;ensemble_index&quot;, &quot;unique_stixel_id&quot;] will be passed into `find_belonged_points` due to `.pipe(lambda x: x[x.obj.columns])`, the output will not have them so we still set `as_index=True` in `groupby`</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>            <span class="p">)</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>    <span class="k">return</span> <span class="n">res_list</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.SAC_predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">SAC_predict</span><span class="p">(</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This function is a prediction function with SAC strategy:
Split (S), Apply(A), Combine (C). At ensemble level.
It is built on pandas <code>apply</code> method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>ensemble_df</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>gridding information for all ensemble</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>data</code></b>
              (<code>(<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>)</code>)
          –
          <div class="doc-md-description">
            <p>data</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosity</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>0</code>
)
          –
          <div class="doc-md-description">
            <p>Defaults to 0.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>n_jobs</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>1</code>
)
          –
          <div class="doc-md-description">
            <p>number of processors for parallel computing</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_window_prequery</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="pandas.DataFrame">DataFrame</span></code>
          –
          <div class="doc-md-description">
            <p>pd.DataFrame: prediction results.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-967" name="__codelineno-0-967"></a><span class="k">def</span><span class="w"> </span><span class="nf">SAC_predict</span><span class="p">(</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">ensemble_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;This function is a prediction function with SAC strategy:</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a><span class="sd">    Split (S), Apply(A), Combine (C). At ensemble level.</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a><span class="sd">    It is built on pandas `apply` method.</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a><span class="sd">        ensemble_df (pd.DataFrame): gridding information for all ensemble</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a><span class="sd">        data (pd.DataFrame, str): data</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a><span class="sd">        verbosity (int, optional): Defaults to 0.</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a><span class="sd">        n_jobs (int): number of processors for parallel computing</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a><span class="sd">        temporal_window_prequery (bool): Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a><span class="sd">        pd.DataFrame: prediction results.</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>    <span class="c1"># Parallel maker</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>        <span class="n">output_generator</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAC_ensemble_predict</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="o">=</span><span class="n">ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span> <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">mp_predict</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAC_ensemble_predict</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="o">=</span><span class="n">ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>            <span class="k">return</span> <span class="n">res</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>        <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span><span class="p">,</span> <span class="n">temp_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>        <span class="n">output_generator</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">mp_predict</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>    <span class="c1"># tqdm wrapper</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>        <span class="n">output_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>            <span class="n">output_generator</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Predicting: &quot;</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>        <span class="p">)</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>    <span class="c1"># Prediction</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>    <span class="n">pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_generator</span><span class="p">]</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>    <span class="n">get_reusable_executor</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>    <span class="n">pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>            <span class="s2">&quot;All samples are not predictable based on current settings!</span><span class="se">\n</span><span class="s2">Try adjusting the &#39;points_lower_threshold&#39;, increase the grid size, or increase sample size!&quot;</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a>        <span class="p">)</span>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a>    <span class="n">pred</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">))</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>    <span class="k">return</span> <span class="n">pred</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.SAC_training" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">SAC_training</span><span class="p">(</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This function is a training function with SAC strategy:
Split (S), Apply(A), Combine (C). At ensemble level.
It is built on pandas <code>apply</code> method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>ensemble_df</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>gridding information for all ensemble</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>X_train</code></b>
              (<code>(<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>)</code>)
          –
          <div class="doc-md-description">
            <p>X_train</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>y_train</code></b>
              (<code>(<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>)</code>)
          –
          <div class="doc-md-description">
            <p>y_train</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosity</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>0</code>
)
          –
          <div class="doc-md-description">
            <p>Defaults to 0.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_window_prequery</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-682" name="__codelineno-0-682"></a><span class="k">def</span><span class="w"> </span><span class="nf">SAC_training</span><span class="p">(</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">ensemble_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>    <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="p">):</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;This function is a training function with SAC strategy:</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="sd">    Split (S), Apply(A), Combine (C). At ensemble level.</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a><span class="sd">    It is built on pandas `apply` method.</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><span class="sd">        ensemble_df (pd.DataFrame): gridding information for all ensemble</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><span class="sd">        X_train (pd.DataFrame, str): X_train</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a><span class="sd">        y_train (pd.DataFrame, str): y_train</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a><span class="sd">        verbosity (int, optional): Defaults to 0.</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a><span class="sd">        temporal_window_prequery (bool): Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>    <span class="c1"># Parallel wrapper</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>        <span class="n">output_generator</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAC_ensemble_training</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="o">=</span><span class="n">ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span> <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">mp_train</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAC_ensemble_training</span><span class="p">(</span><span class="n">single_ensemble_df</span><span class="o">=</span><span class="n">ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>            <span class="k">return</span> <span class="n">res</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>        <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span><span class="p">,</span> <span class="n">temp_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>        <span class="n">output_generator</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">mp_train</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>    <span class="c1"># tqdm wrapper</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>        <span class="n">output_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>            <span class="n">output_generator</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s2">&quot;ensemble_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training: &quot;</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>        <span class="p">)</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>    <span class="c1"># iterate through</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>    <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>    <span class="n">stixel_specific_x_names</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>    <span class="k">for</span> <span class="n">ensemble_id</span><span class="p">,</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_generator</span><span class="p">):</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>        <span class="k">for</span> <span class="n">time_block</span> <span class="ow">in</span> <span class="n">ensemble</span><span class="p">:</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>            <span class="k">for</span> <span class="n">feature_tuple</span> <span class="ow">in</span> <span class="n">time_block</span><span class="p">:</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>                <span class="k">if</span> <span class="n">feature_tuple</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">feature_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">feature_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>                <span class="n">x_names</span> <span class="o">=</span> <span class="n">feature_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>                <span class="n">model_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>                <span class="n">stixel_specific_x_names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_names</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>    <span class="n">get_reusable_executor</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span> <span class="o">=</span> <span class="n">model_dict</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stixel_specific_x_names</span> <span class="o">=</span> <span class="n">stixel_specific_x_names</span> <span class="c1"># Do it at the end to avoid dictionary changes during the pickling</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s1">&#39;hurdle&#39;</span><span class="p">,</span> <span class="n">ensemble_fold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_ensemble_required</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">grid_len_upper_threshold</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">grid_len_lower_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">points_lower_threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">stixel_training_size_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temporal_start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">temporal_end</span><span class="o">=</span><span class="mi">366</span><span class="p">,</span> <span class="n">temporal_step</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">temporal_bin_interval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">temporal_bin_start_jitter</span><span class="o">=</span><span class="s1">&#39;adaptive&#39;</span><span class="p">,</span> <span class="n">spatio_bin_jitter_magnitude</span><span class="o">=</span><span class="s1">&#39;adaptive&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_gridding_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sample_weights_for_classifier</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Spatio1</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">Spatio2</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="n">Temporal1</span><span class="o">=</span><span class="s1">&#39;DOY&#39;</span><span class="p">,</span> <span class="n">use_temporal_to_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">subset_x_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">completely_random_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy_loading</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy_loading_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_class_sample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ensemble_bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">joblib_backend</span><span class="o">=</span><span class="s1">&#39;loky&#39;</span><span class="p">,</span> <span class="n">max_mem</span><span class="o">=</span><span class="s1">&#39;2GB&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Make an AdaSTEM object</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>base_model</code></b>
              (<code><span title="sklearn.base.BaseEstimator">BaseEstimator</span></code>)
          –
          <div class="doc-md-description">
            <p>base model estimator</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>task</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;hurdle&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>task of the model. One of 'classifier', 'regressor' and 'hurdle'. Defaults to 'hurdle'.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>ensemble_fold</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>10</code>
)
          –
          <div class="doc-md-description">
            <p>Ensembles count. Higher, better for the model performance. Time complexity O(N). Defaults to 10.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>min_ensemble_required</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>7</code>
)
          –
          <div class="doc-md-description">
            <p>Only points with more than this number of model ensembles available are predicted.
In the training phase, if stixels contain less than <code>points_lower_threshold</code> of data records,
the results are set to np.nan, making them <code>unpredictable</code>. Defaults to 7.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>grid_len_upper_threshold</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]</code>, default:
                  <code>25</code>
)
          –
          <div class="doc-md-description">
            <p>force divide if grid length larger than the threshold. Defaults to 25.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>grid_len_lower_threshold</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]</code>, default:
                  <code>5</code>
)
          –
          <div class="doc-md-description">
            <p>stop divide if grid length <strong>will</strong> be below than the threshold. Defaults to 5.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>points_lower_threshold</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>50</code>
)
          –
          <div class="doc-md-description">
            <p>Do not further split the gird if split results in less samples than this threshold.
Overriden by grid_len_*_upper_threshold parameters. Defaults to 50.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>stixel_training_size_threshold</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Do not train the model if the available data records for this stixel is less than this threshold,
and directly set the value to np.nan. Defaults to None, which will be set as the same value as <code>points_lower_threshold</code>.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_start</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]</code>, default:
                  <code>1</code>
)
          –
          <div class="doc-md-description">
            <p>start of the temporal sequence. Defaults to 1.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_end</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]</code>, default:
                  <code>366</code>
)
          –
          <div class="doc-md-description">
            <p>end of the temporal sequence. Defaults to 366.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_step</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]</code>, default:
                  <code>20</code>
)
          –
          <div class="doc-md-description">
            <p>step of the sliding window. Defaults to 20.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_bin_interval</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]</code>, default:
                  <code>50</code>
)
          –
          <div class="doc-md-description">
            <p>size of the sliding window. Defaults to 50.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_bin_start_jitter</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>, <span title="str">str</span>]</code>, default:
                  <code>&#39;adaptive&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>jitter of the start of the sliding window.
If 'adaptive', a random jitter of range (-bin_interval, 0) will be generated
for the start. Defaults to 'adaptive'.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>spatio_bin_jitter_magnitude</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]</code>, default:
                  <code>&#39;adaptive&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>jitter of the spatial gridding. Defaults to 'adaptive'.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>random_state</code></b>
          –
          <div class="doc-md-description">
            <p>None or int. After setting the same seed, the model will generate the same results each time. For reproducibility.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>save_gridding_plot</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>True</code>
)
          –
          <div class="doc-md-description">
            <p>Whether ot save gridding plots. Defaults to True.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>sample_weights_for_classifier</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>True</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to adjust for unbanlanced data for the classifier. Default to True.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>Spatio1</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;longitude&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>Spatial column name 1 in data. Defaults to 'longitude'.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>Spatio2</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;latitude&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>Spatial column name 2 in data. Defaults to 'latitude'.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>Temporal1</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;DOY&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>Temporal column name 1 in data.  Defaults to 'DOY'.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>use_temporal_to_train</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>True</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to use temporal variable to train. For example in modeling the daily abundance of bird population,
whether use 'day of year (DOY)' as a training variable. Defaults to True.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>n_jobs</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>1</code>
)
          –
          <div class="doc-md-description">
            <p>Number of multiprocessing in fitting the model. Defaults to 1.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>subset_x_names</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to only store variables with std &gt; 0 for each stixel. Set to False will significantly increase the training speed.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>plot_xlims</code></b>
              (<code><span title="typing.Tuple">Tuple</span>[<span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>], <span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>If save_gridding_plot=true, what is the xlims of the plot. Defaults to the extent of input X varibale.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>plot_ylims</code></b>
              (<code><span title="typing.Tuple">Tuple</span>[<span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>], <span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="int">int</span>]]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>If save_gridding_plot=true, what is the ylims of the plot. Defaults to the extent of input Y varibale.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosity</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>1</code>
)
          –
          <div class="doc-md-description">
            <p>Verbosity of the logging information to print. 0 to output nothing and everything otherwise.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>plot_empty</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to plot the empty grid</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>completely_random_rotation</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>If True, the rotation angle will be generated completely randomly, as in paper https://doi.org/10.1002/eap.2056. If False, the ensembles will split the 90 degree with equal angle intervals. e.g., if ensemble_fold=9, then each ensemble will rotate 10 degree futher than the previous ensemble. Defalt to False, because if ensemble fold is small, it will be more robust to equally devide the data; and if ensemble fold is large, they are effectively similar than complete random.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>lazy_loading</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>If True, ensembles of models will be saved in disk, and only loaded when being used (e.g., prediction phase), and the ensembles of models are dump to disk once it is used.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>lazy_loading_dir</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="str">str</span>, None]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>If lazy_loading, the directory of the model to temporary save to. Default to None, where a folder in /tmp will be created and used. This folder can exist even with lazy_loading==False.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>min_class_sample</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>1</code>
)
          –
          <div class="doc-md-description">
            <p>Minimum umber of samples needed to train the classifier in each stixel. If the sample does not satisfy, fit a dummy one. This parameter does not influence regression tasks.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>ensemble_bootstrap</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to bootstrap the data at each ensemble level to account for uncertainty. Defaults to False.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>joblib_backend</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;loky&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>The backend of joblib. Defaults to 'loky'. Other options include 'threading'. ('multiprocessing' not supported because it does not allow generator format).</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>max_mem</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;2GB&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>The maximum memory use during the training or prediction process. Should be format like '60GB', '512MB', '1.5GB'. This argument is only valid if your input training/prediction data is the path to duckdb files. But even if your input are duckdb files, this argument does not guarantee that the memory use for each joblib worker will be lower than that due to various intermediate objects. This argument should only be considered a relative constrain.</p>
          </div>
        </li>
    </ul>
        <p>Raises:
    AttributeError: Base model do not have method 'fit' or 'predict'
    AttributeError: task not in one of ['regression', 'classification', 'hurdle']
    AttributeError: temporal_bin_start_jitter not in one of [str, float, int]
    AttributeError: temporal_bin_start_jitter is type str, but not 'random'</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <ul>
        <li class="doc-section-item field-body">
          <b><code><span title="stemflow.model.AdaSTEM.AdaSTEM.__init__.x_names">x_names</span></code></b>
              (<code><span title="list">list</span></code>)
          –
          <div class="doc-md-description">
            <p>All training variables used.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="stemflow.model.AdaSTEM.AdaSTEM.__init__.stixel_specific_x_names">stixel_specific_x_names</span></code></b>
              (<code><span title="dict">dict</span></code>)
          –
          <div class="doc-md-description">
            <p>stixel specific x_names (predictor variable names) for each stixel.
We remove the variables that have no variation for each stixel.
Therefore, the x_names are different for each stixel.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="stemflow.model.AdaSTEM.AdaSTEM.__init__.ensemble_df">ensemble_df</span></code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>A dataframe storing the stixel gridding information.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="stemflow.model.AdaSTEM.AdaSTEM.__init__.gridding_plot">gridding_plot</span></code></b>
              (<code><span title="matplotlib.figure.Figure">Figure</span></code>)
          –
          <div class="doc-md-description">
            <p>Ensemble plot.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="stemflow.model.AdaSTEM.AdaSTEM.__init__.model_dict">model_dict</span></code></b>
              (<code><span title="dict">dict</span></code>)
          –
          <div class="doc-md-description">
            <p>Dictionary of {stixel_index: trained_model}.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="stemflow.model.AdaSTEM.AdaSTEM.__init__.grid_dict">grid_dict</span></code></b>
              (<code><span title="dict">dict</span></code>)
          –
          <div class="doc-md-description">
            <p>An array of stixels assigned to each ensemble.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="stemflow.model.AdaSTEM.AdaSTEM.__init__.feature_importances_">feature_importances_</span></code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>feature importance dataframe for each stixel.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="n">base_model</span><span class="p">:</span> <span class="n">BaseEstimator</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">task</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hurdle&quot;</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">ensemble_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">min_ensemble_required</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">grid_len_upper_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">grid_len_lower_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">points_lower_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">stixel_training_size_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">temporal_start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">temporal_end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">366</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">temporal_step</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">temporal_bin_interval</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">temporal_bin_start_jitter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">spatio_bin_jitter_magnitude</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">save_gridding_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">sample_weights_for_classifier</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">Spatio1</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">Spatio2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">Temporal1</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DOY&quot;</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">use_temporal_to_train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">subset_x_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">plot_xlims</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">plot_ylims</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">plot_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="n">completely_random_rotation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="n">lazy_loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="n">lazy_loading_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="n">min_class_sample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="n">ensemble_bootstrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="n">joblib_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;loky&#39;</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="n">max_mem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;2GB&#39;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="p">):</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Make an AdaSTEM object</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        base_model:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">            base model estimator</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        task:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">            task of the model. One of &#39;classifier&#39;, &#39;regressor&#39; and &#39;hurdle&#39;. Defaults to &#39;hurdle&#39;.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        ensemble_fold:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">            Ensembles count. Higher, better for the model performance. Time complexity O(N). Defaults to 10.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        min_ensemble_required:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">            Only points with more than this number of model ensembles available are predicted.</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">            In the training phase, if stixels contain less than `points_lower_threshold` of data records,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">            the results are set to np.nan, making them `unpredictable`. Defaults to 7.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        grid_len_upper_threshold:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">            force divide if grid length larger than the threshold. Defaults to 25.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        grid_len_lower_threshold:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">            stop divide if grid length **will** be below than the threshold. Defaults to 5.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        points_lower_threshold:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">            Do not further split the gird if split results in less samples than this threshold.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">            Overriden by grid_len_*_upper_threshold parameters. Defaults to 50.</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        stixel_training_size_threshold:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">            Do not train the model if the available data records for this stixel is less than this threshold,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">            and directly set the value to np.nan. Defaults to None, which will be set as the same value as `points_lower_threshold`.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        temporal_start:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">            start of the temporal sequence. Defaults to 1.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        temporal_end:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">            end of the temporal sequence. Defaults to 366.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        temporal_step:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">            step of the sliding window. Defaults to 20.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        temporal_bin_interval:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">            size of the sliding window. Defaults to 50.</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        temporal_bin_start_jitter:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">            jitter of the start of the sliding window.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">            If &#39;adaptive&#39;, a random jitter of range (-bin_interval, 0) will be generated</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">            for the start. Defaults to &#39;adaptive&#39;.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        spatio_bin_jitter_magnitude:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">            jitter of the spatial gridding. Defaults to &#39;adaptive&#39;.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">        random_state:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">            None or int. After setting the same seed, the model will generate the same results each time. For reproducibility.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        save_gridding_plot:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">            Whether ot save gridding plots. Defaults to True.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        sample_weights_for_classifier:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">            Whether to adjust for unbanlanced data for the classifier. Default to True.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        Spatio1:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">            Spatial column name 1 in data. Defaults to &#39;longitude&#39;.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        Spatio2:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">            Spatial column name 2 in data. Defaults to &#39;latitude&#39;.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        Temporal1:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">            Temporal column name 1 in data.  Defaults to &#39;DOY&#39;.</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        use_temporal_to_train:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">            Whether to use temporal variable to train. For example in modeling the daily abundance of bird population,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">            whether use &#39;day of year (DOY)&#39; as a training variable. Defaults to True.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        n_jobs:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">            Number of multiprocessing in fitting the model. Defaults to 1.</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        subset_x_names:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">            Whether to only store variables with std &gt; 0 for each stixel. Set to False will significantly increase the training speed.</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        plot_xlims:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">            If save_gridding_plot=true, what is the xlims of the plot. Defaults to the extent of input X varibale.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">        plot_ylims:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">            If save_gridding_plot=true, what is the ylims of the plot. Defaults to the extent of input Y varibale.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">        verbosity:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">            Verbosity of the logging information to print. 0 to output nothing and everything otherwise.</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">        plot_empty:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">            Whether to plot the empty grid</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">        completely_random_rotation:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">            If True, the rotation angle will be generated completely randomly, as in paper https://doi.org/10.1002/eap.2056. If False, the ensembles will split the 90 degree with equal angle intervals. e.g., if ensemble_fold=9, then each ensemble will rotate 10 degree futher than the previous ensemble. Defalt to False, because if ensemble fold is small, it will be more robust to equally devide the data; and if ensemble fold is large, they are effectively similar than complete random.</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        lazy_loading:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">            If True, ensembles of models will be saved in disk, and only loaded when being used (e.g., prediction phase), and the ensembles of models are dump to disk once it is used.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">        lazy_loading_dir:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">            If lazy_loading, the directory of the model to temporary save to. Default to None, where a folder in /tmp will be created and used. This folder can exist even with lazy_loading==False.</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">        min_class_sample:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">            Minimum umber of samples needed to train the classifier in each stixel. If the sample does not satisfy, fit a dummy one. This parameter does not influence regression tasks.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">        ensemble_bootstrap:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">            Whether to bootstrap the data at each ensemble level to account for uncertainty. Defaults to False.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">        joblib_backend:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">            The backend of joblib. Defaults to &#39;loky&#39;. Other options include &#39;threading&#39;. (&#39;multiprocessing&#39; not supported because it does not allow generator format).</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">        max_mem:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">            The maximum memory use during the training or prediction process. Should be format like &#39;60GB&#39;, &#39;512MB&#39;, &#39;1.5GB&#39;. This argument is only valid if your input training/prediction data is the path to duckdb files. But even if your input are duckdb files, this argument does not guarantee that the memory use for each joblib worker will be lower than that due to various intermediate objects. This argument should only be considered a relative constrain.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        AttributeError: Base model do not have method &#39;fit&#39; or &#39;predict&#39;</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        AttributeError: task not in one of [&#39;regression&#39;, &#39;classification&#39;, &#39;hurdle&#39;]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">        AttributeError: temporal_bin_start_jitter not in one of [str, float, int]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">        AttributeError: temporal_bin_start_jitter is type str, but not &#39;random&#39;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        x_names (list):</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">            All training variables used.</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">        stixel_specific_x_names (dict):</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">            stixel specific x_names (predictor variable names) for each stixel.</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">            We remove the variables that have no variation for each stixel.</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">            Therefore, the x_names are different for each stixel.</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        ensemble_df (pd.DataFrame):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">            A dataframe storing the stixel gridding information.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">        gridding_plot (matplotlib.figure.Figure):</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">            Ensemble plot.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        model_dict (dict):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">            Dictionary of {stixel_index: trained_model}.</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        grid_dict (dict):</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">            An array of stixels assigned to each ensemble.</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        feature_importances_ (pd.DataFrame):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">            feature importance dataframe for each stixel.</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="c1"># 1. Check random state</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="c1"># 2. Base model</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">check_base_model</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="n">base_model</span> <span class="o">=</span> <span class="n">model_wrapper</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">base_model</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="c1"># 3. Model params</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="n">check_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span> <span class="o">=</span> <span class="n">Temporal1</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span> <span class="o">=</span> <span class="n">Spatio1</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span> <span class="o">=</span> <span class="n">Spatio2</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="c1"># 4. Gridding params</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="k">if</span> <span class="n">min_ensemble_required</span> <span class="o">&gt;</span> <span class="n">ensemble_fold</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not satisfied: min_ensemble_required &lt;= ensemble_fold&quot;</span><span class="p">)</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span> <span class="o">=</span> <span class="n">ensemble_fold</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">min_ensemble_required</span> <span class="o">=</span> <span class="n">min_ensemble_required</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">grid_len_upper_threshold</span> <span class="o">=</span> <span class="n">grid_len_upper_threshold</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">grid_len_lower_threshold</span> <span class="o">=</span> <span class="n">grid_len_lower_threshold</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Just a place holder. This will not be used for AdaSTEM and will be override by grid_len in STEM for fixed grid size.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">points_lower_threshold</span> <span class="o">=</span> <span class="n">points_lower_threshold</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">temporal_start</span> <span class="o">=</span> <span class="n">temporal_start</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">temporal_end</span> <span class="o">=</span> <span class="n">temporal_end</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">temporal_step</span> <span class="o">=</span> <span class="n">temporal_step</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span> <span class="o">=</span> <span class="n">temporal_bin_interval</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">completely_random_rotation</span> <span class="o">=</span> <span class="n">completely_random_rotation</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>    <span class="n">check_spatio_bin_jitter_magnitude</span><span class="p">(</span><span class="n">spatio_bin_jitter_magnitude</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">spatio_bin_jitter_magnitude</span> <span class="o">=</span> <span class="n">spatio_bin_jitter_magnitude</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="n">check_temporal_bin_start_jitter</span><span class="p">(</span><span class="n">temporal_bin_start_jitter</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_start_jitter</span> <span class="o">=</span> <span class="n">temporal_bin_start_jitter</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="c1"># 5. Training params</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="k">if</span> <span class="n">stixel_training_size_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span> <span class="o">=</span> <span class="n">points_lower_threshold</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span> <span class="o">=</span> <span class="n">stixel_training_size_threshold</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">use_temporal_to_train</span> <span class="o">=</span> <span class="n">use_temporal_to_train</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subset_x_names</span> <span class="o">=</span> <span class="n">subset_x_names</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sample_weights_for_classifier</span> <span class="o">=</span> <span class="n">sample_weights_for_classifier</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">min_class_sample</span> <span class="o">=</span> <span class="n">min_class_sample</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span> <span class="o">=</span> <span class="n">ensemble_bootstrap</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="c1"># 6. Multi-processing params</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>    <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span> <span class="o">=</span> <span class="n">joblib_backend</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="c1"># 7. Plotting params</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span> <span class="o">=</span> <span class="n">plot_xlims</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span> <span class="o">=</span> <span class="n">plot_ylims</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">save_gridding_plot</span> <span class="o">=</span> <span class="n">save_gridding_plot</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">plot_empty</span> <span class="o">=</span> <span class="n">plot_empty</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="c1"># X. miscellaneous</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading</span> <span class="o">=</span> <span class="n">lazy_loading</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="o">=</span> <span class="n">lazy_loading_dir</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">check_mem_string</span><span class="p">(</span><span class="n">max_mem</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">max_mem</span> <span class="o">=</span> <span class="n">max_mem</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.assign_feature_importances_by_points" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">assign_feature_importances_by_points</span><span class="p">(</span><span class="n">Sample_ST_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">assign_function</span><span class="o">=</span><span class="n">assign_points_to_one_ensemble</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Assign feature importance to the input spatio-temporal points</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>Sample_ST_df</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="pandas.DataFrame">DataFrame</span>, None]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Dataframe that indicate the spatio-temporal points of interest.
Must contain <code>self.Spatio1</code>, <code>self.Spatio2</code>, and <code>self.Temporal1</code> in columns.
If None, the resolution will be:</p>
<table>
<thead>
<tr>
<th>variable</th>
<th>values</th>
</tr>
</thead>
<tbody>
<tr>
<td>Spatio_var1</td>
<td>np.arange(-180,180,1)</td>
</tr>
<tr>
<td>Spatio_var2</td>
<td>np.arange(-90,90,1)</td>
</tr>
<tr>
<td>Temporal_var1</td>
<td>np.arange(1,366,7)</td>
</tr>
</tbody>
</table>
<p>Defaults to None.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosity</code></b>
              (<code><span title="typing.Union">Union</span>[None, <span title="int">int</span>]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>aggregation</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;mean&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>One of 'mean' and 'median' to aggregate feature importance across ensembles.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>n_jobs</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="int">int</span>, None]</code>, default:
                  <code>1</code>
)
          –
          <div class="doc-md-description">
            <p>Number of processes used in this task. If None, use the self.n_jobs. Default to 1.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="NameError">NameError</span></code>
            –
          <div class="doc-md-description">
            <p>feature_importances_ attribute is not calculated. Try model.calculate_feature_importances() first.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
              <code><span title="ValueError">ValueError</span></code>
            –
          <div class="doc-md-description">
            <p>f'aggregation not one of ['mean','median'].'</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
              <code><span title="KeyError">KeyError</span></code>
            –
          <div class="doc-md-description">
            <p>One of [<code>self.Spatio1</code>, <code>self.Spatio2</code>, <code>self.Temporal1</code>] not found in <code>Sample_ST_df.columns</code></p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="pandas.DataFrame">DataFrame</span></code>
          –
          <div class="doc-md-description">
            <p>DataFrame with feature importance assigned.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1358" name="__codelineno-0-1358"></a><span class="k">def</span><span class="w"> </span><span class="nf">assign_feature_importances_by_points</span><span class="p">(</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>    <span class="n">Sample_ST_df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a>    <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a>    <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a>    <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a>    <span class="n">assign_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">assign_points_to_one_ensemble</span><span class="p">,</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Assign feature importance to the input spatio-temporal points</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a><span class="sd">        Sample_ST_df (Union[pd.DataFrame, None], optional):</span>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a><span class="sd">            Dataframe that indicate the spatio-temporal points of interest.</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a><span class="sd">            Must contain `self.Spatio1`, `self.Spatio2`, and `self.Temporal1` in columns.</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a><span class="sd">            If None, the resolution will be:</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a><span class="sd">            | variable|values|</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a><span class="sd">            |---------|--------|</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a><span class="sd">            |Spatio_var1|np.arange(-180,180,1)|</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a><span class="sd">            |Spatio_var2|np.arange(-90,90,1)|</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a><span class="sd">            |Temporal_var1|np.arange(1,366,7)|</span>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a><span class="sd">        verbosity (Union[None, int], optional):</span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a><span class="sd">            0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a><span class="sd">        aggregation (str, optional):</span>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a><span class="sd">            One of &#39;mean&#39; and &#39;median&#39; to aggregate feature importance across ensembles.</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a><span class="sd">        n_jobs (Union[int, None], optional):</span>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a><span class="sd">            Number of processes used in this task. If None, use the self.n_jobs. Default to 1.</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a><span class="sd">        NameError:</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a><span class="sd">            feature_importances_ attribute is not calculated. Try model.calculate_feature_importances() first.</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a><span class="sd">        ValueError:</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a><span class="sd">            f&#39;aggregation not one of [\&#39;mean\&#39;,\&#39;median\&#39;].&#39;</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a><span class="sd">        KeyError:</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a><span class="sd">            One of [`self.Spatio1`, `self.Spatio2`, `self.Temporal1`] not found in `Sample_ST_df.columns`</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a><span class="sd">        DataFrame with feature importance assigned.</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a>    <span class="c1">#</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>    <span class="n">verbosity</span> <span class="o">=</span> <span class="n">check_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>    <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a>    <span class="n">check_prediction_aggregation</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>    <span class="c1">#</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a>    <span class="k">if</span> <span class="s2">&quot;feature_importances_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a>            <span class="s2">&quot;feature_importances_ attribute is not calculated. Try model.calculate_feature_importances() first.&quot;</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>        <span class="p">)</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a>    <span class="c1">#</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>    <span class="k">if</span> <span class="n">Sample_ST_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>        <span class="n">Spatio_var1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a>        <span class="n">Spatio_var2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>        <span class="n">Temporal_var1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>        <span class="n">new_Spatio_var1</span><span class="p">,</span> <span class="n">new_Spatio_var2</span><span class="p">,</span> <span class="n">new_Temporal_var1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Spatio_var1</span><span class="p">,</span> <span class="n">Spatio_var2</span><span class="p">,</span> <span class="n">Temporal_var1</span><span class="p">)</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a>        <span class="n">Sample_ST_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a>            <span class="p">{</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">:</span> <span class="n">new_Temporal_var1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">:</span> <span class="n">new_Spatio_var1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">:</span> <span class="n">new_Spatio_var2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>            <span class="p">}</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>        <span class="p">)</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">]:</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Sample_ST_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> not found in Sample_ST_df.columns&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>    <span class="n">partial_assign_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>        <span class="n">assign_function</span><span class="p">,</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>        <span class="n">ensemble_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>        <span class="n">Sample_ST_df</span><span class="o">=</span><span class="n">Sample_ST_df</span><span class="p">,</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>        <span class="n">Temporal1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>        <span class="n">Spatio1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>        <span class="n">Spatio2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>        <span class="n">feature_importances_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>    <span class="p">)</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>    <span class="c1"># assign input spatio-temporal points to stixels</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>        <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span><span class="p">,</span> <span class="n">temp_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>        <span class="n">output_generator</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">partial_assign_func</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">)))</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">output_generator</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Querying ensembles: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>        <span class="n">round_res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_generator</span><span class="p">]</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>        <span class="n">iter_func_</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>            <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Querying ensembles: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>            <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">)</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>        <span class="p">)</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>        <span class="n">round_res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">partial_assign_func</span><span class="p">(</span><span class="n">ensemble_count</span><span class="p">)</span> <span class="k">for</span> <span class="n">ensemble_count</span> <span class="ow">in</span> <span class="n">iter_func_</span><span class="p">]</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>    <span class="n">round_res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">round_res_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>    <span class="k">del</span> <span class="n">round_res_list</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>    <span class="n">ensemble_available_count</span> <span class="o">=</span> <span class="n">round_res_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sample_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>    <span class="c1"># Only points with more than self.min_ensemble_required ensembles available are used</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>    <span class="n">usable_sample</span> <span class="o">=</span> <span class="n">ensemble_available_count</span><span class="p">[</span><span class="n">ensemble_available_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_ensemble_required</span><span class="p">]</span>  <span class="c1">#</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>    <span class="n">round_res_df</span> <span class="o">=</span> <span class="n">round_res_df</span><span class="p">[</span><span class="n">round_res_df</span><span class="p">[</span><span class="s2">&quot;sample_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">usable_sample</span><span class="o">.</span><span class="n">index</span><span class="p">))]</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>    <span class="c1"># aggregate across ensembles</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>    <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>        <span class="n">mean_feature_importances_across_ensembles</span> <span class="o">=</span> <span class="n">round_res_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sample_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>    <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>        <span class="n">mean_feature_importances_across_ensembles</span> <span class="o">=</span> <span class="n">round_res_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sample_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_temporal_to_train</span><span class="p">:</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>        <span class="n">mean_feature_importances_across_ensembles</span> <span class="o">=</span> <span class="n">mean_feature_importances_across_ensembles</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">_predictor&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>        <span class="p">)</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>    <span class="n">out_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Sample_ST_df</span><span class="p">,</span> <span class="n">mean_feature_importances_across_ensembles</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>    <span class="k">return</span> <span class="n">out_</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.calculate_feature_importances" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_feature_importances</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>A method to generate feature importance values for each stixel.</p>
<p>feature importances are saved in self.feature_importances_.</p>


<details class="attribute-dependence" open>
  <summary>Attribute dependence</summary>
  <ol>
<li>self.ensemble_df</li>
<li>self.model_dict</li>
<li>self.stixel_specific_x_names</li>
<li>The input base model should have attribute <code>feature_importances_</code></li>
</ol>
</details>

            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1306" name="__codelineno-0-1306"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_feature_importances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A method to generate feature importance values for each stixel.</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a><span class="sd">    feature importances are saved in self.feature_importances_.</span>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a><span class="sd">    Attribute dependence:</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a><span class="sd">        1. self.ensemble_df</span>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a><span class="sd">        2. self.model_dict</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a><span class="sd">        3. self.stixel_specific_x_names</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a><span class="sd">        4. The input base model should have attribute `feature_importances_`</span>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>    <span class="c1"># generate feature importance dict</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>    <span class="n">feature_importance_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>    <span class="k">for</span> <span class="n">ensemble_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ensemble_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">[</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s1">&#39;ensemble_index&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ensemble_id</span><span class="p">)</span> <span class="o">&amp;</span>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">[</span><span class="s2">&quot;stixel_checklist_count&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span><span class="p">)</span>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a>            <span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a>            <span class="k">if</span> <span class="n">ensemble_row</span><span class="p">[</span><span class="s2">&quot;stixel_checklist_count&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span><span class="p">:</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a>                <span class="k">continue</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a>                <span class="n">stixel_index</span> <span class="o">=</span> <span class="n">ensemble_row</span><span class="p">[</span><span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a>                <span class="n">the_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stixel_index</span><span class="si">}</span><span class="s2">_model&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a>                <span class="n">x_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stixel_specific_x_names</span><span class="p">[</span><span class="n">stixel_index</span><span class="p">]</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">the_model</span><span class="p">,</span> <span class="n">dummy_model1</span><span class="p">):</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>                    <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">)))</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">the_model</span><span class="p">,</span> <span class="n">Hurdle</span><span class="p">):</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a>                    <span class="k">if</span> <span class="s2">&quot;feature_importances_&quot;</span> <span class="ow">in</span> <span class="n">the_model</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">():</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>                        <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_names</span><span class="p">,</span> <span class="n">the_model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">the_model</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span> <span class="n">dummy_model1</span><span class="p">):</span>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>                            <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">)))</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>                            <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_names</span><span class="p">,</span> <span class="n">the_model</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>                    <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_names</span><span class="p">,</span> <span class="n">the_model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>                <span class="n">importance_dict</span><span class="p">[</span><span class="s2">&quot;stixel_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stixel_index</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>                <span class="n">feature_importance_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">importance_dict</span><span class="p">)</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>                <span class="k">continue</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">feature_importances_</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">feature_importance_list</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;stixel_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.eval_STEM_res" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">eval_STEM_res</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">cls_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Evaluation using multiple metrics</p>
<p>Classification metrics used:
1. AUC
2. Cohen's Kappa
3. F1
4. precision
5. recall
6. average precision</p>
<p>Regression metrics used:
1. spearman's r
2. peason's r
3. R2
4. mean absolute error (MAE)
5. mean squared error (MSE)
6. poisson deviance explained (PDE)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>task</code></b>
              (<code><span title="str">str</span></code>)
          –
          <div class="doc-md-description">
            <p>one of 'regression', 'classification' or 'hurdle'.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>y_test</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="numpy.ndarray">ndarray</span>]</code>)
          –
          <div class="doc-md-description">
            <p>y true</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>y_pred</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="numpy.ndarray">ndarray</span>]</code>)
          –
          <div class="doc-md-description">
            <p>y predicted</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>cls_threshold</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="float">float</span>, None]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Cutting threshold for the classification.
Values above cls_threshold will be labeled as 1 and 0 otherwise.
Defaults to None (0.5 for classification and 0 for hurdle).</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="AttributeError">AttributeError</span></code>
            –
          <div class="doc-md-description">
            <p>task not one of 'regression', 'classification' or 'hurdle'.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>dict</code></b> (              <code><span title="dict">dict</span></code>
)          –
          <div class="doc-md-description">
            <p>dictionary containing the metric names and their values.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span>
<span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span>
<span class="normal"><a href="#__codelineno-0-1199">1199</a></span>
<span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span>
<span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1185" name="__codelineno-0-1185"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_STEM_res</span><span class="p">(</span>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a>    <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1189" name="__codelineno-0-1189"></a>    <span class="n">y_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a>    <span class="n">y_pred</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a>    <span class="n">cls_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluation using multiple metrics</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a><span class="sd">    Classification metrics used:</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a><span class="sd">    1. AUC</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a><span class="sd">    2. Cohen&#39;s Kappa</span>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a><span class="sd">    3. F1</span>
<a id="__codelineno-0-1199" name="__codelineno-0-1199"></a><span class="sd">    4. precision</span>
<a id="__codelineno-0-1200" name="__codelineno-0-1200"></a><span class="sd">    5. recall</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a><span class="sd">    6. average precision</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a><span class="sd">    Regression metrics used:</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a><span class="sd">    1. spearman&#39;s r</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a><span class="sd">    2. peason&#39;s r</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a><span class="sd">    3. R2</span>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a><span class="sd">    4. mean absolute error (MAE)</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a><span class="sd">    5. mean squared error (MSE)</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a><span class="sd">    6. poisson deviance explained (PDE)</span>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a><span class="sd">        task (str):</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a><span class="sd">            one of &#39;regression&#39;, &#39;classification&#39; or &#39;hurdle&#39;.</span>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a><span class="sd">        y_test (Union[pd.Series, np.ndarray]):</span>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a><span class="sd">            y true</span>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a><span class="sd">        y_pred (Union[pd.Series, np.ndarray]):</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a><span class="sd">            y predicted</span>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a><span class="sd">        cls_threshold (Union[float, None], optional):</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a><span class="sd">            Cutting threshold for the classification.</span>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a><span class="sd">            Values above cls_threshold will be labeled as 1 and 0 otherwise.</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a><span class="sd">            Defaults to None (0.5 for classification and 0 for hurdle).</span>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a><span class="sd">        AttributeError: task not one of &#39;regression&#39;, &#39;classification&#39; or &#39;hurdle&#39;.</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a><span class="sd">        dict: dictionary containing the metric names and their values.</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>    <span class="k">if</span> <span class="n">task</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span> <span class="s2">&quot;classification&quot;</span><span class="p">,</span> <span class="s2">&quot;hurdle&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a>        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a>            <span class="sa">f</span><span class="s2">&quot;task type must be one of &#39;regression&#39;, &#39;classification&#39;, or &#39;hurdle&#39;! Now it is </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a>        <span class="p">)</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a>    <span class="k">if</span> <span class="n">cls_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>        <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>            <span class="n">cls_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>        <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;hurdle&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>            <span class="n">cls_threshold</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>        <span class="n">auc</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">average_precision</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;y_true&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a>
<a id="__codelineno-0-1246" name="__codelineno-0-1246"></a>        <span class="n">y_test_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span> <span class="o">&gt;</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a>        <span class="n">y_pred_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span> <span class="o">&gt;</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_pred_b</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a>            <span class="n">auc</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">average_precision</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a>            <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">))</span> <span class="c1"># AUC can be calculated with probability</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>            <span class="n">kappa</span> <span class="o">=</span> <span class="n">cohen_kappa_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a>            <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">)</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>            <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">)</span>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a>            <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">)</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a>            <span class="n">average_precision</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_test_b</span><span class="p">,</span> <span class="n">y_pred_b</span><span class="p">)</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;y_true&quot;</span><span class="p">:</span> <span class="n">y_test</span><span class="p">,</span> <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a>        <span class="n">s_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">))</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a>        <span class="n">p_r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">))</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>        <span class="n">MAE</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a>        <span class="n">MSE</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a>            <span class="n">poisson_deviance_explained</span> <span class="o">=</span> <span class="n">d2_tweedie_score</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PED estimation fail: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a>            <span class="n">poisson_deviance_explained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a>        <span class="n">s_r</span><span class="p">,</span> <span class="n">p_r</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">MAE</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span> <span class="n">poisson_deviance_explained</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>        <span class="s2">&quot;AUC&quot;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a>        <span class="s2">&quot;kappa&quot;</span><span class="p">:</span> <span class="n">kappa</span><span class="p">,</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>        <span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a>        <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a>        <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a>        <span class="s2">&quot;average_precision&quot;</span><span class="p">:</span> <span class="n">average_precision</span><span class="p">,</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>        <span class="s2">&quot;Spearman_r&quot;</span><span class="p">:</span> <span class="n">s_r</span><span class="p">,</span>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a>        <span class="s2">&quot;Pearson_r&quot;</span><span class="p">:</span> <span class="n">p_r</span><span class="p">,</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a>        <span class="s2">&quot;R2&quot;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a>        <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="n">MAE</span><span class="p">,</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>        <span class="s2">&quot;MSE&quot;</span><span class="p">:</span> <span class="n">MSE</span><span class="p">,</span>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a>        <span class="s2">&quot;poisson_deviance_explained&quot;</span><span class="p">:</span> <span class="n">poisson_deviance_explained</span><span class="p">,</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Fitting method</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>X_train</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>]</code>)
          –
          <div class="doc-md-description">
            <p>Training variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>y_train</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="pandas.DataFrame">DataFrame</span>, <span title="pandas.Series">Series</span>, <span title="numpy.ndarray">ndarray</span>, <span title="str">str</span>]</code>)
          –
          <div class="doc-md-description">
            <p>Training target. Can be either a pd.DataFrame object, a pd.Series object, a np.ndarray, or a string that indicate the path to the database (.duckdb or .parquet). It has to have indexes that match with the X_train.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>ax</code></b>
          –
          <div class="doc-md-description">
            <p>matplotlib Axes to add to</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosty</code></b>
          –
          <div class="doc-md-description">
            <p>whether to show progress bar. 0 for no and 1 for yes.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>ax</code></b>
          –
          <div class="doc-md-description">
            <p>matplotlib ax for adding grid plot on that.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>n_jobs</code></b>
              (<code><span title="typing.Union">Union</span>[None, <span title="int">int</span>]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>multiprocessing thread count. Default the n_jobs of model object.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>overwrite</code></b>
          –
          <div class="doc-md-description">
            <p>overwrite files in lazy_loading_dir. If set to False and any file exists in lazy_loading_dir, an error will be raise.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_window_prequery</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="TypeError">TypeError</span></code>
            –
          <div class="doc-md-description">
            <p>X_train is not a type of pd.DataFrame</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
              <code><span title="TypeError">TypeError</span></code>
            –
          <div class="doc-md-description">
            <p>y_train is not a type of np.ndarray or pd.DataFrame</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>    <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>    <span class="n">y_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>    <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>    <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>    <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>    <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a><span class="p">):</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Fitting method</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><span class="sd">        X_train: Training variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a><span class="sd">        y_train: Training target. Can be either a pd.DataFrame object, a pd.Series object, a np.ndarray, or a string that indicate the path to the database (.duckdb or .parquet). It has to have indexes that match with the X_train.</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a><span class="sd">        ax: matplotlib Axes to add to</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a><span class="sd">        verbosty: whether to show progress bar. 0 for no and 1 for yes.</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a><span class="sd">        ax: matplotlib ax for adding grid plot on that.</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a><span class="sd">        n_jobs: multiprocessing thread count. Default the n_jobs of model object.</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a><span class="sd">        overwrite: overwrite files in lazy_loading_dir. If set to False and any file exists in lazy_loading_dir, an error will be raise.</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a><span class="sd">        temporal_window_prequery: Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a><span class="sd">        TypeError: X_train is not a type of pd.DataFrame</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a><span class="sd">        TypeError: y_train is not a type of np.ndarray or pd.DataFrame</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>    <span class="c1"># Setup lazy_loading_dir and joblib_tmp_dir</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="o">=</span> <span class="n">initiate_lazy_loading_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span> <span class="c1"># run self._cleanup when the object is being garbage collected</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span> <span class="o">=</span> <span class="n">initiate_joblib_tmp_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="o">=</span> <span class="n">duckdb_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_mem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>        <span class="c1"># Input check</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="n">check_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">check_X_y_format_match</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>        <span class="n">check_X_train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>        <span class="n">check_y_train</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">check_X_y_indexes_match</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store_x_names</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>        <span class="c1"># Quadtree            </span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>        <span class="c1"># stixel specific x_names list</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>        <span class="k">for</span> <span class="n">rm_target</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;model_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;stixel_specific_x_names&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm_target</span><span class="p">):</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>                <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm_target</span><span class="p">)</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>        <span class="c1"># Training</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SAC_training</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="p">)</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>    <span class="k">except</span><span class="p">:</span> <span class="c1"># Remove the entire lazy_loading_dir since it includes failed models in this case</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">):</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>        <span class="k">raise</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>    <span class="k">finally</span><span class="p">:</span> <span class="c1"># Remove the joblib_tmp_dir anyway</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">):</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.predict_proba" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logit_agg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_model_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">base_model_prediction_param</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Predict probability</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>X_test</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>Testing variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosity</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>show progress bar or not. Yes for 0, and No for other. Defaults to None, which set it as the verbosity of the main model class.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>return_std</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether return the standard deviation among ensembles. Defaults to False.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>n_jobs</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="int">int</span>, None]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Number of processes used in this task. If None, use the self.n_jobs. Default to 1.
I do not recommend setting value larger than 1.
In practice, multi-processing seems to slow down the process instead of speeding up.
Could be more practical with large amount of data.
Still in experiment.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>aggregation</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;mean&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>'mean' or 'median' for aggregation method across ensembles.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>return_by_separate_ensembles</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Experimental function. return not by aggregation, but by separate ensembles.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>logit_agg</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to use logit aggregation for the classification task. Most likely only used when you are predicting "real" calibrated probability. If True, the model is averaging the probability prediction estimated by all ensembles in logit scale, and then back-tranforms it to probability scale. It's recommended to be jointly used with the CalibratedClassifierCV class in sklearn as a wrapper of the classifier to estimate the calibrated probability. Default is False, but can be set to true for "real" probability averaging.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>base_model_method</code></b>
              (<code><span title="typing.Union">Union</span>[None, <span title="str">str</span>]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>The name of the prediction method for base models. If None, <code>predict</code> or <code>predict_proba</code> will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Notice that dummy model will still predict 0, so the ensemble-aggregated result is still an average of zeros and your special prediction function output. Therefore, it may only make sense if your special prediction function predicts 0 as the absense/control value. Defaults to None.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_window_prequery</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>base_model_prediction_param</code></b>
          –
          <div class="doc-md-description">
            <p>Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={'n_jobs':1} (set n_jobs=1 for the <em>base model</em>). </p>
          </div>
        </li>
    </ul>
        <p>Raises:
    TypeError:
        X_test is not of type pd.DataFrame or str.
    ValueError:
        aggregation is not in ['mean','median'].</p>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>]]</code>
          –
          <div class="doc-md-description">
            <p>predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
              <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>]]</code>
          –
          <div class="doc-md-description">
            <p>If return_by_separate_ensembles == True:
Return numpy.ndarray of shape (n_samples, n_ensembles)</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span>
<span class="normal"><a href="#__codelineno-0-1075">1075</a></span>
<span class="normal"><a href="#__codelineno-0-1076">1076</a></span>
<span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span>
<span class="normal"><a href="#__codelineno-0-1081">1081</a></span>
<span class="normal"><a href="#__codelineno-0-1082">1082</a></span>
<span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span>
<span class="normal"><a href="#__codelineno-0-1143">1143</a></span>
<span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1020" name="__codelineno-0-1020"></a><span class="k">def</span><span class="w"> </span><span class="nf">predict_proba</span><span class="p">(</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>    <span class="n">X_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>    <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a>    <span class="n">return_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a>    <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a>    <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a>    <span class="n">return_by_separate_ensembles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>    <span class="n">logit_agg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>    <span class="n">base_model_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a>    <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>    <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Predict probability</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a><span class="sd">        X_test (pd.DataFrame):</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a><span class="sd">            Testing variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a><span class="sd">        verbosity (int, optional):</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a><span class="sd">            show progress bar or not. Yes for 0, and No for other. Defaults to None, which set it as the verbosity of the main model class.</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a><span class="sd">        return_std (bool, optional):</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a><span class="sd">            Whether return the standard deviation among ensembles. Defaults to False.</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a><span class="sd">        n_jobs (Union[int, None], optional):</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a><span class="sd">            Number of processes used in this task. If None, use the self.n_jobs. Default to 1.</span>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a><span class="sd">            I do not recommend setting value larger than 1.</span>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a><span class="sd">            In practice, multi-processing seems to slow down the process instead of speeding up.</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a><span class="sd">            Could be more practical with large amount of data.</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a><span class="sd">            Still in experiment.</span>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a><span class="sd">        aggregation (str, optional):</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a><span class="sd">            &#39;mean&#39; or &#39;median&#39; for aggregation method across ensembles.</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a><span class="sd">        return_by_separate_ensembles (bool, optional):</span>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a><span class="sd">            Experimental function. return not by aggregation, but by separate ensembles.</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a><span class="sd">        logit_agg:</span>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a><span class="sd">            Whether to use logit aggregation for the classification task. Most likely only used when you are predicting &quot;real&quot; calibrated probability. If True, the model is averaging the probability prediction estimated by all ensembles in logit scale, and then back-tranforms it to probability scale. It&#39;s recommended to be jointly used with the CalibratedClassifierCV class in sklearn as a wrapper of the classifier to estimate the calibrated probability. Default is False, but can be set to true for &quot;real&quot; probability averaging.</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a><span class="sd">        base_model_method:</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a><span class="sd">            The name of the prediction method for base models. If None, `predict` or `predict_proba` will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Notice that dummy model will still predict 0, so the ensemble-aggregated result is still an average of zeros and your special prediction function output. Therefore, it may only make sense if your special prediction function predicts 0 as the absense/control value. Defaults to None.</span>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a><span class="sd">        temporal_window_prequery:</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a><span class="sd">            Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a><span class="sd">        base_model_prediction_param:</span>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a><span class="sd">            Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={&#39;n_jobs&#39;:1} (set n_jobs=1 for the *base model*). </span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a><span class="sd">        TypeError:</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a><span class="sd">            X_test is not of type pd.DataFrame or str.</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a><span class="sd">        ValueError:</span>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a><span class="sd">            aggregation is not in [&#39;mean&#39;,&#39;median&#39;].</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a><span class="sd">        predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a><span class="sd">        If return_by_separate_ensembles == True:</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a><span class="sd">            Return numpy.ndarray of shape (n_samples, n_ensembles)</span>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a>    <span class="n">check_X_test</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a>    <span class="n">check_prediction_aggregation</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span>
<a id="__codelineno-0-1075" name="__codelineno-0-1075"></a>    <span class="n">return_by_separate_ensembles</span><span class="p">,</span> <span class="n">return_std</span> <span class="o">=</span> <span class="n">check_prediction_return</span><span class="p">(</span><span class="n">return_by_separate_ensembles</span><span class="p">,</span> <span class="n">return_std</span><span class="p">)</span>
<a id="__codelineno-0-1076" name="__codelineno-0-1076"></a>    <span class="n">verbosity</span> <span class="o">=</span> <span class="n">check_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span>
<a id="__codelineno-0-1077" name="__codelineno-0-1077"></a>    <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">base_model_method</span> <span class="o">=</span> <span class="n">base_model_method</span>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">base_model_prediction_param</span> <span class="o">=</span> <span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>
<a id="__codelineno-0-1081" name="__codelineno-0-1081"></a>    <span class="c1"># Setup joblib_tmp_dir</span>
<a id="__codelineno-0-1082" name="__codelineno-0-1082"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span> <span class="o">=</span> <span class="n">initiate_joblib_tmp_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-1083" name="__codelineno-0-1083"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="o">=</span> <span class="n">duckdb_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_mem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>        <span class="c1"># predict</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAC_predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">)</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>    <span class="k">except</span><span class="p">:</span> <span class="c1"># Remove the entire lazy_loading_dir since it includes failed models</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>        <span class="k">raise</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>    <span class="k">finally</span><span class="p">:</span> <span class="c1"># Remove the joblib_tmp_dir anyway</span>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">):</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a>    <span class="c1"># Get X_test indexes</span>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a>        <span class="n">X_test_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a>        <span class="k">with</span> <span class="n">open_db_connection</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">X_test_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a>            <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;X_test_df&quot;</span><span class="p">,</span> <span class="n">X_test_df</span><span class="p">)</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a>            <span class="n">X_test_indexes</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT __index_level_0__ FROM X_test_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a>    <span class="k">else</span><span class="p">:</span> 
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a>        <span class="k">raise</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a>    <span class="c1"># Experimental Function</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a>    <span class="k">if</span> <span class="n">return_by_separate_ensembles</span><span class="p">:</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a>        <span class="n">new_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_test_indexes</span><span class="p">)})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a>        <span class="n">new_res</span> <span class="o">=</span> <span class="n">new_res</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>        <span class="k">return</span> <span class="n">new_res</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a>    <span class="c1"># Transform to logit space if classification:</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">==</span><span class="s1">&#39;classification&#39;</span> <span class="ow">and</span> <span class="n">logit_agg</span><span class="p">:</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>        <span class="k">for</span> <span class="n">col_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a>            <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col_index</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a>            <span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">prob</span><span class="p">))</span> <span class="c1"># logit space</span>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a>        <span class="c1"># Aggregate</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a>        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>            <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># mean of all grid model that predicts this stixel</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>            <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>        <span class="c1"># Transform back to 0-1:</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>        <span class="n">res_mean</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">res_mean</span><span class="p">))</span> <span class="c1"># notice that the res_std is not transformed!</span>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a>        <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res_mean</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res_mean</span><span class="o">&lt;=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>        <span class="c1"># don&#39;t need to aggregate at logit scale</span>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>        <span class="c1"># Aggregate</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>            <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># mean of all grid model that predicts this stixel</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>            <span class="n">res_mean</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>    <span class="n">res_std</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a>    <span class="c1"># Nan count</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a>    <span class="n">res_nan_count</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>    <span class="n">pred_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span> <span class="o">-</span> <span class="n">res_nan_count</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_ensemble_required</span><span class="p">,</span> <span class="n">res_mean</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>    <span class="p">)</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a>    <span class="n">pred_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span> <span class="o">-</span> <span class="n">res_nan_count</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_ensemble_required</span><span class="p">,</span> <span class="n">res_std</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-1143" name="__codelineno-0-1143"></a>    <span class="p">)</span>
<a id="__codelineno-0-1144" name="__codelineno-0-1144"></a>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">res_mean</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s2">&quot;pred_mean&quot;</span><span class="p">:</span> <span class="n">pred_mean</span><span class="p">,</span> <span class="s2">&quot;pred_std&quot;</span><span class="p">:</span> <span class="n">pred_std</span><span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>        <span class="s2">&quot;index&quot;</span>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a>    <span class="p">)</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a>    <span class="c1"># Preparing output (formatting)</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a>    <span class="n">new_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_test_indexes</span><span class="p">)})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a>    <span class="n">new_res</span> <span class="o">=</span> <span class="n">new_res</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a>    <span class="n">nan_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a>    <span class="n">nan_frac</span> <span class="o">=</span> <span class="n">nan_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a>    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">nan_frac</span><span class="si">}</span><span class="s2">% points (</span><span class="si">{</span><span class="n">nan_count</span><span class="si">}</span><span class="s2"> points) falling out of predictable range.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a>    <span class="k">if</span> <span class="n">return_std</span><span class="p">:</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">==</span><span class="s1">&#39;classification&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">-</span><span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>            <span class="k">return</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">==</span><span class="s1">&#39;classification&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">-</span><span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a>            <span class="k">return</span> <span class="n">new_res</span><span class="p">[</span><span class="s2">&quot;pred_mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.score" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Combine predicting and evaluating in one method</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>X_test</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>Testing variables</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>y_test</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="numpy.ndarray">ndarray</span>]</code>)
          –
          <div class="doc-md-description">
            <p>y true</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>dict</code></b> (              <code><span title="dict">dict</span></code>
)          –
          <div class="doc-md-description">
            <p>dictionary containing the metric names and their values.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1290" name="__codelineno-0-1290"></a><span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine predicting and evaluating in one method</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a><span class="sd">        X_test (pd.DataFrame): Testing variables</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a><span class="sd">        y_test (Union[pd.Series, np.ndarray]): y true</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a><span class="sd">        dict: dictionary containing the metric names and their values.</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>    <span class="n">score_dict</span> <span class="o">=</span> <span class="n">AdaSTEM</span><span class="o">.</span><span class="n">eval_STEM_res</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">score_dict</span> <span class="o">=</span> <span class="n">score_dict</span>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.split" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>QuadTree indexing the input data</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>X_train</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>]</code>)
          –
          <div class="doc-md-description">
            <p>Training variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosity</code></b>
              (<code><span title="typing.Union">Union</span>[None, <span title="int">int</span>]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>ax</code></b>
          –
          <div class="doc-md-description">
            <p>matplotlit Axes to add to.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>n_jobs</code></b>
              (<code><span title="typing.Union">Union</span>[None, <span title="int">int</span>]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>number of processors for parallel computing</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
          –
          <div class="doc-md-description">
            <p>self.grid_dict, a dictionary of one DataFrame for each grid, containing the gridding information</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;QuadTree indexing the input data</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        X_train: Training variables. Can be either a pd.DataFrame object or a string that indicate the path to the database (.duckdb or .parquet).</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">        verbosity: 0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        ax: matplotlit Axes to add to.</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        n_jobs: number of processors for parallel computing</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">        self.grid_dict, a dictionary of one DataFrame for each grid, containing the gridding information</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>    <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">check_transform_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="c1"># If the .split is being called by itself, need to initiate the joblib_tmp_dir and duckdb_config</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="n">remove_joblib_tmp_dir</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span> <span class="o">=</span> <span class="n">initiate_lazy_loading_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span> <span class="c1"># run self._cleanup when the object is being garbage collected</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span> <span class="o">=</span> <span class="n">initiate_joblib_tmp_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span> <span class="o">=</span> <span class="n">duckdb_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_mem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="n">remove_joblib_tmp_dir</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>    <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>    <span class="c1"># Determine grid_len based on conditions</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="c1"># We are using AdaSTEM</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">grid_len_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len_upper_threshold</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="n">grid_len_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len_lower_threshold</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="c1"># We are using STEM</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="n">grid_len_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="n">grid_len_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="c1">## Open connection</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">with</span> <span class="n">open_db_connection</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="c1"># Here X_train_df can be either pd.DataFrame or duckdb.DuckDBPyRelation</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;X_train_df&quot;</span><span class="p">,</span> <span class="n">X_train_df</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="c1"># spatial &amp; temporal min max</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="n">spatial1_min</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MIN(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="n">spatial1_max</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MAX(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">spatial2_min</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MIN(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">spatial2_max</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MAX(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">temporal1_min</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MIN(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">temporal1_max</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select MAX(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="si">}</span><span class="s2">) from X_train_df;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="c1"># Call spatial and temporal scale checks</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="n">check_spatial_scale</span><span class="p">(</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">spatial1_min</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="n">spatial1_max</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">spatial2_min</span><span class="p">,</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="n">spatial2_max</span><span class="p">,</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="n">grid_len_upper</span><span class="p">,</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="n">grid_len_lower</span><span class="p">,</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="n">check_temporal_scale</span><span class="p">(</span><span class="n">temporal1_min</span><span class="p">,</span> <span class="n">temporal1_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="n">spatio_bin_jitter_magnitude</span> <span class="o">=</span> <span class="n">check_transform_spatio_bin_jitter_magnitude</span><span class="p">(</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>       <span class="n">spatial1_max</span><span class="p">,</span> <span class="n">spatial1_min</span><span class="p">,</span> <span class="n">spatial2_max</span><span class="p">,</span> <span class="n">spatial2_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatio_bin_jitter_magnitude</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_gridding_plot</span><span class="p">:</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span> <span class="o">=</span> <span class="p">(</span><span class="n">spatial1_min</span><span class="p">,</span> <span class="n">spatial1_max</span><span class="p">)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span> <span class="o">=</span> <span class="p">(</span><span class="n">spatial2_min</span><span class="p">,</span> <span class="n">spatial2_max</span><span class="p">)</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Quadtree&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="k">pass</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="n">X_train_indexes</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">]]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="n">X_train_indexes</span> <span class="o">=</span> <span class="n">X_train</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>    <span class="n">partial_get_one_ensemble_quadtree</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="n">get_one_ensemble_quadtree</span><span class="p">,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="n">spatio_bin_jitter_magnitude</span><span class="o">=</span><span class="n">spatio_bin_jitter_magnitude</span><span class="p">,</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="n">temporal_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_start</span><span class="p">,</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="n">temporal_end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_end</span><span class="p">,</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="n">temporal_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_step</span><span class="p">,</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="n">temporal_bin_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_interval</span><span class="p">,</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="n">temporal_bin_start_jitter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bin_start_jitter</span><span class="p">,</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="n">data</span><span class="o">=</span><span class="n">X_train_indexes</span><span class="p">,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="n">duckdb_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="p">,</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="n">Temporal1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">,</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="n">grid_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len</span><span class="p">,</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="n">grid_len_lon_upper_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len_upper_threshold</span><span class="p">,</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">grid_len_lon_lower_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">grid_len_lat_upper_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len_upper_threshold</span><span class="p">,</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">grid_len_lat_lower_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_len_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">points_lower_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">points_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="n">plot_empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_empty</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">Spatio1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">Spatio2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="n">save_gridding_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_gridding_plot</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="n">completely_random_rotation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">completely_random_rotation</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">ensemble_bootstrap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_bootstrap</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">return_as</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_backend</span><span class="p">,</span> <span class="n">temp_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="n">output_generator</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">partial_get_one_ensemble_quadtree</span><span class="p">)(</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="n">ensemble_count</span><span class="o">=</span><span class="n">ensemble_count</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span> <span class="o">+</span> <span class="n">ensemble_count</span><span class="p">)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="k">for</span> <span class="n">ensemble_count</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">))</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="p">)</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="n">output_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">output_generator</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating Ensembles: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="n">ensemble_all_df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_generator</span><span class="p">]</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="n">get_reusable_executor</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="n">iter_func_</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating Ensembles: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_fold</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="n">ensemble_all_df_list</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="n">partial_get_one_ensemble_quadtree</span><span class="p">(</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                <span class="n">ensemble_count</span><span class="o">=</span><span class="n">ensemble_count</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span> <span class="o">+</span> <span class="n">ensemble_count</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="k">for</span> <span class="n">ensemble_count</span> <span class="ow">in</span> <span class="n">iter_func_</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="p">]</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="c1"># concat</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="n">ensemble_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ensemble_all_df_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>    <span class="k">del</span> <span class="n">ensemble_all_df_list</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="c1"># processing</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>    <span class="n">ensemble_df</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_gridding_plot</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>            <span class="k">pass</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridding_plot</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="p">,</span> <span class="n">ax</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridding_plot</span> <span class="o">=</span> <span class="n">ensemble_df</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="c1"># Finally, if joblib_tmp_dir is created only for this .split, clean it up</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>    <span class="k">if</span> <span class="n">remove_joblib_tmp_dir</span><span class="p">:</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">):</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joblib_tmp_dir</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.stixel_fitting" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stixel_fitting</span><span class="p">(</span><span class="n">stixel</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>A sub module of SAC training. Fit one stixel</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>stixel</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>data sjoined with ensemble_df.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="k">def</span><span class="w"> </span><span class="nf">stixel_fitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stixel</span><span class="p">):</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A sub module of SAC training. Fit one stixel</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">        stixel (pd.DataFrame): data sjoined with ensemble_df.</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="sd">        For a single stixel.</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>    <span class="k">if</span> <span class="s1">&#39;__index_level_0__&#39;</span> <span class="ow">in</span> <span class="n">stixel</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;__index_level_0__ should not apprear in the final training data!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>    <span class="n">unique_stixel_id</span> <span class="o">=</span> <span class="n">stixel</span><span class="p">[</span><span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>    <span class="n">ensemble_index</span> <span class="o">=</span> <span class="n">unique_stixel_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="n">base_model</span> <span class="o">=</span> <span class="n">LazyLoadingEstimator</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span> 
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>                                           <span class="n">dump_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lazy_loading_dir</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;ensemble_&#39;</span> <span class="o">+</span> <span class="n">ensemble_index</span><span class="p">),</span> 
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                                           <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;model_</span><span class="si">{</span><span class="n">unique_stixel_id</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span> 
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                                           <span class="n">auto_dump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_loaded</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>    <span class="n">model</span><span class="p">,</span> <span class="n">stixel_specific_x_names</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">train_one_stixel</span><span class="p">(</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="n">stixel_training_size_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stixel_training_size_threshold</span><span class="p">,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>        <span class="n">x_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">,</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="n">base_model</span><span class="o">=</span><span class="n">base_model</span><span class="p">,</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="n">sample_weights_for_classifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_weights_for_classifier</span><span class="p">,</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="n">subset_x_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_x_names</span><span class="p">,</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="n">stixel_X_train</span><span class="o">=</span><span class="n">stixel</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>        <span class="n">min_class_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_class_sample</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>    <span class="p">)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="c1"># print(f&#39;Fitting: {ensemble_index}. Not pass: {status}&#39;)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="k">pass</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">unique_stixel_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">stixel_specific_x_names</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.stixel_predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stixel_predict</span><span class="p">(</span><span class="n">stixel</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>A sub module of SAC prediction. Predict one stixel</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>stixel</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>data joined with ensemble_df.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.Union">Union</span>[None, <span title="pandas.DataFrame">DataFrame</span>]</code>
          –
          <div class="doc-md-description">
            <p>pd.DataFrame: the prediction result of this stixel</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-807" name="__codelineno-0-807"></a><span class="k">def</span><span class="w"> </span><span class="nf">stixel_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stixel</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A sub module of SAC prediction. Predict one stixel</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a><span class="sd">        stixel (pd.DataFrame): data joined with ensemble_df.</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a><span class="sd">        For a single stixel.</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a><span class="sd">        pd.DataFrame: the prediction result of this stixel</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>    <span class="k">if</span> <span class="s1">&#39;__index_level_0__&#39;</span> <span class="ow">in</span> <span class="n">stixel</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;__index_level_0__ should not apprear in the final training data!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stixel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># No data to predict</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>    <span class="n">unique_stixel_id</span> <span class="o">=</span> <span class="n">stixel</span><span class="p">[</span><span class="s2">&quot;unique_stixel_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>    <span class="n">model_x_names_tuple</span> <span class="o">=</span> <span class="n">get_model_and_stixel_specific_x_names</span><span class="p">(</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_dict</span><span class="p">,</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>        <span class="n">unique_stixel_id</span><span class="p">,</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stixel_specific_x_names</span><span class="p">,</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">,</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>    <span class="p">)</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>    <span class="k">if</span> <span class="n">model_x_names_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>    <span class="n">pred</span> <span class="o">=</span> <span class="n">predict_one_stixel</span><span class="p">(</span><span class="n">X_test_stixel</span><span class="o">=</span><span class="n">stixel</span><span class="p">,</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>                              <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>                              <span class="n">model_x_names_tuple</span><span class="o">=</span><span class="n">model_x_names_tuple</span><span class="p">,</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>                              <span class="n">base_model_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_method</span><span class="p">,</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>                              <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_prediction_param</span><span class="p">)</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>    <span class="k">if</span> <span class="n">pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>        <span class="k">return</span> <span class="n">pred</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEM.store_x_names" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">store_x_names</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Store the training variables</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>X_train</code></b>
              (<code>(<span title="pandas.DataFrame">DataFrame</span>, <span title="str">str</span>)</code>)
          –
          <div class="doc-md-description">
            <p>input training data.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="k">def</span><span class="w"> </span><span class="nf">store_x_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Store the training variables</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        X_train (pd.DataFrame, str): input training data.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>    <span class="c1"># store x_names</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>        <span class="k">with</span> <span class="n">open_db_connection</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_config</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="n">con</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;X_train_df&quot;</span><span class="p">,</span> <span class="n">X_train_df</span><span class="p">)</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;DESCRIBE X_train_df&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()[</span><span class="s2">&quot;column_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">==</span><span class="s1">&#39;__index_level_0__&#39;</span><span class="p">]</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_temporal_to_train</span><span class="p">:</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">):</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Temporal1</span><span class="p">)]</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Spatio1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spatio2</span><span class="p">]:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">:</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="stemflow.model.AdaSTEM.AdaSTEMClassifier" class="doc doc-heading">
            <code>AdaSTEMClassifier</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AdaSTEM (stemflow.model.AdaSTEM.AdaSTEM)" href="#stemflow.model.AdaSTEM.AdaSTEM">AdaSTEM</a></code></p>


        <p>AdaSTEM model Classifier interface</p>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>&gt;&gt;&gt; from stemflow.model.AdaSTEM import AdaSTEMClassifier
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>&gt;&gt;&gt; from xgboost import XGBClassifier
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>&gt;&gt;&gt; model = AdaSTEMClassifier(base_model=XGBClassifier(tree_method=&#39;hist&#39;,random_state=42, verbosity = 0, n_jobs=1),
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                        save_gridding_plot = True,
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                        ensemble_fold=10,
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                        min_ensemble_required=7,
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                        grid_len_upper_threshold=25,
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                        grid_len_lower_threshold=5,
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                        points_lower_threshold=50,
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                        Spatio1=&#39;longitude&#39;,
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                        Spatio2 = &#39;latitude&#39;,
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                        Temporal1 = &#39;DOY&#39;,
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                        use_temporal_to_train=True)
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>&gt;&gt;&gt; model.fit(X_train, y_train)
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>&gt;&gt;&gt; pred = model.predict(X_test)
</code></pre></div>
</details>







              <details class="quote">
                <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span>
<span class="normal"><a href="#__codelineno-0-1548">1548</a></span>
<span class="normal"><a href="#__codelineno-0-1549">1549</a></span>
<span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span>
<span class="normal"><a href="#__codelineno-0-1568">1568</a></span>
<span class="normal"><a href="#__codelineno-0-1569">1569</a></span>
<span class="normal"><a href="#__codelineno-0-1570">1570</a></span>
<span class="normal"><a href="#__codelineno-0-1571">1571</a></span>
<span class="normal"><a href="#__codelineno-0-1572">1572</a></span>
<span class="normal"><a href="#__codelineno-0-1573">1573</a></span>
<span class="normal"><a href="#__codelineno-0-1574">1574</a></span>
<span class="normal"><a href="#__codelineno-0-1575">1575</a></span>
<span class="normal"><a href="#__codelineno-0-1576">1576</a></span>
<span class="normal"><a href="#__codelineno-0-1577">1577</a></span>
<span class="normal"><a href="#__codelineno-0-1578">1578</a></span>
<span class="normal"><a href="#__codelineno-0-1579">1579</a></span>
<span class="normal"><a href="#__codelineno-0-1580">1580</a></span>
<span class="normal"><a href="#__codelineno-0-1581">1581</a></span>
<span class="normal"><a href="#__codelineno-0-1582">1582</a></span>
<span class="normal"><a href="#__codelineno-0-1583">1583</a></span>
<span class="normal"><a href="#__codelineno-0-1584">1584</a></span>
<span class="normal"><a href="#__codelineno-0-1585">1585</a></span>
<span class="normal"><a href="#__codelineno-0-1586">1586</a></span>
<span class="normal"><a href="#__codelineno-0-1587">1587</a></span>
<span class="normal"><a href="#__codelineno-0-1588">1588</a></span>
<span class="normal"><a href="#__codelineno-0-1589">1589</a></span>
<span class="normal"><a href="#__codelineno-0-1590">1590</a></span>
<span class="normal"><a href="#__codelineno-0-1591">1591</a></span>
<span class="normal"><a href="#__codelineno-0-1592">1592</a></span>
<span class="normal"><a href="#__codelineno-0-1593">1593</a></span>
<span class="normal"><a href="#__codelineno-0-1594">1594</a></span>
<span class="normal"><a href="#__codelineno-0-1595">1595</a></span>
<span class="normal"><a href="#__codelineno-0-1596">1596</a></span>
<span class="normal"><a href="#__codelineno-0-1597">1597</a></span>
<span class="normal"><a href="#__codelineno-0-1598">1598</a></span>
<span class="normal"><a href="#__codelineno-0-1599">1599</a></span>
<span class="normal"><a href="#__codelineno-0-1600">1600</a></span>
<span class="normal"><a href="#__codelineno-0-1601">1601</a></span>
<span class="normal"><a href="#__codelineno-0-1602">1602</a></span>
<span class="normal"><a href="#__codelineno-0-1603">1603</a></span>
<span class="normal"><a href="#__codelineno-0-1604">1604</a></span>
<span class="normal"><a href="#__codelineno-0-1605">1605</a></span>
<span class="normal"><a href="#__codelineno-0-1606">1606</a></span>
<span class="normal"><a href="#__codelineno-0-1607">1607</a></span>
<span class="normal"><a href="#__codelineno-0-1608">1608</a></span>
<span class="normal"><a href="#__codelineno-0-1609">1609</a></span>
<span class="normal"><a href="#__codelineno-0-1610">1610</a></span>
<span class="normal"><a href="#__codelineno-0-1611">1611</a></span>
<span class="normal"><a href="#__codelineno-0-1612">1612</a></span>
<span class="normal"><a href="#__codelineno-0-1613">1613</a></span>
<span class="normal"><a href="#__codelineno-0-1614">1614</a></span>
<span class="normal"><a href="#__codelineno-0-1615">1615</a></span>
<span class="normal"><a href="#__codelineno-0-1616">1616</a></span>
<span class="normal"><a href="#__codelineno-0-1617">1617</a></span>
<span class="normal"><a href="#__codelineno-0-1618">1618</a></span>
<span class="normal"><a href="#__codelineno-0-1619">1619</a></span>
<span class="normal"><a href="#__codelineno-0-1620">1620</a></span>
<span class="normal"><a href="#__codelineno-0-1621">1621</a></span>
<span class="normal"><a href="#__codelineno-0-1622">1622</a></span>
<span class="normal"><a href="#__codelineno-0-1623">1623</a></span>
<span class="normal"><a href="#__codelineno-0-1624">1624</a></span>
<span class="normal"><a href="#__codelineno-0-1625">1625</a></span>
<span class="normal"><a href="#__codelineno-0-1626">1626</a></span>
<span class="normal"><a href="#__codelineno-0-1627">1627</a></span>
<span class="normal"><a href="#__codelineno-0-1628">1628</a></span>
<span class="normal"><a href="#__codelineno-0-1629">1629</a></span>
<span class="normal"><a href="#__codelineno-0-1630">1630</a></span>
<span class="normal"><a href="#__codelineno-0-1631">1631</a></span>
<span class="normal"><a href="#__codelineno-0-1632">1632</a></span>
<span class="normal"><a href="#__codelineno-0-1633">1633</a></span>
<span class="normal"><a href="#__codelineno-0-1634">1634</a></span>
<span class="normal"><a href="#__codelineno-0-1635">1635</a></span>
<span class="normal"><a href="#__codelineno-0-1636">1636</a></span>
<span class="normal"><a href="#__codelineno-0-1637">1637</a></span>
<span class="normal"><a href="#__codelineno-0-1638">1638</a></span>
<span class="normal"><a href="#__codelineno-0-1639">1639</a></span>
<span class="normal"><a href="#__codelineno-0-1640">1640</a></span>
<span class="normal"><a href="#__codelineno-0-1641">1641</a></span>
<span class="normal"><a href="#__codelineno-0-1642">1642</a></span>
<span class="normal"><a href="#__codelineno-0-1643">1643</a></span>
<span class="normal"><a href="#__codelineno-0-1644">1644</a></span>
<span class="normal"><a href="#__codelineno-0-1645">1645</a></span>
<span class="normal"><a href="#__codelineno-0-1646">1646</a></span>
<span class="normal"><a href="#__codelineno-0-1647">1647</a></span>
<span class="normal"><a href="#__codelineno-0-1648">1648</a></span>
<span class="normal"><a href="#__codelineno-0-1649">1649</a></span>
<span class="normal"><a href="#__codelineno-0-1650">1650</a></span>
<span class="normal"><a href="#__codelineno-0-1651">1651</a></span>
<span class="normal"><a href="#__codelineno-0-1652">1652</a></span>
<span class="normal"><a href="#__codelineno-0-1653">1653</a></span>
<span class="normal"><a href="#__codelineno-0-1654">1654</a></span>
<span class="normal"><a href="#__codelineno-0-1655">1655</a></span>
<span class="normal"><a href="#__codelineno-0-1656">1656</a></span>
<span class="normal"><a href="#__codelineno-0-1657">1657</a></span>
<span class="normal"><a href="#__codelineno-0-1658">1658</a></span>
<span class="normal"><a href="#__codelineno-0-1659">1659</a></span>
<span class="normal"><a href="#__codelineno-0-1660">1660</a></span>
<span class="normal"><a href="#__codelineno-0-1661">1661</a></span>
<span class="normal"><a href="#__codelineno-0-1662">1662</a></span>
<span class="normal"><a href="#__codelineno-0-1663">1663</a></span>
<span class="normal"><a href="#__codelineno-0-1664">1664</a></span>
<span class="normal"><a href="#__codelineno-0-1665">1665</a></span>
<span class="normal"><a href="#__codelineno-0-1666">1666</a></span>
<span class="normal"><a href="#__codelineno-0-1667">1667</a></span>
<span class="normal"><a href="#__codelineno-0-1668">1668</a></span>
<span class="normal"><a href="#__codelineno-0-1669">1669</a></span>
<span class="normal"><a href="#__codelineno-0-1670">1670</a></span>
<span class="normal"><a href="#__codelineno-0-1671">1671</a></span>
<span class="normal"><a href="#__codelineno-0-1672">1672</a></span>
<span class="normal"><a href="#__codelineno-0-1673">1673</a></span>
<span class="normal"><a href="#__codelineno-0-1674">1674</a></span>
<span class="normal"><a href="#__codelineno-0-1675">1675</a></span>
<span class="normal"><a href="#__codelineno-0-1676">1676</a></span>
<span class="normal"><a href="#__codelineno-0-1677">1677</a></span>
<span class="normal"><a href="#__codelineno-0-1678">1678</a></span>
<span class="normal"><a href="#__codelineno-0-1679">1679</a></span>
<span class="normal"><a href="#__codelineno-0-1680">1680</a></span>
<span class="normal"><a href="#__codelineno-0-1681">1681</a></span>
<span class="normal"><a href="#__codelineno-0-1682">1682</a></span>
<span class="normal"><a href="#__codelineno-0-1683">1683</a></span>
<span class="normal"><a href="#__codelineno-0-1684">1684</a></span>
<span class="normal"><a href="#__codelineno-0-1685">1685</a></span>
<span class="normal"><a href="#__codelineno-0-1686">1686</a></span>
<span class="normal"><a href="#__codelineno-0-1687">1687</a></span>
<span class="normal"><a href="#__codelineno-0-1688">1688</a></span>
<span class="normal"><a href="#__codelineno-0-1689">1689</a></span>
<span class="normal"><a href="#__codelineno-0-1690">1690</a></span>
<span class="normal"><a href="#__codelineno-0-1691">1691</a></span>
<span class="normal"><a href="#__codelineno-0-1692">1692</a></span>
<span class="normal"><a href="#__codelineno-0-1693">1693</a></span>
<span class="normal"><a href="#__codelineno-0-1694">1694</a></span>
<span class="normal"><a href="#__codelineno-0-1695">1695</a></span>
<span class="normal"><a href="#__codelineno-0-1696">1696</a></span>
<span class="normal"><a href="#__codelineno-0-1697">1697</a></span>
<span class="normal"><a href="#__codelineno-0-1698">1698</a></span>
<span class="normal"><a href="#__codelineno-0-1699">1699</a></span>
<span class="normal"><a href="#__codelineno-0-1700">1700</a></span>
<span class="normal"><a href="#__codelineno-0-1701">1701</a></span>
<span class="normal"><a href="#__codelineno-0-1702">1702</a></span>
<span class="normal"><a href="#__codelineno-0-1703">1703</a></span>
<span class="normal"><a href="#__codelineno-0-1704">1704</a></span>
<span class="normal"><a href="#__codelineno-0-1705">1705</a></span>
<span class="normal"><a href="#__codelineno-0-1706">1706</a></span>
<span class="normal"><a href="#__codelineno-0-1707">1707</a></span>
<span class="normal"><a href="#__codelineno-0-1708">1708</a></span>
<span class="normal"><a href="#__codelineno-0-1709">1709</a></span>
<span class="normal"><a href="#__codelineno-0-1710">1710</a></span>
<span class="normal"><a href="#__codelineno-0-1711">1711</a></span>
<span class="normal"><a href="#__codelineno-0-1712">1712</a></span>
<span class="normal"><a href="#__codelineno-0-1713">1713</a></span>
<span class="normal"><a href="#__codelineno-0-1714">1714</a></span>
<span class="normal"><a href="#__codelineno-0-1715">1715</a></span>
<span class="normal"><a href="#__codelineno-0-1716">1716</a></span>
<span class="normal"><a href="#__codelineno-0-1717">1717</a></span>
<span class="normal"><a href="#__codelineno-0-1718">1718</a></span>
<span class="normal"><a href="#__codelineno-0-1719">1719</a></span>
<span class="normal"><a href="#__codelineno-0-1720">1720</a></span>
<span class="normal"><a href="#__codelineno-0-1721">1721</a></span>
<span class="normal"><a href="#__codelineno-0-1722">1722</a></span>
<span class="normal"><a href="#__codelineno-0-1723">1723</a></span>
<span class="normal"><a href="#__codelineno-0-1724">1724</a></span>
<span class="normal"><a href="#__codelineno-0-1725">1725</a></span>
<span class="normal"><a href="#__codelineno-0-1726">1726</a></span>
<span class="normal"><a href="#__codelineno-0-1727">1727</a></span>
<span class="normal"><a href="#__codelineno-0-1728">1728</a></span>
<span class="normal"><a href="#__codelineno-0-1729">1729</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1539" name="__codelineno-0-1539"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdaSTEMClassifier</span><span class="p">(</span><span class="n">AdaSTEM</span><span class="p">):</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;AdaSTEM model Classifier interface</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a><span class="sd">        ```</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a><span class="sd">        &gt;&gt;&gt; from stemflow.model.AdaSTEM import AdaSTEMClassifier</span>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a><span class="sd">        &gt;&gt;&gt; from xgboost import XGBClassifier</span>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a><span class="sd">        &gt;&gt;&gt; model = AdaSTEMClassifier(base_model=XGBClassifier(tree_method=&#39;hist&#39;,random_state=42, verbosity = 0, n_jobs=1),</span>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a><span class="sd">                                save_gridding_plot = True,</span>
<a id="__codelineno-0-1548" name="__codelineno-0-1548"></a><span class="sd">                                ensemble_fold=10,</span>
<a id="__codelineno-0-1549" name="__codelineno-0-1549"></a><span class="sd">                                min_ensemble_required=7,</span>
<a id="__codelineno-0-1550" name="__codelineno-0-1550"></a><span class="sd">                                grid_len_upper_threshold=25,</span>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a><span class="sd">                                grid_len_lower_threshold=5,</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a><span class="sd">                                points_lower_threshold=50,</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a><span class="sd">                                Spatio1=&#39;longitude&#39;,</span>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a><span class="sd">                                Spatio2 = &#39;latitude&#39;,</span>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a><span class="sd">                                Temporal1 = &#39;DOY&#39;,</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a><span class="sd">                                use_temporal_to_train=True)</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a><span class="sd">        &gt;&gt;&gt; model.fit(X_train, y_train)</span>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a><span class="sd">        &gt;&gt;&gt; pred = model.predict(X_test)</span>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a><span class="sd">        ```</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>        <span class="n">base_model</span><span class="p">,</span>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>        <span class="n">task</span><span class="o">=</span><span class="s2">&quot;classification&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>        <span class="n">ensemble_fold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-1568" name="__codelineno-0-1568"></a>        <span class="n">min_ensemble_required</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
<a id="__codelineno-0-1569" name="__codelineno-0-1569"></a>        <span class="n">grid_len_upper_threshold</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-0-1570" name="__codelineno-0-1570"></a>        <span class="n">grid_len_lower_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-1571" name="__codelineno-0-1571"></a>        <span class="n">points_lower_threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-1572" name="__codelineno-0-1572"></a>        <span class="n">stixel_training_size_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1573" name="__codelineno-0-1573"></a>        <span class="n">temporal_start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1574" name="__codelineno-0-1574"></a>        <span class="n">temporal_end</span><span class="o">=</span><span class="mi">366</span><span class="p">,</span>
<a id="__codelineno-0-1575" name="__codelineno-0-1575"></a>        <span class="n">temporal_step</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-1576" name="__codelineno-0-1576"></a>        <span class="n">temporal_bin_interval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-1577" name="__codelineno-0-1577"></a>        <span class="n">temporal_bin_start_jitter</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1578" name="__codelineno-0-1578"></a>        <span class="n">spatio_bin_jitter_magnitude</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1579" name="__codelineno-0-1579"></a>        <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1580" name="__codelineno-0-1580"></a>        <span class="n">save_gridding_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1581" name="__codelineno-0-1581"></a>        <span class="n">sample_weights_for_classifier</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1582" name="__codelineno-0-1582"></a>        <span class="n">Spatio1</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1583" name="__codelineno-0-1583"></a>        <span class="n">Spatio2</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1584" name="__codelineno-0-1584"></a>        <span class="n">Temporal1</span><span class="o">=</span><span class="s2">&quot;DOY&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1585" name="__codelineno-0-1585"></a>        <span class="n">use_temporal_to_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1586" name="__codelineno-0-1586"></a>        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1587" name="__codelineno-0-1587"></a>        <span class="n">subset_x_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1588" name="__codelineno-0-1588"></a>        <span class="n">plot_xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1589" name="__codelineno-0-1589"></a>        <span class="n">plot_ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1590" name="__codelineno-0-1590"></a>        <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-1591" name="__codelineno-0-1591"></a>        <span class="n">plot_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1592" name="__codelineno-0-1592"></a>        <span class="n">completely_random_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1593" name="__codelineno-0-1593"></a>        <span class="n">lazy_loading</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1594" name="__codelineno-0-1594"></a>        <span class="n">lazy_loading_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1595" name="__codelineno-0-1595"></a>        <span class="n">min_class_sample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1596" name="__codelineno-0-1596"></a>        <span class="n">ensemble_bootstrap</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1597" name="__codelineno-0-1597"></a>        <span class="n">joblib_backend</span> <span class="o">=</span> <span class="s1">&#39;loky&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1598" name="__codelineno-0-1598"></a>        <span class="n">max_mem</span> <span class="o">=</span> <span class="s1">&#39;2GB&#39;</span>
<a id="__codelineno-0-1599" name="__codelineno-0-1599"></a>    <span class="p">):</span>
<a id="__codelineno-0-1600" name="__codelineno-0-1600"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-1601" name="__codelineno-0-1601"></a>            <span class="n">base_model</span><span class="o">=</span><span class="n">base_model</span><span class="p">,</span>
<a id="__codelineno-0-1602" name="__codelineno-0-1602"></a>            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
<a id="__codelineno-0-1603" name="__codelineno-0-1603"></a>            <span class="n">ensemble_fold</span><span class="o">=</span><span class="n">ensemble_fold</span><span class="p">,</span>
<a id="__codelineno-0-1604" name="__codelineno-0-1604"></a>            <span class="n">min_ensemble_required</span><span class="o">=</span><span class="n">min_ensemble_required</span><span class="p">,</span>
<a id="__codelineno-0-1605" name="__codelineno-0-1605"></a>            <span class="n">grid_len_upper_threshold</span><span class="o">=</span><span class="n">grid_len_upper_threshold</span><span class="p">,</span>
<a id="__codelineno-0-1606" name="__codelineno-0-1606"></a>            <span class="n">grid_len_lower_threshold</span><span class="o">=</span><span class="n">grid_len_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-1607" name="__codelineno-0-1607"></a>            <span class="n">points_lower_threshold</span><span class="o">=</span><span class="n">points_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-1608" name="__codelineno-0-1608"></a>            <span class="n">stixel_training_size_threshold</span><span class="o">=</span><span class="n">stixel_training_size_threshold</span><span class="p">,</span>
<a id="__codelineno-0-1609" name="__codelineno-0-1609"></a>            <span class="n">temporal_start</span><span class="o">=</span><span class="n">temporal_start</span><span class="p">,</span>
<a id="__codelineno-0-1610" name="__codelineno-0-1610"></a>            <span class="n">temporal_end</span><span class="o">=</span><span class="n">temporal_end</span><span class="p">,</span>
<a id="__codelineno-0-1611" name="__codelineno-0-1611"></a>            <span class="n">temporal_step</span><span class="o">=</span><span class="n">temporal_step</span><span class="p">,</span>
<a id="__codelineno-0-1612" name="__codelineno-0-1612"></a>            <span class="n">temporal_bin_interval</span><span class="o">=</span><span class="n">temporal_bin_interval</span><span class="p">,</span>
<a id="__codelineno-0-1613" name="__codelineno-0-1613"></a>            <span class="n">temporal_bin_start_jitter</span><span class="o">=</span><span class="n">temporal_bin_start_jitter</span><span class="p">,</span>
<a id="__codelineno-0-1614" name="__codelineno-0-1614"></a>            <span class="n">spatio_bin_jitter_magnitude</span><span class="o">=</span><span class="n">spatio_bin_jitter_magnitude</span><span class="p">,</span>
<a id="__codelineno-0-1615" name="__codelineno-0-1615"></a>            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
<a id="__codelineno-0-1616" name="__codelineno-0-1616"></a>            <span class="n">save_gridding_plot</span><span class="o">=</span><span class="n">save_gridding_plot</span><span class="p">,</span>
<a id="__codelineno-0-1617" name="__codelineno-0-1617"></a>            <span class="n">sample_weights_for_classifier</span><span class="o">=</span><span class="n">sample_weights_for_classifier</span><span class="p">,</span>
<a id="__codelineno-0-1618" name="__codelineno-0-1618"></a>            <span class="n">Spatio1</span><span class="o">=</span><span class="n">Spatio1</span><span class="p">,</span>
<a id="__codelineno-0-1619" name="__codelineno-0-1619"></a>            <span class="n">Spatio2</span><span class="o">=</span><span class="n">Spatio2</span><span class="p">,</span>
<a id="__codelineno-0-1620" name="__codelineno-0-1620"></a>            <span class="n">Temporal1</span><span class="o">=</span><span class="n">Temporal1</span><span class="p">,</span>
<a id="__codelineno-0-1621" name="__codelineno-0-1621"></a>            <span class="n">use_temporal_to_train</span><span class="o">=</span><span class="n">use_temporal_to_train</span><span class="p">,</span>
<a id="__codelineno-0-1622" name="__codelineno-0-1622"></a>            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<a id="__codelineno-0-1623" name="__codelineno-0-1623"></a>            <span class="n">subset_x_names</span><span class="o">=</span><span class="n">subset_x_names</span><span class="p">,</span>
<a id="__codelineno-0-1624" name="__codelineno-0-1624"></a>            <span class="n">plot_xlims</span><span class="o">=</span><span class="n">plot_xlims</span><span class="p">,</span>
<a id="__codelineno-0-1625" name="__codelineno-0-1625"></a>            <span class="n">plot_ylims</span><span class="o">=</span><span class="n">plot_ylims</span><span class="p">,</span>
<a id="__codelineno-0-1626" name="__codelineno-0-1626"></a>            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
<a id="__codelineno-0-1627" name="__codelineno-0-1627"></a>            <span class="n">plot_empty</span><span class="o">=</span><span class="n">plot_empty</span><span class="p">,</span>
<a id="__codelineno-0-1628" name="__codelineno-0-1628"></a>            <span class="n">completely_random_rotation</span><span class="o">=</span><span class="n">completely_random_rotation</span><span class="p">,</span>
<a id="__codelineno-0-1629" name="__codelineno-0-1629"></a>            <span class="n">lazy_loading</span><span class="o">=</span><span class="n">lazy_loading</span><span class="p">,</span>
<a id="__codelineno-0-1630" name="__codelineno-0-1630"></a>            <span class="n">lazy_loading_dir</span><span class="o">=</span><span class="n">lazy_loading_dir</span><span class="p">,</span>
<a id="__codelineno-0-1631" name="__codelineno-0-1631"></a>            <span class="n">min_class_sample</span><span class="o">=</span><span class="n">min_class_sample</span><span class="p">,</span>
<a id="__codelineno-0-1632" name="__codelineno-0-1632"></a>            <span class="n">ensemble_bootstrap</span><span class="o">=</span><span class="n">ensemble_bootstrap</span><span class="p">,</span>
<a id="__codelineno-0-1633" name="__codelineno-0-1633"></a>            <span class="n">joblib_backend</span><span class="o">=</span><span class="n">joblib_backend</span><span class="p">,</span>
<a id="__codelineno-0-1634" name="__codelineno-0-1634"></a>            <span class="n">max_mem</span><span class="o">=</span><span class="n">max_mem</span>
<a id="__codelineno-0-1635" name="__codelineno-0-1635"></a>        <span class="p">)</span>
<a id="__codelineno-0-1636" name="__codelineno-0-1636"></a>
<a id="__codelineno-0-1637" name="__codelineno-0-1637"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_estimator_type</span> <span class="o">=</span> <span class="s1">&#39;classifier&#39;</span>
<a id="__codelineno-0-1638" name="__codelineno-0-1638"></a>
<a id="__codelineno-0-1639" name="__codelineno-0-1639"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
<a id="__codelineno-0-1640" name="__codelineno-0-1640"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1641" name="__codelineno-0-1641"></a>        <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-1642" name="__codelineno-0-1642"></a>        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1643" name="__codelineno-0-1643"></a>        <span class="n">return_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1644" name="__codelineno-0-1644"></a>        <span class="n">cls_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-0-1645" name="__codelineno-0-1645"></a>        <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1646" name="__codelineno-0-1646"></a>        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1647" name="__codelineno-0-1647"></a>        <span class="n">return_by_separate_ensembles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1648" name="__codelineno-0-1648"></a>        <span class="n">logit_agg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1649" name="__codelineno-0-1649"></a>        <span class="n">base_model_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1650" name="__codelineno-0-1650"></a>        <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1651" name="__codelineno-0-1651"></a>        <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1652" name="__codelineno-0-1652"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-1653" name="__codelineno-0-1653"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A rewrite of predict_proba adapted for Classifier</span>
<a id="__codelineno-0-1654" name="__codelineno-0-1654"></a>
<a id="__codelineno-0-1655" name="__codelineno-0-1655"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1656" name="__codelineno-0-1656"></a><span class="sd">            X_test (pd.DataFrame):</span>
<a id="__codelineno-0-1657" name="__codelineno-0-1657"></a><span class="sd">                Testing variables.</span>
<a id="__codelineno-0-1658" name="__codelineno-0-1658"></a><span class="sd">            verbosity (int, optional):</span>
<a id="__codelineno-0-1659" name="__codelineno-0-1659"></a><span class="sd">                0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</span>
<a id="__codelineno-0-1660" name="__codelineno-0-1660"></a><span class="sd">            return_std (bool, optional):</span>
<a id="__codelineno-0-1661" name="__codelineno-0-1661"></a><span class="sd">                Whether return the standard deviation among ensembles. Defaults to False.</span>
<a id="__codelineno-0-1662" name="__codelineno-0-1662"></a><span class="sd">            cls_threshold (float, optional):</span>
<a id="__codelineno-0-1663" name="__codelineno-0-1663"></a><span class="sd">                Cutting threshold for the classification.</span>
<a id="__codelineno-0-1664" name="__codelineno-0-1664"></a><span class="sd">                Values above cls_threshold will be labeled as 1 and 0 otherwise.</span>
<a id="__codelineno-0-1665" name="__codelineno-0-1665"></a><span class="sd">                Defaults to 0.5.</span>
<a id="__codelineno-0-1666" name="__codelineno-0-1666"></a><span class="sd">            n_jobs (Union[int, None], optional):</span>
<a id="__codelineno-0-1667" name="__codelineno-0-1667"></a><span class="sd">                Number of processes used in this task. If None, use the self.n_jobs. Default to None.</span>
<a id="__codelineno-0-1668" name="__codelineno-0-1668"></a><span class="sd">                In practice, multi-processing might to slow down the process instead of speeding up. Suggest some adapted experiments.</span>
<a id="__codelineno-0-1669" name="__codelineno-0-1669"></a><span class="sd">                Could be more practical with large amount of data.</span>
<a id="__codelineno-0-1670" name="__codelineno-0-1670"></a><span class="sd">            aggregation (str, optional):</span>
<a id="__codelineno-0-1671" name="__codelineno-0-1671"></a><span class="sd">                &#39;mean&#39; or &#39;median&#39; for aggregation method across ensembles.</span>
<a id="__codelineno-0-1672" name="__codelineno-0-1672"></a><span class="sd">            return_by_separate_ensembles (bool, optional):</span>
<a id="__codelineno-0-1673" name="__codelineno-0-1673"></a><span class="sd">                Experimental function. return not by aggregation, but by separate ensembles.</span>
<a id="__codelineno-0-1674" name="__codelineno-0-1674"></a><span class="sd">            logit_agg:</span>
<a id="__codelineno-0-1675" name="__codelineno-0-1675"></a><span class="sd">                Whether to use logit aggregation for the classification task. If True, the model is averaging the probability prediction estimated by all ensembles in logit scale, and then back-tranform it to probability scale. It&#39;s recommened to be combinedly used with the CalibratedClassifierCV class in sklearn as a wrapper of the classifier to estimate the calibrated probability.</span>
<a id="__codelineno-0-1676" name="__codelineno-0-1676"></a><span class="sd">            base_model_method:</span>
<a id="__codelineno-0-1677" name="__codelineno-0-1677"></a><span class="sd">                The name of the prediction method for base models. If None, `predict` or `predict_proba` will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Defaults to None.</span>
<a id="__codelineno-0-1678" name="__codelineno-0-1678"></a><span class="sd">            temporal_window_prequery: </span>
<a id="__codelineno-0-1679" name="__codelineno-0-1679"></a><span class="sd">                Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-1680" name="__codelineno-0-1680"></a><span class="sd">            base_model_prediction_param:</span>
<a id="__codelineno-0-1681" name="__codelineno-0-1681"></a><span class="sd">                Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={&#39;n_jobs&#39;:1}.</span>
<a id="__codelineno-0-1682" name="__codelineno-0-1682"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-1683" name="__codelineno-0-1683"></a><span class="sd">            TypeError:</span>
<a id="__codelineno-0-1684" name="__codelineno-0-1684"></a><span class="sd">                X_test is not of type pd.DataFrame.</span>
<a id="__codelineno-0-1685" name="__codelineno-0-1685"></a><span class="sd">            ValueError:</span>
<a id="__codelineno-0-1686" name="__codelineno-0-1686"></a><span class="sd">                aggregation is not in [&#39;mean&#39;,&#39;median&#39;].</span>
<a id="__codelineno-0-1687" name="__codelineno-0-1687"></a>
<a id="__codelineno-0-1688" name="__codelineno-0-1688"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-1689" name="__codelineno-0-1689"></a><span class="sd">            predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</span>
<a id="__codelineno-0-1690" name="__codelineno-0-1690"></a>
<a id="__codelineno-0-1691" name="__codelineno-0-1691"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1692" name="__codelineno-0-1692"></a>        <span class="k">if</span> <span class="n">return_by_separate_ensembles</span><span class="o">!=</span><span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-1693" name="__codelineno-0-1693"></a>            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;If you want to return by separate ensembles in this classifier, use it in .predict_proba, instead of .predict.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1694" name="__codelineno-0-1694"></a>
<a id="__codelineno-0-1695" name="__codelineno-0-1695"></a>        <span class="k">if</span> <span class="n">return_std</span><span class="p">:</span>
<a id="__codelineno-0-1696" name="__codelineno-0-1696"></a>            <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
<a id="__codelineno-0-1697" name="__codelineno-0-1697"></a>                <span class="n">X_test</span><span class="p">,</span>
<a id="__codelineno-0-1698" name="__codelineno-0-1698"></a>                <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
<a id="__codelineno-0-1699" name="__codelineno-0-1699"></a>                <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1700" name="__codelineno-0-1700"></a>                <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<a id="__codelineno-0-1701" name="__codelineno-0-1701"></a>                <span class="n">aggregation</span><span class="o">=</span><span class="n">aggregation</span><span class="p">,</span>
<a id="__codelineno-0-1702" name="__codelineno-0-1702"></a>                <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="n">return_by_separate_ensembles</span><span class="p">,</span>
<a id="__codelineno-0-1703" name="__codelineno-0-1703"></a>                <span class="n">logit_agg</span><span class="o">=</span><span class="n">logit_agg</span><span class="p">,</span>
<a id="__codelineno-0-1704" name="__codelineno-0-1704"></a>                <span class="n">base_model_method</span><span class="o">=</span><span class="n">base_model_method</span><span class="p">,</span>
<a id="__codelineno-0-1705" name="__codelineno-0-1705"></a>                <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">,</span>
<a id="__codelineno-0-1706" name="__codelineno-0-1706"></a>                <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1707" name="__codelineno-0-1707"></a>            <span class="p">)</span>
<a id="__codelineno-0-1708" name="__codelineno-0-1708"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1709" name="__codelineno-0-1709"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean</span> <span class="o">&lt;</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<a id="__codelineno-0-1710" name="__codelineno-0-1710"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean</span> <span class="o">&gt;=</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<a id="__codelineno-0-1711" name="__codelineno-0-1711"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;This is a classification task. The standard deviation of the prediction is output at logit scale! The mean prediction is output at probability scale.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1712" name="__codelineno-0-1712"></a>            <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="c1"># notice! the std</span>
<a id="__codelineno-0-1713" name="__codelineno-0-1713"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1714" name="__codelineno-0-1714"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
<a id="__codelineno-0-1715" name="__codelineno-0-1715"></a>                <span class="n">X_test</span><span class="p">,</span>
<a id="__codelineno-0-1716" name="__codelineno-0-1716"></a>                <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
<a id="__codelineno-0-1717" name="__codelineno-0-1717"></a>                <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1718" name="__codelineno-0-1718"></a>                <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<a id="__codelineno-0-1719" name="__codelineno-0-1719"></a>                <span class="n">aggregation</span><span class="o">=</span><span class="n">aggregation</span><span class="p">,</span>
<a id="__codelineno-0-1720" name="__codelineno-0-1720"></a>                <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="n">return_by_separate_ensembles</span><span class="p">,</span>
<a id="__codelineno-0-1721" name="__codelineno-0-1721"></a>                <span class="n">logit_agg</span><span class="o">=</span><span class="n">logit_agg</span><span class="p">,</span>
<a id="__codelineno-0-1722" name="__codelineno-0-1722"></a>                <span class="n">base_model_method</span><span class="o">=</span><span class="n">base_model_method</span><span class="p">,</span>
<a id="__codelineno-0-1723" name="__codelineno-0-1723"></a>                <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">,</span>
<a id="__codelineno-0-1724" name="__codelineno-0-1724"></a>                <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1725" name="__codelineno-0-1725"></a>            <span class="p">)</span>
<a id="__codelineno-0-1726" name="__codelineno-0-1726"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1727" name="__codelineno-0-1727"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean</span> <span class="o">&lt;</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<a id="__codelineno-0-1728" name="__codelineno-0-1728"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean</span> <span class="o">&gt;=</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<a id="__codelineno-0-1729" name="__codelineno-0-1729"></a>            <span class="k">return</span> <span class="n">mean</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEMClassifier.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cls_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logit_agg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_model_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">base_model_prediction_param</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>A rewrite of predict_proba adapted for Classifier</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>X_test</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>Testing variables.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosity</code></b>
              (<code><span title="int">int</span></code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>return_std</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether return the standard deviation among ensembles. Defaults to False.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>cls_threshold</code></b>
              (<code><span title="float">float</span></code>, default:
                  <code>0.5</code>
)
          –
          <div class="doc-md-description">
            <p>Cutting threshold for the classification.
Values above cls_threshold will be labeled as 1 and 0 otherwise.
Defaults to 0.5.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>n_jobs</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="int">int</span>, None]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Number of processes used in this task. If None, use the self.n_jobs. Default to None.
In practice, multi-processing might to slow down the process instead of speeding up. Suggest some adapted experiments.
Could be more practical with large amount of data.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>aggregation</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;mean&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>'mean' or 'median' for aggregation method across ensembles.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>return_by_separate_ensembles</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Experimental function. return not by aggregation, but by separate ensembles.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>logit_agg</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to use logit aggregation for the classification task. If True, the model is averaging the probability prediction estimated by all ensembles in logit scale, and then back-tranform it to probability scale. It's recommened to be combinedly used with the CalibratedClassifierCV class in sklearn as a wrapper of the classifier to estimate the calibrated probability.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>base_model_method</code></b>
              (<code><span title="typing.Union">Union</span>[None, <span title="str">str</span>]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>The name of the prediction method for base models. If None, <code>predict</code> or <code>predict_proba</code> will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Defaults to None.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_window_prequery</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>base_model_prediction_param</code></b>
          –
          <div class="doc-md-description">
            <p>Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={'n_jobs':1}.</p>
          </div>
        </li>
    </ul>
        <p>Raises:
    TypeError:
        X_test is not of type pd.DataFrame.
    ValueError:
        aggregation is not in ['mean','median'].</p>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>]]</code>
          –
          <div class="doc-md-description">
            <p>predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1639">1639</a></span>
<span class="normal"><a href="#__codelineno-0-1640">1640</a></span>
<span class="normal"><a href="#__codelineno-0-1641">1641</a></span>
<span class="normal"><a href="#__codelineno-0-1642">1642</a></span>
<span class="normal"><a href="#__codelineno-0-1643">1643</a></span>
<span class="normal"><a href="#__codelineno-0-1644">1644</a></span>
<span class="normal"><a href="#__codelineno-0-1645">1645</a></span>
<span class="normal"><a href="#__codelineno-0-1646">1646</a></span>
<span class="normal"><a href="#__codelineno-0-1647">1647</a></span>
<span class="normal"><a href="#__codelineno-0-1648">1648</a></span>
<span class="normal"><a href="#__codelineno-0-1649">1649</a></span>
<span class="normal"><a href="#__codelineno-0-1650">1650</a></span>
<span class="normal"><a href="#__codelineno-0-1651">1651</a></span>
<span class="normal"><a href="#__codelineno-0-1652">1652</a></span>
<span class="normal"><a href="#__codelineno-0-1653">1653</a></span>
<span class="normal"><a href="#__codelineno-0-1654">1654</a></span>
<span class="normal"><a href="#__codelineno-0-1655">1655</a></span>
<span class="normal"><a href="#__codelineno-0-1656">1656</a></span>
<span class="normal"><a href="#__codelineno-0-1657">1657</a></span>
<span class="normal"><a href="#__codelineno-0-1658">1658</a></span>
<span class="normal"><a href="#__codelineno-0-1659">1659</a></span>
<span class="normal"><a href="#__codelineno-0-1660">1660</a></span>
<span class="normal"><a href="#__codelineno-0-1661">1661</a></span>
<span class="normal"><a href="#__codelineno-0-1662">1662</a></span>
<span class="normal"><a href="#__codelineno-0-1663">1663</a></span>
<span class="normal"><a href="#__codelineno-0-1664">1664</a></span>
<span class="normal"><a href="#__codelineno-0-1665">1665</a></span>
<span class="normal"><a href="#__codelineno-0-1666">1666</a></span>
<span class="normal"><a href="#__codelineno-0-1667">1667</a></span>
<span class="normal"><a href="#__codelineno-0-1668">1668</a></span>
<span class="normal"><a href="#__codelineno-0-1669">1669</a></span>
<span class="normal"><a href="#__codelineno-0-1670">1670</a></span>
<span class="normal"><a href="#__codelineno-0-1671">1671</a></span>
<span class="normal"><a href="#__codelineno-0-1672">1672</a></span>
<span class="normal"><a href="#__codelineno-0-1673">1673</a></span>
<span class="normal"><a href="#__codelineno-0-1674">1674</a></span>
<span class="normal"><a href="#__codelineno-0-1675">1675</a></span>
<span class="normal"><a href="#__codelineno-0-1676">1676</a></span>
<span class="normal"><a href="#__codelineno-0-1677">1677</a></span>
<span class="normal"><a href="#__codelineno-0-1678">1678</a></span>
<span class="normal"><a href="#__codelineno-0-1679">1679</a></span>
<span class="normal"><a href="#__codelineno-0-1680">1680</a></span>
<span class="normal"><a href="#__codelineno-0-1681">1681</a></span>
<span class="normal"><a href="#__codelineno-0-1682">1682</a></span>
<span class="normal"><a href="#__codelineno-0-1683">1683</a></span>
<span class="normal"><a href="#__codelineno-0-1684">1684</a></span>
<span class="normal"><a href="#__codelineno-0-1685">1685</a></span>
<span class="normal"><a href="#__codelineno-0-1686">1686</a></span>
<span class="normal"><a href="#__codelineno-0-1687">1687</a></span>
<span class="normal"><a href="#__codelineno-0-1688">1688</a></span>
<span class="normal"><a href="#__codelineno-0-1689">1689</a></span>
<span class="normal"><a href="#__codelineno-0-1690">1690</a></span>
<span class="normal"><a href="#__codelineno-0-1691">1691</a></span>
<span class="normal"><a href="#__codelineno-0-1692">1692</a></span>
<span class="normal"><a href="#__codelineno-0-1693">1693</a></span>
<span class="normal"><a href="#__codelineno-0-1694">1694</a></span>
<span class="normal"><a href="#__codelineno-0-1695">1695</a></span>
<span class="normal"><a href="#__codelineno-0-1696">1696</a></span>
<span class="normal"><a href="#__codelineno-0-1697">1697</a></span>
<span class="normal"><a href="#__codelineno-0-1698">1698</a></span>
<span class="normal"><a href="#__codelineno-0-1699">1699</a></span>
<span class="normal"><a href="#__codelineno-0-1700">1700</a></span>
<span class="normal"><a href="#__codelineno-0-1701">1701</a></span>
<span class="normal"><a href="#__codelineno-0-1702">1702</a></span>
<span class="normal"><a href="#__codelineno-0-1703">1703</a></span>
<span class="normal"><a href="#__codelineno-0-1704">1704</a></span>
<span class="normal"><a href="#__codelineno-0-1705">1705</a></span>
<span class="normal"><a href="#__codelineno-0-1706">1706</a></span>
<span class="normal"><a href="#__codelineno-0-1707">1707</a></span>
<span class="normal"><a href="#__codelineno-0-1708">1708</a></span>
<span class="normal"><a href="#__codelineno-0-1709">1709</a></span>
<span class="normal"><a href="#__codelineno-0-1710">1710</a></span>
<span class="normal"><a href="#__codelineno-0-1711">1711</a></span>
<span class="normal"><a href="#__codelineno-0-1712">1712</a></span>
<span class="normal"><a href="#__codelineno-0-1713">1713</a></span>
<span class="normal"><a href="#__codelineno-0-1714">1714</a></span>
<span class="normal"><a href="#__codelineno-0-1715">1715</a></span>
<span class="normal"><a href="#__codelineno-0-1716">1716</a></span>
<span class="normal"><a href="#__codelineno-0-1717">1717</a></span>
<span class="normal"><a href="#__codelineno-0-1718">1718</a></span>
<span class="normal"><a href="#__codelineno-0-1719">1719</a></span>
<span class="normal"><a href="#__codelineno-0-1720">1720</a></span>
<span class="normal"><a href="#__codelineno-0-1721">1721</a></span>
<span class="normal"><a href="#__codelineno-0-1722">1722</a></span>
<span class="normal"><a href="#__codelineno-0-1723">1723</a></span>
<span class="normal"><a href="#__codelineno-0-1724">1724</a></span>
<span class="normal"><a href="#__codelineno-0-1725">1725</a></span>
<span class="normal"><a href="#__codelineno-0-1726">1726</a></span>
<span class="normal"><a href="#__codelineno-0-1727">1727</a></span>
<span class="normal"><a href="#__codelineno-0-1728">1728</a></span>
<span class="normal"><a href="#__codelineno-0-1729">1729</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1639" name="__codelineno-0-1639"></a><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
<a id="__codelineno-0-1640" name="__codelineno-0-1640"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1641" name="__codelineno-0-1641"></a>    <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-1642" name="__codelineno-0-1642"></a>    <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1643" name="__codelineno-0-1643"></a>    <span class="n">return_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1644" name="__codelineno-0-1644"></a>    <span class="n">cls_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-0-1645" name="__codelineno-0-1645"></a>    <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1646" name="__codelineno-0-1646"></a>    <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1647" name="__codelineno-0-1647"></a>    <span class="n">return_by_separate_ensembles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1648" name="__codelineno-0-1648"></a>    <span class="n">logit_agg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1649" name="__codelineno-0-1649"></a>    <span class="n">base_model_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1650" name="__codelineno-0-1650"></a>    <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1651" name="__codelineno-0-1651"></a>    <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1652" name="__codelineno-0-1652"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-1653" name="__codelineno-0-1653"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A rewrite of predict_proba adapted for Classifier</span>
<a id="__codelineno-0-1654" name="__codelineno-0-1654"></a>
<a id="__codelineno-0-1655" name="__codelineno-0-1655"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1656" name="__codelineno-0-1656"></a><span class="sd">        X_test (pd.DataFrame):</span>
<a id="__codelineno-0-1657" name="__codelineno-0-1657"></a><span class="sd">            Testing variables.</span>
<a id="__codelineno-0-1658" name="__codelineno-0-1658"></a><span class="sd">        verbosity (int, optional):</span>
<a id="__codelineno-0-1659" name="__codelineno-0-1659"></a><span class="sd">            0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</span>
<a id="__codelineno-0-1660" name="__codelineno-0-1660"></a><span class="sd">        return_std (bool, optional):</span>
<a id="__codelineno-0-1661" name="__codelineno-0-1661"></a><span class="sd">            Whether return the standard deviation among ensembles. Defaults to False.</span>
<a id="__codelineno-0-1662" name="__codelineno-0-1662"></a><span class="sd">        cls_threshold (float, optional):</span>
<a id="__codelineno-0-1663" name="__codelineno-0-1663"></a><span class="sd">            Cutting threshold for the classification.</span>
<a id="__codelineno-0-1664" name="__codelineno-0-1664"></a><span class="sd">            Values above cls_threshold will be labeled as 1 and 0 otherwise.</span>
<a id="__codelineno-0-1665" name="__codelineno-0-1665"></a><span class="sd">            Defaults to 0.5.</span>
<a id="__codelineno-0-1666" name="__codelineno-0-1666"></a><span class="sd">        n_jobs (Union[int, None], optional):</span>
<a id="__codelineno-0-1667" name="__codelineno-0-1667"></a><span class="sd">            Number of processes used in this task. If None, use the self.n_jobs. Default to None.</span>
<a id="__codelineno-0-1668" name="__codelineno-0-1668"></a><span class="sd">            In practice, multi-processing might to slow down the process instead of speeding up. Suggest some adapted experiments.</span>
<a id="__codelineno-0-1669" name="__codelineno-0-1669"></a><span class="sd">            Could be more practical with large amount of data.</span>
<a id="__codelineno-0-1670" name="__codelineno-0-1670"></a><span class="sd">        aggregation (str, optional):</span>
<a id="__codelineno-0-1671" name="__codelineno-0-1671"></a><span class="sd">            &#39;mean&#39; or &#39;median&#39; for aggregation method across ensembles.</span>
<a id="__codelineno-0-1672" name="__codelineno-0-1672"></a><span class="sd">        return_by_separate_ensembles (bool, optional):</span>
<a id="__codelineno-0-1673" name="__codelineno-0-1673"></a><span class="sd">            Experimental function. return not by aggregation, but by separate ensembles.</span>
<a id="__codelineno-0-1674" name="__codelineno-0-1674"></a><span class="sd">        logit_agg:</span>
<a id="__codelineno-0-1675" name="__codelineno-0-1675"></a><span class="sd">            Whether to use logit aggregation for the classification task. If True, the model is averaging the probability prediction estimated by all ensembles in logit scale, and then back-tranform it to probability scale. It&#39;s recommened to be combinedly used with the CalibratedClassifierCV class in sklearn as a wrapper of the classifier to estimate the calibrated probability.</span>
<a id="__codelineno-0-1676" name="__codelineno-0-1676"></a><span class="sd">        base_model_method:</span>
<a id="__codelineno-0-1677" name="__codelineno-0-1677"></a><span class="sd">            The name of the prediction method for base models. If None, `predict` or `predict_proba` will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Defaults to None.</span>
<a id="__codelineno-0-1678" name="__codelineno-0-1678"></a><span class="sd">        temporal_window_prequery: </span>
<a id="__codelineno-0-1679" name="__codelineno-0-1679"></a><span class="sd">            Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-1680" name="__codelineno-0-1680"></a><span class="sd">        base_model_prediction_param:</span>
<a id="__codelineno-0-1681" name="__codelineno-0-1681"></a><span class="sd">            Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={&#39;n_jobs&#39;:1}.</span>
<a id="__codelineno-0-1682" name="__codelineno-0-1682"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-1683" name="__codelineno-0-1683"></a><span class="sd">        TypeError:</span>
<a id="__codelineno-0-1684" name="__codelineno-0-1684"></a><span class="sd">            X_test is not of type pd.DataFrame.</span>
<a id="__codelineno-0-1685" name="__codelineno-0-1685"></a><span class="sd">        ValueError:</span>
<a id="__codelineno-0-1686" name="__codelineno-0-1686"></a><span class="sd">            aggregation is not in [&#39;mean&#39;,&#39;median&#39;].</span>
<a id="__codelineno-0-1687" name="__codelineno-0-1687"></a>
<a id="__codelineno-0-1688" name="__codelineno-0-1688"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1689" name="__codelineno-0-1689"></a><span class="sd">        predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</span>
<a id="__codelineno-0-1690" name="__codelineno-0-1690"></a>
<a id="__codelineno-0-1691" name="__codelineno-0-1691"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1692" name="__codelineno-0-1692"></a>    <span class="k">if</span> <span class="n">return_by_separate_ensembles</span><span class="o">!=</span><span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-1693" name="__codelineno-0-1693"></a>        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;If you want to return by separate ensembles in this classifier, use it in .predict_proba, instead of .predict.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1694" name="__codelineno-0-1694"></a>
<a id="__codelineno-0-1695" name="__codelineno-0-1695"></a>    <span class="k">if</span> <span class="n">return_std</span><span class="p">:</span>
<a id="__codelineno-0-1696" name="__codelineno-0-1696"></a>        <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
<a id="__codelineno-0-1697" name="__codelineno-0-1697"></a>            <span class="n">X_test</span><span class="p">,</span>
<a id="__codelineno-0-1698" name="__codelineno-0-1698"></a>            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
<a id="__codelineno-0-1699" name="__codelineno-0-1699"></a>            <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1700" name="__codelineno-0-1700"></a>            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<a id="__codelineno-0-1701" name="__codelineno-0-1701"></a>            <span class="n">aggregation</span><span class="o">=</span><span class="n">aggregation</span><span class="p">,</span>
<a id="__codelineno-0-1702" name="__codelineno-0-1702"></a>            <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="n">return_by_separate_ensembles</span><span class="p">,</span>
<a id="__codelineno-0-1703" name="__codelineno-0-1703"></a>            <span class="n">logit_agg</span><span class="o">=</span><span class="n">logit_agg</span><span class="p">,</span>
<a id="__codelineno-0-1704" name="__codelineno-0-1704"></a>            <span class="n">base_model_method</span><span class="o">=</span><span class="n">base_model_method</span><span class="p">,</span>
<a id="__codelineno-0-1705" name="__codelineno-0-1705"></a>            <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">,</span>
<a id="__codelineno-0-1706" name="__codelineno-0-1706"></a>            <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1707" name="__codelineno-0-1707"></a>        <span class="p">)</span>
<a id="__codelineno-0-1708" name="__codelineno-0-1708"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1709" name="__codelineno-0-1709"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean</span> <span class="o">&lt;</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<a id="__codelineno-0-1710" name="__codelineno-0-1710"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean</span> <span class="o">&gt;=</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<a id="__codelineno-0-1711" name="__codelineno-0-1711"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;This is a classification task. The standard deviation of the prediction is output at logit scale! The mean prediction is output at probability scale.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1712" name="__codelineno-0-1712"></a>        <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="c1"># notice! the std</span>
<a id="__codelineno-0-1713" name="__codelineno-0-1713"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1714" name="__codelineno-0-1714"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
<a id="__codelineno-0-1715" name="__codelineno-0-1715"></a>            <span class="n">X_test</span><span class="p">,</span>
<a id="__codelineno-0-1716" name="__codelineno-0-1716"></a>            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
<a id="__codelineno-0-1717" name="__codelineno-0-1717"></a>            <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1718" name="__codelineno-0-1718"></a>            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<a id="__codelineno-0-1719" name="__codelineno-0-1719"></a>            <span class="n">aggregation</span><span class="o">=</span><span class="n">aggregation</span><span class="p">,</span>
<a id="__codelineno-0-1720" name="__codelineno-0-1720"></a>            <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="n">return_by_separate_ensembles</span><span class="p">,</span>
<a id="__codelineno-0-1721" name="__codelineno-0-1721"></a>            <span class="n">logit_agg</span><span class="o">=</span><span class="n">logit_agg</span><span class="p">,</span>
<a id="__codelineno-0-1722" name="__codelineno-0-1722"></a>            <span class="n">base_model_method</span><span class="o">=</span><span class="n">base_model_method</span><span class="p">,</span>
<a id="__codelineno-0-1723" name="__codelineno-0-1723"></a>            <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">,</span>
<a id="__codelineno-0-1724" name="__codelineno-0-1724"></a>            <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1725" name="__codelineno-0-1725"></a>        <span class="p">)</span>
<a id="__codelineno-0-1726" name="__codelineno-0-1726"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-1727" name="__codelineno-0-1727"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean</span> <span class="o">&lt;</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<a id="__codelineno-0-1728" name="__codelineno-0-1728"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean</span> <span class="o">&gt;=</span> <span class="n">cls_threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<a id="__codelineno-0-1729" name="__codelineno-0-1729"></a>        <span class="k">return</span> <span class="n">mean</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="stemflow.model.AdaSTEM.AdaSTEMRegressor" class="doc doc-heading">
            <code>AdaSTEMRegressor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AdaSTEM (stemflow.model.AdaSTEM.AdaSTEM)" href="#stemflow.model.AdaSTEM.AdaSTEM">AdaSTEM</a></code></p>


        <p>AdaSTEM model Regressor interface</p>
<p>Example:
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>&gt;&gt;&gt; from stemflow.model.AdaSTEM import AdaSTEMRegressor
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>&gt;&gt;&gt; from xgboost import XGBRegressor
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>&gt;&gt;&gt; model = AdaSTEMRegressor(base_model=XGBRegressor(tree_method=&#39;hist&#39;,random_state=42, verbosity = 0, n_jobs=1),
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                        save_gridding_plot = True,
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                        ensemble_fold=10,
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                        min_ensemble_required=7,
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                        grid_len_upper_threshold=25,
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                        grid_len_lower_threshold=5,
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                        points_lower_threshold=50,
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                        Spatio1=&#39;longitude&#39;,
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                        Spatio2 = &#39;latitude&#39;,
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                        Temporal1 = &#39;DOY&#39;,
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                        use_temporal_to_train=True)
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>&gt;&gt;&gt; model.fit(X_train, y_train)
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>&gt;&gt;&gt; pred = model.predict(X_test)
</code></pre></div></p>








              <details class="quote">
                <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1732">1732</a></span>
<span class="normal"><a href="#__codelineno-0-1733">1733</a></span>
<span class="normal"><a href="#__codelineno-0-1734">1734</a></span>
<span class="normal"><a href="#__codelineno-0-1735">1735</a></span>
<span class="normal"><a href="#__codelineno-0-1736">1736</a></span>
<span class="normal"><a href="#__codelineno-0-1737">1737</a></span>
<span class="normal"><a href="#__codelineno-0-1738">1738</a></span>
<span class="normal"><a href="#__codelineno-0-1739">1739</a></span>
<span class="normal"><a href="#__codelineno-0-1740">1740</a></span>
<span class="normal"><a href="#__codelineno-0-1741">1741</a></span>
<span class="normal"><a href="#__codelineno-0-1742">1742</a></span>
<span class="normal"><a href="#__codelineno-0-1743">1743</a></span>
<span class="normal"><a href="#__codelineno-0-1744">1744</a></span>
<span class="normal"><a href="#__codelineno-0-1745">1745</a></span>
<span class="normal"><a href="#__codelineno-0-1746">1746</a></span>
<span class="normal"><a href="#__codelineno-0-1747">1747</a></span>
<span class="normal"><a href="#__codelineno-0-1748">1748</a></span>
<span class="normal"><a href="#__codelineno-0-1749">1749</a></span>
<span class="normal"><a href="#__codelineno-0-1750">1750</a></span>
<span class="normal"><a href="#__codelineno-0-1751">1751</a></span>
<span class="normal"><a href="#__codelineno-0-1752">1752</a></span>
<span class="normal"><a href="#__codelineno-0-1753">1753</a></span>
<span class="normal"><a href="#__codelineno-0-1754">1754</a></span>
<span class="normal"><a href="#__codelineno-0-1755">1755</a></span>
<span class="normal"><a href="#__codelineno-0-1756">1756</a></span>
<span class="normal"><a href="#__codelineno-0-1757">1757</a></span>
<span class="normal"><a href="#__codelineno-0-1758">1758</a></span>
<span class="normal"><a href="#__codelineno-0-1759">1759</a></span>
<span class="normal"><a href="#__codelineno-0-1760">1760</a></span>
<span class="normal"><a href="#__codelineno-0-1761">1761</a></span>
<span class="normal"><a href="#__codelineno-0-1762">1762</a></span>
<span class="normal"><a href="#__codelineno-0-1763">1763</a></span>
<span class="normal"><a href="#__codelineno-0-1764">1764</a></span>
<span class="normal"><a href="#__codelineno-0-1765">1765</a></span>
<span class="normal"><a href="#__codelineno-0-1766">1766</a></span>
<span class="normal"><a href="#__codelineno-0-1767">1767</a></span>
<span class="normal"><a href="#__codelineno-0-1768">1768</a></span>
<span class="normal"><a href="#__codelineno-0-1769">1769</a></span>
<span class="normal"><a href="#__codelineno-0-1770">1770</a></span>
<span class="normal"><a href="#__codelineno-0-1771">1771</a></span>
<span class="normal"><a href="#__codelineno-0-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-0-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-0-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-0-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-0-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-0-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-0-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-0-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-0-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-0-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-0-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-0-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-0-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-0-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-0-1786">1786</a></span>
<span class="normal"><a href="#__codelineno-0-1787">1787</a></span>
<span class="normal"><a href="#__codelineno-0-1788">1788</a></span>
<span class="normal"><a href="#__codelineno-0-1789">1789</a></span>
<span class="normal"><a href="#__codelineno-0-1790">1790</a></span>
<span class="normal"><a href="#__codelineno-0-1791">1791</a></span>
<span class="normal"><a href="#__codelineno-0-1792">1792</a></span>
<span class="normal"><a href="#__codelineno-0-1793">1793</a></span>
<span class="normal"><a href="#__codelineno-0-1794">1794</a></span>
<span class="normal"><a href="#__codelineno-0-1795">1795</a></span>
<span class="normal"><a href="#__codelineno-0-1796">1796</a></span>
<span class="normal"><a href="#__codelineno-0-1797">1797</a></span>
<span class="normal"><a href="#__codelineno-0-1798">1798</a></span>
<span class="normal"><a href="#__codelineno-0-1799">1799</a></span>
<span class="normal"><a href="#__codelineno-0-1800">1800</a></span>
<span class="normal"><a href="#__codelineno-0-1801">1801</a></span>
<span class="normal"><a href="#__codelineno-0-1802">1802</a></span>
<span class="normal"><a href="#__codelineno-0-1803">1803</a></span>
<span class="normal"><a href="#__codelineno-0-1804">1804</a></span>
<span class="normal"><a href="#__codelineno-0-1805">1805</a></span>
<span class="normal"><a href="#__codelineno-0-1806">1806</a></span>
<span class="normal"><a href="#__codelineno-0-1807">1807</a></span>
<span class="normal"><a href="#__codelineno-0-1808">1808</a></span>
<span class="normal"><a href="#__codelineno-0-1809">1809</a></span>
<span class="normal"><a href="#__codelineno-0-1810">1810</a></span>
<span class="normal"><a href="#__codelineno-0-1811">1811</a></span>
<span class="normal"><a href="#__codelineno-0-1812">1812</a></span>
<span class="normal"><a href="#__codelineno-0-1813">1813</a></span>
<span class="normal"><a href="#__codelineno-0-1814">1814</a></span>
<span class="normal"><a href="#__codelineno-0-1815">1815</a></span>
<span class="normal"><a href="#__codelineno-0-1816">1816</a></span>
<span class="normal"><a href="#__codelineno-0-1817">1817</a></span>
<span class="normal"><a href="#__codelineno-0-1818">1818</a></span>
<span class="normal"><a href="#__codelineno-0-1819">1819</a></span>
<span class="normal"><a href="#__codelineno-0-1820">1820</a></span>
<span class="normal"><a href="#__codelineno-0-1821">1821</a></span>
<span class="normal"><a href="#__codelineno-0-1822">1822</a></span>
<span class="normal"><a href="#__codelineno-0-1823">1823</a></span>
<span class="normal"><a href="#__codelineno-0-1824">1824</a></span>
<span class="normal"><a href="#__codelineno-0-1825">1825</a></span>
<span class="normal"><a href="#__codelineno-0-1826">1826</a></span>
<span class="normal"><a href="#__codelineno-0-1827">1827</a></span>
<span class="normal"><a href="#__codelineno-0-1828">1828</a></span>
<span class="normal"><a href="#__codelineno-0-1829">1829</a></span>
<span class="normal"><a href="#__codelineno-0-1830">1830</a></span>
<span class="normal"><a href="#__codelineno-0-1831">1831</a></span>
<span class="normal"><a href="#__codelineno-0-1832">1832</a></span>
<span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span>
<span class="normal"><a href="#__codelineno-0-1843">1843</a></span>
<span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1732" name="__codelineno-0-1732"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdaSTEMRegressor</span><span class="p">(</span><span class="n">AdaSTEM</span><span class="p">):</span>
<a id="__codelineno-0-1733" name="__codelineno-0-1733"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;AdaSTEM model Regressor interface</span>
<a id="__codelineno-0-1734" name="__codelineno-0-1734"></a>
<a id="__codelineno-0-1735" name="__codelineno-0-1735"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-1736" name="__codelineno-0-1736"></a><span class="sd">    ```</span>
<a id="__codelineno-0-1737" name="__codelineno-0-1737"></a><span class="sd">    &gt;&gt;&gt; from stemflow.model.AdaSTEM import AdaSTEMRegressor</span>
<a id="__codelineno-0-1738" name="__codelineno-0-1738"></a><span class="sd">    &gt;&gt;&gt; from xgboost import XGBRegressor</span>
<a id="__codelineno-0-1739" name="__codelineno-0-1739"></a><span class="sd">    &gt;&gt;&gt; model = AdaSTEMRegressor(base_model=XGBRegressor(tree_method=&#39;hist&#39;,random_state=42, verbosity = 0, n_jobs=1),</span>
<a id="__codelineno-0-1740" name="__codelineno-0-1740"></a><span class="sd">                            save_gridding_plot = True,</span>
<a id="__codelineno-0-1741" name="__codelineno-0-1741"></a><span class="sd">                            ensemble_fold=10,</span>
<a id="__codelineno-0-1742" name="__codelineno-0-1742"></a><span class="sd">                            min_ensemble_required=7,</span>
<a id="__codelineno-0-1743" name="__codelineno-0-1743"></a><span class="sd">                            grid_len_upper_threshold=25,</span>
<a id="__codelineno-0-1744" name="__codelineno-0-1744"></a><span class="sd">                            grid_len_lower_threshold=5,</span>
<a id="__codelineno-0-1745" name="__codelineno-0-1745"></a><span class="sd">                            points_lower_threshold=50,</span>
<a id="__codelineno-0-1746" name="__codelineno-0-1746"></a><span class="sd">                            Spatio1=&#39;longitude&#39;,</span>
<a id="__codelineno-0-1747" name="__codelineno-0-1747"></a><span class="sd">                            Spatio2 = &#39;latitude&#39;,</span>
<a id="__codelineno-0-1748" name="__codelineno-0-1748"></a><span class="sd">                            Temporal1 = &#39;DOY&#39;,</span>
<a id="__codelineno-0-1749" name="__codelineno-0-1749"></a><span class="sd">                            use_temporal_to_train=True)</span>
<a id="__codelineno-0-1750" name="__codelineno-0-1750"></a><span class="sd">    &gt;&gt;&gt; model.fit(X_train, y_train)</span>
<a id="__codelineno-0-1751" name="__codelineno-0-1751"></a><span class="sd">    &gt;&gt;&gt; pred = model.predict(X_test)</span>
<a id="__codelineno-0-1752" name="__codelineno-0-1752"></a><span class="sd">    ```</span>
<a id="__codelineno-0-1753" name="__codelineno-0-1753"></a>
<a id="__codelineno-0-1754" name="__codelineno-0-1754"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1755" name="__codelineno-0-1755"></a>
<a id="__codelineno-0-1756" name="__codelineno-0-1756"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-1757" name="__codelineno-0-1757"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1758" name="__codelineno-0-1758"></a>        <span class="n">base_model</span><span class="p">,</span>
<a id="__codelineno-0-1759" name="__codelineno-0-1759"></a>        <span class="n">task</span><span class="o">=</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1760" name="__codelineno-0-1760"></a>        <span class="n">ensemble_fold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-1761" name="__codelineno-0-1761"></a>        <span class="n">min_ensemble_required</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
<a id="__codelineno-0-1762" name="__codelineno-0-1762"></a>        <span class="n">grid_len_upper_threshold</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-0-1763" name="__codelineno-0-1763"></a>        <span class="n">grid_len_lower_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-1764" name="__codelineno-0-1764"></a>        <span class="n">points_lower_threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-1765" name="__codelineno-0-1765"></a>        <span class="n">stixel_training_size_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1766" name="__codelineno-0-1766"></a>        <span class="n">temporal_start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1767" name="__codelineno-0-1767"></a>        <span class="n">temporal_end</span><span class="o">=</span><span class="mi">366</span><span class="p">,</span>
<a id="__codelineno-0-1768" name="__codelineno-0-1768"></a>        <span class="n">temporal_step</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-1769" name="__codelineno-0-1769"></a>        <span class="n">temporal_bin_interval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-1770" name="__codelineno-0-1770"></a>        <span class="n">temporal_bin_start_jitter</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1771" name="__codelineno-0-1771"></a>        <span class="n">spatio_bin_jitter_magnitude</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1772" name="__codelineno-0-1772"></a>        <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1773" name="__codelineno-0-1773"></a>        <span class="n">save_gridding_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1774" name="__codelineno-0-1774"></a>        <span class="n">sample_weights_for_classifier</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1775" name="__codelineno-0-1775"></a>        <span class="n">Spatio1</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1776" name="__codelineno-0-1776"></a>        <span class="n">Spatio2</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1777" name="__codelineno-0-1777"></a>        <span class="n">Temporal1</span><span class="o">=</span><span class="s2">&quot;DOY&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1778" name="__codelineno-0-1778"></a>        <span class="n">use_temporal_to_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1779" name="__codelineno-0-1779"></a>        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1780" name="__codelineno-0-1780"></a>        <span class="n">subset_x_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1781" name="__codelineno-0-1781"></a>        <span class="n">plot_xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1782" name="__codelineno-0-1782"></a>        <span class="n">plot_ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1783" name="__codelineno-0-1783"></a>        <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-1784" name="__codelineno-0-1784"></a>        <span class="n">plot_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1785" name="__codelineno-0-1785"></a>        <span class="n">completely_random_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1786" name="__codelineno-0-1786"></a>        <span class="n">lazy_loading</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1787" name="__codelineno-0-1787"></a>        <span class="n">lazy_loading_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1788" name="__codelineno-0-1788"></a>        <span class="n">min_class_sample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1789" name="__codelineno-0-1789"></a>        <span class="n">ensemble_bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1790" name="__codelineno-0-1790"></a>        <span class="n">joblib_backend</span><span class="o">=</span><span class="s1">&#39;loky&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1791" name="__codelineno-0-1791"></a>        <span class="n">max_mem</span><span class="o">=</span><span class="s1">&#39;2GB&#39;</span>
<a id="__codelineno-0-1792" name="__codelineno-0-1792"></a>    <span class="p">):</span>
<a id="__codelineno-0-1793" name="__codelineno-0-1793"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-1794" name="__codelineno-0-1794"></a>            <span class="n">base_model</span><span class="o">=</span><span class="n">base_model</span><span class="p">,</span>
<a id="__codelineno-0-1795" name="__codelineno-0-1795"></a>            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
<a id="__codelineno-0-1796" name="__codelineno-0-1796"></a>            <span class="n">ensemble_fold</span><span class="o">=</span><span class="n">ensemble_fold</span><span class="p">,</span>
<a id="__codelineno-0-1797" name="__codelineno-0-1797"></a>            <span class="n">min_ensemble_required</span><span class="o">=</span><span class="n">min_ensemble_required</span><span class="p">,</span>
<a id="__codelineno-0-1798" name="__codelineno-0-1798"></a>            <span class="n">grid_len_upper_threshold</span><span class="o">=</span><span class="n">grid_len_upper_threshold</span><span class="p">,</span>
<a id="__codelineno-0-1799" name="__codelineno-0-1799"></a>            <span class="n">grid_len_lower_threshold</span><span class="o">=</span><span class="n">grid_len_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-1800" name="__codelineno-0-1800"></a>            <span class="n">points_lower_threshold</span><span class="o">=</span><span class="n">points_lower_threshold</span><span class="p">,</span>
<a id="__codelineno-0-1801" name="__codelineno-0-1801"></a>            <span class="n">stixel_training_size_threshold</span><span class="o">=</span><span class="n">stixel_training_size_threshold</span><span class="p">,</span>
<a id="__codelineno-0-1802" name="__codelineno-0-1802"></a>            <span class="n">temporal_start</span><span class="o">=</span><span class="n">temporal_start</span><span class="p">,</span>
<a id="__codelineno-0-1803" name="__codelineno-0-1803"></a>            <span class="n">temporal_end</span><span class="o">=</span><span class="n">temporal_end</span><span class="p">,</span>
<a id="__codelineno-0-1804" name="__codelineno-0-1804"></a>            <span class="n">temporal_step</span><span class="o">=</span><span class="n">temporal_step</span><span class="p">,</span>
<a id="__codelineno-0-1805" name="__codelineno-0-1805"></a>            <span class="n">temporal_bin_interval</span><span class="o">=</span><span class="n">temporal_bin_interval</span><span class="p">,</span>
<a id="__codelineno-0-1806" name="__codelineno-0-1806"></a>            <span class="n">temporal_bin_start_jitter</span><span class="o">=</span><span class="n">temporal_bin_start_jitter</span><span class="p">,</span>
<a id="__codelineno-0-1807" name="__codelineno-0-1807"></a>            <span class="n">spatio_bin_jitter_magnitude</span><span class="o">=</span><span class="n">spatio_bin_jitter_magnitude</span><span class="p">,</span>
<a id="__codelineno-0-1808" name="__codelineno-0-1808"></a>            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
<a id="__codelineno-0-1809" name="__codelineno-0-1809"></a>            <span class="n">save_gridding_plot</span><span class="o">=</span><span class="n">save_gridding_plot</span><span class="p">,</span>
<a id="__codelineno-0-1810" name="__codelineno-0-1810"></a>            <span class="n">sample_weights_for_classifier</span><span class="o">=</span><span class="n">sample_weights_for_classifier</span><span class="p">,</span>
<a id="__codelineno-0-1811" name="__codelineno-0-1811"></a>            <span class="n">Spatio1</span><span class="o">=</span><span class="n">Spatio1</span><span class="p">,</span>
<a id="__codelineno-0-1812" name="__codelineno-0-1812"></a>            <span class="n">Spatio2</span><span class="o">=</span><span class="n">Spatio2</span><span class="p">,</span>
<a id="__codelineno-0-1813" name="__codelineno-0-1813"></a>            <span class="n">Temporal1</span><span class="o">=</span><span class="n">Temporal1</span><span class="p">,</span>
<a id="__codelineno-0-1814" name="__codelineno-0-1814"></a>            <span class="n">use_temporal_to_train</span><span class="o">=</span><span class="n">use_temporal_to_train</span><span class="p">,</span>
<a id="__codelineno-0-1815" name="__codelineno-0-1815"></a>            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<a id="__codelineno-0-1816" name="__codelineno-0-1816"></a>            <span class="n">subset_x_names</span><span class="o">=</span><span class="n">subset_x_names</span><span class="p">,</span>
<a id="__codelineno-0-1817" name="__codelineno-0-1817"></a>            <span class="n">plot_xlims</span><span class="o">=</span><span class="n">plot_xlims</span><span class="p">,</span>
<a id="__codelineno-0-1818" name="__codelineno-0-1818"></a>            <span class="n">plot_ylims</span><span class="o">=</span><span class="n">plot_ylims</span><span class="p">,</span>
<a id="__codelineno-0-1819" name="__codelineno-0-1819"></a>            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
<a id="__codelineno-0-1820" name="__codelineno-0-1820"></a>            <span class="n">plot_empty</span><span class="o">=</span><span class="n">plot_empty</span><span class="p">,</span>
<a id="__codelineno-0-1821" name="__codelineno-0-1821"></a>            <span class="n">completely_random_rotation</span><span class="o">=</span><span class="n">completely_random_rotation</span><span class="p">,</span>
<a id="__codelineno-0-1822" name="__codelineno-0-1822"></a>            <span class="n">lazy_loading</span><span class="o">=</span><span class="n">lazy_loading</span><span class="p">,</span>
<a id="__codelineno-0-1823" name="__codelineno-0-1823"></a>            <span class="n">lazy_loading_dir</span><span class="o">=</span><span class="n">lazy_loading_dir</span><span class="p">,</span>
<a id="__codelineno-0-1824" name="__codelineno-0-1824"></a>            <span class="n">min_class_sample</span><span class="o">=</span><span class="n">min_class_sample</span><span class="p">,</span>
<a id="__codelineno-0-1825" name="__codelineno-0-1825"></a>            <span class="n">ensemble_bootstrap</span><span class="o">=</span><span class="n">ensemble_bootstrap</span><span class="p">,</span>
<a id="__codelineno-0-1826" name="__codelineno-0-1826"></a>            <span class="n">joblib_backend</span><span class="o">=</span><span class="n">joblib_backend</span><span class="p">,</span>
<a id="__codelineno-0-1827" name="__codelineno-0-1827"></a>            <span class="n">max_mem</span><span class="o">=</span><span class="n">max_mem</span>
<a id="__codelineno-0-1828" name="__codelineno-0-1828"></a>        <span class="p">)</span>
<a id="__codelineno-0-1829" name="__codelineno-0-1829"></a>
<a id="__codelineno-0-1830" name="__codelineno-0-1830"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_estimator_type</span> <span class="o">=</span> <span class="s1">&#39;regressor&#39;</span>
<a id="__codelineno-0-1831" name="__codelineno-0-1831"></a>
<a id="__codelineno-0-1832" name="__codelineno-0-1832"></a>
<a id="__codelineno-0-1833" name="__codelineno-0-1833"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a>        <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a>        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a>        <span class="n">return_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a>        <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a>        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a>        <span class="n">return_by_separate_ensembles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a>        <span class="n">base_model_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a>        <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1843" name="__codelineno-0-1843"></a>        <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1844" name="__codelineno-0-1844"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A rewrite of predict_proba</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a><span class="sd">            X_test (pd.DataFrame):</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a><span class="sd">                Testing variables.</span>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a><span class="sd">            verbosity (Union[None, int], optional):</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a><span class="sd">                0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a><span class="sd">            return_std (bool, optional):</span>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a><span class="sd">                Whether return the standard deviation among ensembles. Defaults to False.</span>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a><span class="sd">            n_jobs (Union[int, None], optional):</span>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a><span class="sd">                Number of processes used in this task. If None, use the self.n_jobs. Default to None.</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a><span class="sd">                In practice, multi-processing might to slow down the process instead of speeding up. Suggest some adapted experiments.</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a><span class="sd">                Could be more practical with large amount of data.</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a><span class="sd">            aggregation (str, optional):</span>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a><span class="sd">                &#39;mean&#39; or &#39;median&#39; for aggregation method across ensembles.</span>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a><span class="sd">            return_by_separate_ensembles (bool, optional):</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a><span class="sd">                Experimental function. return not by aggregation, but by separate ensembles.</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a><span class="sd">            base_model_method:</span>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a><span class="sd">                The name of the prediction method for base models. If None, `predict` or `predict_proba` will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Defaults to None.</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a><span class="sd">            temporal_window_prequery: </span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a><span class="sd">                Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a><span class="sd">            base_model_prediction_param:</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a><span class="sd">                Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={&#39;n_jobs&#39;:1}.</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a><span class="sd">            TypeError:</span>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a><span class="sd">                X_test is not of type pd.DataFrame.</span>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a><span class="sd">            ValueError:</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a><span class="sd">                aggregation is not in [&#39;mean&#39;,&#39;median&#39;].</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a><span class="sd">            predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a><span class="sd">            If return_by_separate_ensembles == True:</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a><span class="sd">                Return numpy.ndarray of shape (n_samples, n_ensembles)</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a>        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a>            <span class="n">X_test</span><span class="p">,</span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a>            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a>            <span class="n">return_std</span><span class="o">=</span><span class="n">return_std</span><span class="p">,</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a>            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>            <span class="n">aggregation</span><span class="o">=</span><span class="n">aggregation</span><span class="p">,</span>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a>            <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="n">return_by_separate_ensembles</span><span class="p">,</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>            <span class="n">base_model_method</span> <span class="o">=</span> <span class="n">base_model_method</span><span class="p">,</span>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>            <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">,</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>            <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a>        <span class="p">)</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a>        <span class="c1"># if return_by_separate_ensembles, this will be the dataframe for ensemble</span>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a>        <span class="c1"># if return_std, this wil be a tuple of mean and std of prediction</span>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a>        <span class="c1"># if none of these, then it ill output the mean prediction</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a>        <span class="k">return</span> <span class="n">prediction</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="stemflow.model.AdaSTEM.AdaSTEMRegressor.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_model_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">base_model_prediction_param</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>A rewrite of predict_proba</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>X_test</code></b>
              (<code><span title="pandas.DataFrame">DataFrame</span></code>)
          –
          <div class="doc-md-description">
            <p>Testing variables.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>verbosity</code></b>
              (<code><span title="typing.Union">Union</span>[None, <span title="int">int</span>]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>return_std</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether return the standard deviation among ensembles. Defaults to False.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>n_jobs</code></b>
              (<code><span title="typing.Union">Union</span>[<span title="int">int</span>, None]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>Number of processes used in this task. If None, use the self.n_jobs. Default to None.
In practice, multi-processing might to slow down the process instead of speeding up. Suggest some adapted experiments.
Could be more practical with large amount of data.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>aggregation</code></b>
              (<code><span title="str">str</span></code>, default:
                  <code>&#39;mean&#39;</code>
)
          –
          <div class="doc-md-description">
            <p>'mean' or 'median' for aggregation method across ensembles.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>return_by_separate_ensembles</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Experimental function. return not by aggregation, but by separate ensembles.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>base_model_method</code></b>
              (<code><span title="typing.Union">Union</span>[None, <span title="str">str</span>]</code>, default:
                  <code>None</code>
)
          –
          <div class="doc-md-description">
            <p>The name of the prediction method for base models. If None, <code>predict</code> or <code>predict_proba</code> will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Defaults to None.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>temporal_window_prequery</code></b>
              (<code><span title="bool">bool</span></code>, default:
                  <code>False</code>
)
          –
          <div class="doc-md-description">
            <p>Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>base_model_prediction_param</code></b>
          –
          <div class="doc-md-description">
            <p>Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={'n_jobs':1}.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="TypeError">TypeError</span></code>
            –
          <div class="doc-md-description">
            <p>X_test is not of type pd.DataFrame.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
              <code><span title="ValueError">ValueError</span></code>
            –
          <div class="doc-md-description">
            <p>aggregation is not in ['mean','median'].</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>]]</code>
          –
          <div class="doc-md-description">
            <p>predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
              <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>]]</code>
          –
          <div class="doc-md-description">
            <p>If return_by_separate_ensembles == True:
Return numpy.ndarray of shape (n_samples, n_ensembles)</p>
          </div>
        </li>
    </ul>


            <details class="quote">
              <summary>Source code in <code>stemflow/model/AdaSTEM.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span>
<span class="normal"><a href="#__codelineno-0-1843">1843</a></span>
<span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1833" name="__codelineno-0-1833"></a><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a>    <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a>    <span class="n">verbosity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a>    <span class="n">return_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a>    <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a>    <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a>    <span class="n">return_by_separate_ensembles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a>    <span class="n">base_model_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a>    <span class="n">temporal_window_prequery</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1843" name="__codelineno-0-1843"></a>    <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1844" name="__codelineno-0-1844"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A rewrite of predict_proba</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a><span class="sd">        X_test (pd.DataFrame):</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a><span class="sd">            Testing variables.</span>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a><span class="sd">        verbosity (Union[None, int], optional):</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a><span class="sd">            0 to output nothing, everything other wise. Default None set it to the verbosity of AdaSTEM model class.</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a><span class="sd">        return_std (bool, optional):</span>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a><span class="sd">            Whether return the standard deviation among ensembles. Defaults to False.</span>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a><span class="sd">        n_jobs (Union[int, None], optional):</span>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a><span class="sd">            Number of processes used in this task. If None, use the self.n_jobs. Default to None.</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a><span class="sd">            In practice, multi-processing might to slow down the process instead of speeding up. Suggest some adapted experiments.</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a><span class="sd">            Could be more practical with large amount of data.</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a><span class="sd">        aggregation (str, optional):</span>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a><span class="sd">            &#39;mean&#39; or &#39;median&#39; for aggregation method across ensembles.</span>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a><span class="sd">        return_by_separate_ensembles (bool, optional):</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a><span class="sd">            Experimental function. return not by aggregation, but by separate ensembles.</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a><span class="sd">        base_model_method:</span>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a><span class="sd">            The name of the prediction method for base models. If None, `predict` or `predict_proba` will be used depending on the tasks. This argument is handy if you have a custom base model class that has a special prediction function. Defaults to None.</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a><span class="sd">        temporal_window_prequery: </span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a><span class="sd">            Whether to prequery the temporal windows as pd.DataFrame object to speed-up the stixel query. If set to True, query speed will be faster but with a moderate memory usage increase.</span>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a><span class="sd">        base_model_prediction_param:</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a><span class="sd">            Any other paramters to pass into the prediction method of the base models. e.g., base_model_prediction_param={&#39;n_jobs&#39;:1}.</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a><span class="sd">        TypeError:</span>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a><span class="sd">            X_test is not of type pd.DataFrame.</span>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a><span class="sd">        ValueError:</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a><span class="sd">            aggregation is not in [&#39;mean&#39;,&#39;median&#39;].</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a><span class="sd">        predicted results. (pred_mean, pred_std) if return_std==true, and pred_mean if return_std==False.</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a><span class="sd">        If return_by_separate_ensembles == True:</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a><span class="sd">            Return numpy.ndarray of shape (n_samples, n_ensembles)</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a>    <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a>        <span class="n">X_test</span><span class="p">,</span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a>        <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a>        <span class="n">return_std</span><span class="o">=</span><span class="n">return_std</span><span class="p">,</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a>        <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>        <span class="n">aggregation</span><span class="o">=</span><span class="n">aggregation</span><span class="p">,</span>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a>        <span class="n">return_by_separate_ensembles</span><span class="o">=</span><span class="n">return_by_separate_ensembles</span><span class="p">,</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>        <span class="n">base_model_method</span> <span class="o">=</span> <span class="n">base_model_method</span><span class="p">,</span>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>        <span class="n">temporal_window_prequery</span><span class="o">=</span><span class="n">temporal_window_prequery</span><span class="p">,</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>        <span class="o">**</span><span class="n">base_model_prediction_param</span>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a>    <span class="p">)</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a>    <span class="c1"># if return_by_separate_ensembles, this will be the dataframe for ensemble</span>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a>    <span class="c1"># if return_std, this wil be a tuple of mean and std of prediction</span>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a>    <span class="c1"># if none of these, then it ill output the mean prediction</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a>    <span class="k">return</span> <span class="n">prediction</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />







  
  



  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2025 <a href="https://github.com/chenyangkang"  target="_blank" rel="noopener">Yangkang Chen</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/chenyangkang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["toc.follow", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy", "search.share", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>